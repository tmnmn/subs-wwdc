# AVContentKeySession Best Practices

## Summary
AVContentKeySession allows for the management of FairPlay content decryption keys for HTTP Live Streaming. It offers a simplified key loading process that provides applications with control over the lifecycle of content keys, and features such as dual-expiry keys for offline movie rentals. Learn about best practices and recommended patterns for adopting this API.

## Info
* Media
* WWDC 2018 - Session 507 - iOS, tvOS
* https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/

## Text
 [（AVContentKeySession
最佳实践）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=17) [你好 感谢你的参与](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=18) [我是Anil Katti
Apple AVFoundation的工程师](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=20) [今天 我们来谈谈
AVContentKeySession API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=25) [有关应用它的一些最佳实践
及推荐模式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=28) [AVContentKeySession是一个
AVFoundation API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=34) [用于Apple平台上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=37) [传递FairPlay Streaming密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=40) [（议程）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=43) [下面是我们将要谈到的议题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=44) [首先概述FairPlay Streaming
和AVContentKeySession](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=46) [然后介绍一些用
AVContentKeySession](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=50) [优化回放的方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=54) [最后谈谈FairPlay Streaming
密钥传递的一些常见陷阱](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=57) [最后谈谈FairPlay Streaming
密钥传递的一些常见陷阱](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=57) [并随时回答一些来自开发人员的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=61) [常见问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=65) [我们开始吧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=67) [（FairPlay Streaming概述）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=69) [FairPlay Streaming
于2015年推出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=70) [来帮助保护传送到
我们平台的HLS流](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=73) [FairPlay Streaming
规范指定了一组步骤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=78) [app需要遵循这些步骤
以安全传送内容解密密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=82) [从而使平台可以对加密的
媒体解密和播放](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=86) [在传递FairPlay Streaming密钥时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=92) [你的app充当平台
与你的密钥服务器之间的联络人](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=95) [当它收到来自AVFoundation的
按需密钥加载请求时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=101) [它的响应是发出加密密钥请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=104) [也被称为SPC](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=109) [SPC然后被发送到密钥服务器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=112) [密钥服务器用加密密钥
响应回应这一请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=115) [也被称为CKC](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=120) [最后 该app将CKC
返回给AVFoundation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=122) [以便它可以开始解密和播放](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=126) [直到最近 app还在使用通用的
AVFoundation API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=131) [称为AVAssetResourceLoader](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=135) [来提供内容解密密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=137) [去年我们推出了
新的AVFoundation类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=140) [称为AVContentKeySession](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=144) [它是专门针对内容解密密钥设计的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=146) [AVContentKeySession
有两个目标](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=151) [一是简化密钥加载过程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=155) [并在内容解密密钥的生命周期内](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=158) [为app提供更好的控制](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=161) [二是为新的内容保护功能建一个平台](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=164) [AVContentKeySession
至今非常出色](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=171) [在我们的平台上传递的大部分
FairPlay Streaming密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=174) [是通过AVContentKeySession传递的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=177) [是通过AVContentKeySession传递的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=177) [这个API帮助开发人员
在他们的app中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=183) [优化了密钥传递](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=186) [我将介绍一些你可以从这个API中
获得更多收益的方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=188) [但首先让我们看看
AVContentKeySession的不同之处](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=192) [使用AVAssetResourceLoader
app只能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=197) [在AVFoundation
提请求时加载密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=202) [并发送按需加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=205) [这通常发生在AVFoundation
下载播放列表并解析后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=208) [发现内容是加密的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=213) [此外 AVFoundation
可以在回放过程中的任何时候](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=216) [发送这些密钥的加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=219) [例如 AVFoundation
发送新的密钥加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=221) [如果在回放过程中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=225) [切换到使用不同密钥的弧度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=228) [AVContentKeySession
本质上就会改变模式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=232) [它将密钥加载与媒体加载
或回放分离出来](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=236) [并使app对密钥加载时间
有更多控制](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=239) [并使app对密钥加载时间
有更多控制](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=239) [AVContentKeySession
允许app自主地](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=245) [在任何时候启动密钥加载](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=249) [这样就开辟了新的用途](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=252) [允许app优化密钥传递](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=254) [并改进回放体验的多个方面](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=257) [AVContentKeySession
可以帮助改进播放启动](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=262) [不像过去等待AVFoundation
按需发送密钥加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=268) [你可以用AVContentKeySession
在请求回放后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=273) [主动加载你基于用户操作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=278) [预测可能不久将需要的密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=282) [你甚至可以在用户选择
要播放的内容之前加载](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=286) [我们称其为密钥预载或预热](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=291) [此外 如果你的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=295) [跨越不同弧度使用多个密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=297) [跨越不同弧度使用多个密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=297) [你可以在与密钥服务器交涉之前
批量处理所有密钥请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=300) [这可以减少密钥服务器上的一些负载](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=306) [并且消除了每个密钥往返的延迟](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=308) [你可以通过
在AVContentKeySession实例上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=314) [调用processContentKeyRequest
来启动密钥加载过程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=318) [一旦你调用这个方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=322) [AVContentKeySession
会通过调用委托回调](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=324) [向你发一个
AVContentKeyRequest对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=328) [AVContentKeySession允许你
执行FairPlay Streaming特定操作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=331) [比如发加密的密钥请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=336) [和以加密的密钥响应](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=339) [现在我们假设
你已成功预装了一个特定的密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=344) [有没有可能在回放开始后
再次请求密钥？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=349) [这是可能的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=354) [app可能会收到按需加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=356) [app可能会收到按需加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=356) [例如 如果回放路线改变](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=360) [请注意 用户可以决定
将内容隔空播放到Apple TV](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=363) [或插入
Lightning to Digital AV适配器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=368) [在这些情况下
我们需要新的密钥来解密](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=372) [因此 app应始终准备好
回答按需加载的请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=378) [即使它已预先加载密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=384) [另一个有关这个主题的常见问题是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=388) [app如何预先加载播放期间
可能需要的所有密钥？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=392) [为了预加载密钥
你需要相应的密钥标识符](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=398) [也就是在HLS播放列表的
EXT-X-KEY标签指定的那个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=403) [我们建议你以带外方式获取所有](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=409) [你的内容
从服务器发出宣传的密钥标识符](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=412) [另一种办法是在创作内容时
把所有密钥标识符](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=418) [另一种办法是在创作内容时
把所有密钥标识符](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=418) [包括在主播放列表中作为会话密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=423) [并在AVAssetResourceLoader上使用
preloadsEligibleContentKeys属性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=426) [说到这里我想指出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=432) [我们有一个关于优化HLS性能的
专门的一场演讲](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=434) [不只是密钥交付](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=439) [你一定要看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=441) [预加载说完了 看下面](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=446) [AVContentKeySession
也可以帮助你扩展现场服务](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=448) [大家知道怎么做？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=453) [你可以使用AVContentKeySession来分散](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=455) [正在传输实时内容的客户的
密钥加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=459) [通常 直播流会定期轮换密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=464) [以为内容添加额外的保护层](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=468) [可以想像
在客户刷新实况播放列表时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=473) [这些密钥会同时出现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=477) [当发生这种情况时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=479) [当发生这种情况时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=479) [数百万用户同时请求密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=480) [导致密钥服务器上的巨大冲动负载](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=484) [当你在请求出现前并在播放列表中
出现EXT-X-KEY标签之前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=488) [在一个小时间窗口内](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=493) [分散密钥请求事件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=495) [基本上 你在对到达
你的密钥服务器的请求作负载平衡](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=498) [我们详细介绍了这个例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=504) [并在去年HLS演讲期间
提供了示例代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=506) [因此 查看
我们在developer.apple.com](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=510) [或WWDC app上录制的片段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=512) [除了允许你管理和传送
内容解密密钥之外](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=518) [另外AVContentKeySession也可以](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=523) [作为新的FairPlay Streaming
内容保护功能的平台](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=525) [去年我们发布了一个这样的新功能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=530) [我们称之为离线出租](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=533) [（什么是离线出租？）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=535) [离线租赁是一种
FairPlay Streaming功能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=537) [它允许你指定两个到期持续时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=539) [它允许你指定两个到期持续时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=539) [永久性密钥上的存储和回放时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=543) [存储时间指定密钥在你的存储器中时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=548) [在用于回放之前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=554) [你希望它有效的时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=556) [这个数字通常很大 比如30天](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=560) [而回放时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=564) [指定回放后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=567) [你希望密钥有效的时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=570) [它通常比存储时间短](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=572) [例如 24小时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=575) [此功能让你在创建持久性密钥时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=578) [指定此类到期持续时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=582) [平台确保遵守两次到期时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=585) [即使设备处于离线状态](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=589) [你可能想知道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=592) [如何以及在哪里
指定这两个到期持续时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=593) [FairPlay为此推出了
名为Offline Key TLLV的新TLLV](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=598) [FairPlay为此推出了
名为Offline Key TLLV的新TLLV](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=598) [这必须在请求持久性密钥时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=604) [使用过的CKC中发出信号](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=606) [就代码而言 通过在AVPersistableContent
KeyRequest对象上调用此方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=611) [你将生成一个持久性密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=615) [这将返回一个
持久性密钥数据blob](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=620) [你保存在你的app存储中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=623) [并用它来回答未来的密钥加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=625) [请注意
此密钥有效期至存储时间结束](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=630) [在我们的例子中是30天](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=634) [因此 当你使用
此密钥首次开始回放时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=637) [你可能会通过新的代理回调](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=642) [收到一个更新过的持久性密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=645) [当涉及委托回调时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=649) [你应该丢弃原始的持久密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=651) [把此更新后的持久性密钥
保存到你的app存储中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=654) [并用它来回答未来的密钥加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=658) [并用它来回答未来的密钥加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=658) [请注意
这个更新的持久性密钥的有效期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=664) [到播放持续时间结束
在我们的例子里是24小时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=667) [现在 让我们换个角度
来谈谈错误处理吧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=673) [从改善播放体验的角度来看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=679) [错误处理是最重要的主题之一](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=683) [成功加载密钥涉及许多步骤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=687) [不时的失败在所难免](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=691) [所以 当失败发生时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=695) [你该做的第一件事是
用AVContentKeyRequest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=696) [或AVAssetResourceLoadingRequest
将失败报告给AVFoundation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=700) [有些错误是致命的 有些则不是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=705) [你应该帮助平台做出决定](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=708) [你应该做的另一件事是
监视错误日志和访问日志](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=711) [调查根本原因 并尝试减轻错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=715) [让你的用户在我们的平台上
获得他们应得的最佳体验](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=718) [让你的用户在我们的平台上
获得他们应得的最佳体验](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=718) [我还建议你看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=724) [我们去年录制的一段资料](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=726) [以了解更多关于错误处理的
一般性的信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=729) [多年来 我们看到
FairPlay Streaming密钥传递上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=735) [开发者掉入了一些陷阱](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=738) [我们看到过
有的app保存密钥响应太久](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=741) [AVFoundation
向你发送密钥加载请求时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=745) [你应该尽快提供回复](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=748) [密钥传送延迟可能导致回放超时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=752) [顺便说一下 通过调查你的
playerItems访问日志](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=757) [你应该能够识别和调试超时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=761) [另一个陷阱围绕着HDCP执法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=766) [请务必记住你的内容的HDCP要求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=770) [是在你的密钥服务器的
加密密钥响应中发送](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=775) [如果你希望针对不同的弧度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=781) [执行不同的HDCP级别](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=784) [你应该用这些弧度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=785) [指定不同密钥标识符](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=788) [并从你的密钥服务器
提供适当的密钥响应](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=789) [最后 你在以持久性密钥
回应密钥加载请求时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=795) [应该小心](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=799) [因为持久性密钥与生成它的设备绑定](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=801) [例如](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=806) [你不应该使用持久性密钥
来响应来自隔空播放会话的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=807) [密钥加载请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=811) [这样做会导致回放失败](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=814) [我们在iOS 11.2中
进行了一些API更改](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=819) [帮助你尽早避免或解决这类问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=822) [让我通过一些代码片段来解释](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=827) [如果你正在使用
AVContentKeySession来传递密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=832) [现在你甚至无法做到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=834) [RequestPersistableContentKey
请求对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=837) [如果AVContentKeyRequest
无法接受持久性密钥作为响应](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=840) [因此 请求 PersistableContent
KeyRequest字段时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=847) [你的密钥服务器上的在线
FairPlayStreaming进行响应](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=850) [如果你使用AVAssetResourceLoader](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=856) [然后用持久性密钥数据blob
进行响应](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=859) [你应该检查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=862) [新引入的
allowedContentTypes属性中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=863) [持久性密钥是否被列
为接受的内容类型之一](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=867) [我希望我们提供了
AVContentKeySession的一些概述](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=871) [并澄清了几个你可能遇到的一些问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=875) [总结一下 我们介绍了
AVContentKeySession的不同之处](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=878) [我们看到了如何使用
此API来改善回放启动](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=882) [并扩展直播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=887) [我们谈了一点离线租赁](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=890) [它究竟是什么以及如何以正确地使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=892) [我们最后强调了错误处理的最佳实践](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=896) [我们最后强调了错误处理的最佳实践](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=896) [同时提供
FairPlay Streaming密钥](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=900) [以及你应该注意的常见陷阱](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=902) [谢谢你的收听](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=908) [也请访问developer.apple.com
以获取有关此演讲的更多信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=909) [和其他相关演讲](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=913) [谢谢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/507/?time=915)