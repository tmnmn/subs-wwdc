# iOS Memory Deep Dive

## Summary
Discover how memory graphs can be used to get a close up look at what is contributing to an app's memory footprint. Understand the true memory cost of an image. Learn some tips and tricks for reducing the memory footprint of an app.

## Info
* Developer Tools
* WWDC 2018 - Session 416 - iOS, tvOS, watchOS
* https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/

## Text
 [[ 音乐 ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=7) [[ 掌声 ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=23) [&gt;&gt; 大家好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=28) [我是 Kyle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=29) [我是一名 Apple 的软件工程师](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=29) [今天我们要将深入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=30) [研究一下 iOS 内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=32) [要知道的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=34) [尽管这里说的是 iOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=35) [我们接下来涉及到的很多内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=36) [也适用于其他平台](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=38) [我们首先要讨论的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=43) [是为什么要减少内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=44) [当我们提到减少内存时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=48) [我们实际上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=50) [是在讨论减少内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=51) [那么我们就来谈谈这点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=53) [我们将讨论一些](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=55) [可以用来分析内存占用的工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=56) [我们会有一些针对图像的提醒](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=59) [我们会有一些针对图像的提醒](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=59) [还会讲到后台优化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=60) [最后 我们会用一个很好的演示作为总结](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=63) [为什么减少内存呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=66) [简单的回答是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=70) [为了使用户获得更好的体验](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=72) [不仅你的 App 会启动得更快](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=73) [系统会表现得更好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=75) [你的 App 也会在内存中保留](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=76) [更长的时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=78) [其他 App 也会在内存中保留](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=78) [更长的时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=79) [几乎一切都变得更好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=80) [现在 如果你看看周围](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=82) [你实际上也在通过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=83) [减少内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=85) [来帮助其他开发者](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=86) [我们讨论的是减少内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=88) [但实际上减少的是内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=90) [内存和人不同 它们生而“不”平等](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=92) [这是什么意思呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=94) [我们需要谈谈 “Pages”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=96) [不是这个 “Pages 文稿”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=98) [我们将要讨论内存的页面](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=100) [系统给了你一个内存页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=102) [它可以堆的形式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=104) [存储多个对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=106) [有些对象实际上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=108) [可以跨越多个内存页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=110) [它们的大小一般是 16KB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=112) [可以是净页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=116) [也可以是脏页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=117) [App 的内存使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=120) [实际上指的是页面数量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=121) [乘以页面大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=123) [这有一个净页和脏页的例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=125) [假设我分配了一个含有 20000 个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=130) [整数的数组](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=133) [系统可能会分配给我 6 个内存页面](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=134) [当我分配这些页面时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=138) [它们是净页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=139) [但是 当我开始](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=141) [对数据缓冲区进行写入时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=142) [例如 如果我写入到这个数组的第一个位置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=143) [这个内存页就会变成脏页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=145) [类似地](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=148) [如果我写入到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=150) [缓冲区中的最后一个位置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=153) [最后一页也会变成 脏页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=154) [请注意 中间的四个页面](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=156) [仍然是 净页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=157) [因为 App 还没有写入它们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=158) [另一个有趣的话题是内存映射文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=162) [它是一种在磁盘上的文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=165) [但加载到了内存中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=168) [如果你用的是只读文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=170) [这些将一直是净页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=171) [内核实际上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=173) [是在它们离开磁盘写入 RAM 时进行管理的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=175) [JPEG 就是一个很好的例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=177) [JPEG 就是一个很好的例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=177) [如果我有一个 JPEG 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=181) [比如说 它有 50KB 大](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=183) [当它被映射到内存中时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=185) [它实际上被映射到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=187) [大约 4 页内存中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=189) [第 4 页实际上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=190) [并没有被完全填满](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=192) [所以它可以用来做其他的事情](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=193) [内存就是像这样复杂](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=194) [但是之前的那三页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=196) [总是可以被系统释放](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=198) [当我们讨论某个典型的 App 时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=202) [它们的内存占用和分析文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=206) [都会有一个脏的 一个压缩的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=208) [以及一个干净的内存段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=210) [让我分别来看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=212) [净内存是可以被分页的数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=214) [这些是我们刚刚讨论过的内存映射文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=218) [可以是图像文件 Blob.data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=221) [或者 Training.model](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=223) [也可以是框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=224) [每个框架都有一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=228) [_DATA_CONST 部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=230) [它通常是 净内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=232) [但是如果你做了任何运行时的小把戏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=233) [比如 “Method Swizzling（方法交换）”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=234) [那么它就会变成脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=235) [那么它就会变成脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=235) [脏内存是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=241) [App 写入的任何内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=243) [它们可以是对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=245) [比如 malloc](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=247) [字符串 数组等等](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=249) [它可以是已解码的图像缓冲](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=251) [我们稍后会讲到这点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=254) [它也可以是框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=255) [框架也有一个 _DATA 部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=259) [和一个 _DATA_DIRTY 部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=261) [它们总是指向脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=264) [你可能注意到了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=267) [我曾两次提到了框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=269) [是的 你链接的框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=270) [实际上使用内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=272) [和脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=274) [它是一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=275) [连接框架的必要部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=276) [但如果你要保持自己的框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=279) [可以使用单例](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=279) [和全局初始化器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=281) [来减少他们使用的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=283) [脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=285) [因为单例](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=286) [在被创建之后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=288) [才会进入内存 初始化器也只有](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=289) [在框架被链接或类被加载时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=291) [才会运行 压缩内存非常酷](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=297) [才会运行 压缩内存非常酷](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=297) [iOS 没有传统的磁盘交换系统](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=300) [取而代之 它使用内存压缩器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=303) [它是在 iOS 7 中被引入的内存压缩器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=306) [接收未访问的内存页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=310) [并压缩它们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=312) [这实际上可以创建更多的空间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=313) [但在访问时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=316) [压缩器会对它们进行解压](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=317) [以便读取内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=319) [让我们看一个例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=320) [假设我有一个用于缓存的字典](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=323) [它占用了 3 页的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=325) [但是如果我有一段时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=327) [没有访问过它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=329) [且系统需要一些空间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=331) [系统就可以把它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=332) [压缩到一个内存页中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=333) [它现在被压缩了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=335) [但同时我节省了空间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=338) [或者说我现在有了两个额外的内存页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=340) [如果在未来的某个时刻我想访问它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=342) [它将会恢复原来的大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=344) [我们来谈谈内存警告](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=346) [App 并不总是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=349) [引起内存警告的原因](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=351) [如果你在一个低内存的设备上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=353) [接到一个电话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=354) [那也可能会触发一个内存警告](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=357) [你就有麻烦了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=358) [所以不要想当然地认为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=359) [所以不要想当然地认为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=359) [内存警告是你造成的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=360) [压缩器使内存的释放](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=363) [变得复杂](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=366) [因为根据压缩的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=369) [实际上你可以 比以前使用更多的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=370) [因此我们建议修改策略](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=372) [比如暂时不缓存任何内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=375) [或者在发生内存警告时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=377) [限制一些后台工作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=378) [我们中的一些人可能在 App 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=382) [遇到这种情况](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=384) [我们得到一个内存警告](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=385) [并决定从缓存中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=387) [删除所有对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=388) [回到压缩字典的例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=391) [会发生什么呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=394) [既然我正在访问这个字典](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=395) [我现在比以前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=397) [使用了更多的内存页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=399) [在内存受限的环境中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=402) [我们并不希望这样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=403) [因为我删除了所有的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=406) [我做了很多工作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=407) [只是为了让它回到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=410) [之前被压缩时的样子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=411) [也就是只占用一个内存页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=412) [所以我们要注意记忆警告](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=414) [这就提出了一个关于缓存的重要问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=419) [这就提出了一个关于缓存的重要问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=419) [当我们缓存时 我们实际上是在试图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=423) [避免 CPU 重复工作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=425) [但是如果我们缓存太多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=427) [我们将耗尽所有的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=428) [这可能会给系统带来问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=430) [所以请记住 我们有](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=433) [内存压缩器和缓存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=435) [最好平衡一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=436) [缓存与重新计算的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=437) [另一个注意事项是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=441) [如果使用的不是字典](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=442) [而是 NSCache](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=443) [这将是存储缓存对象的安全方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=445) [由于 NSCache](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=448) [分配内存的方式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=450) [它实际上是可被释放的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=451) [所以在内存受限的环境中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=452) [它的效果更好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=453) [回到典型的 App 中的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=454) [这三个部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=458) [当我们讨论 App 的内存占用时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=460) [我们实际上是在讨论那些脏的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=461) [和压缩的部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=462) [净内存在这里并不重要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=464) [每个 App 都有一个内存占用限制](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=467) [这个限制对于一个 App 来说](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=473) [是相当高的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=474) [但是请记住 根据设备的不同](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=476) [这个限制也会改变](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=478) [因此 你不能像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=479) [因此 你不能像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=479) [在内存 4GB 设备上那样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=481) [在 1GB 的设备上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=482) [使用同样多的内存 还有扩展](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=483) [扩展的内存占用要小得多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=490) [所以在使用扩展时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=491) [你需要更加注意这一点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=493) [当你超过了内存占用限制](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=497) [就会出现异常](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=499) [这种异常就是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=502) [EXC_RESOURCE_EXCEPTION](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=504) [现在我想邀请](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=507) [James 来谈谈](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=510) [如何分析我们的内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=511) [[ 掌声 ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=514) [谢谢 James](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=517) [&gt;&gt; 谢谢你](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=518) [谢谢 Kyle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=520) [好的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=521) [我是 James](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=522) [我是一名 Apple 的软件工程师](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=522) [我想向你们介绍一些](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=524) [更高级的工具用于分析和研究](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=525) [App 的内存占用情况](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=527) [你可能已经熟悉了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=531) [Xcode 内存测量计](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=532) [它就在调试导航器中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=534) [它是帮助你快速查看 App 内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=537) [很好的一种方式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=539) [很好的一种方式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=539) [在 Xcode 10 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=540) [它现在可向你输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=543) [系统对你的评分值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=544) [所以如果看起来与 Xcode 9 不同](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=545) [不要太在意](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=546) [我正在 Xcode 中运行我的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=549) [我发现它消耗了更多的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=551) [那么下一步我应该用什么工具呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=553) [显然是 Instruments](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=555) [它提供了许多方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=558) [来调查 App 的内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=559) [你可能已经熟悉](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=561) [“Allocations” 和 “Leaks”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=564) [“Allocations”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=565) [分析由你的 App 所分配的堆](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=567) [“Leaks”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=568) [会检查一个进程中的内存泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=569) [但是你可能不太熟悉](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=571) [“VM Tracker”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=572) [和 “Virtual memory trace（虚拟内存追踪）”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=573) [如果你还记得](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=575) [Kyle 谈论过的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=577) [iOS 内存的主要类别](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=578) [他谈到了脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=579) [和压缩内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=581) [VM Tracker 提供了一种](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=582) [很好的分析方式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=584) [它为脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=587) [以及交换内存即 iOS 中的压缩内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=588) [分别提供了独立的追踪](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=590) [并告诉你](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=591) [关于常驻内存大小的信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=592) [我认为这对于](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=593) [研究 App 的脏内存大小 非常有用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=595) [Instruments 中的最后一项是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=598) [“Virtual memory trace（虚拟内存追踪）”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=599) [“Virtual memory trace（虚拟内存追踪）”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=599) [你可以凭借它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=601) [与你 App 相关的虚拟内存系统的性能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=603) [进行深入的了解](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=604) [我发现这里的 “By Operation” 标签页](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=608) [非常有用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=610) [它为你提供了一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=611) [虚拟内存系统文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=612) [并向你展示虚拟内存的内存页缓存命中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=614) [以及内存页零填充之类的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=616) [Kyle 前面提到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=621) [如果你接近设备的内存限制](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=622) [你将收到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=623) [EXC_RESOURCE_EXCEPTION 的异常](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=625) [如果你正在 Xcode 10 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=627) [运行你的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=628) [Xcode 将会捕获这个异常](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=631) [并暂停你的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=632) [这意味着你可以启动内存调试器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=633) [并从那里开始调查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=635) [我认为这真的十分有用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=637) [Xcode 的内存调试器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=639) [是在 Xcode 8 中提供的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=642) [它可以帮助你跟踪对象的依赖](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=643) [声明周期和泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=644) [在 Xcode 10 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=646) [内存调试器更新了布局](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=648) [它非常适合用来查看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=650) [非常大的内存图文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=652) [在内部](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=653) [Xcode 使用 Memgraph 文件格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=655) [存储有关 App 的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=657) [内存使用的信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=658) [你可能不知道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=660) [你可以搭配我们的多种命令行工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=661) [使用 Memgraph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=663) [首先 你需要从 Xcode 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=666) [导出 Memgraph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=667) [这很简单](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=668) [你只需点按 “File（文件）”菜单中的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=670) [“Export Memory Graph...（导出内存图）”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=672) [并将其保存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=674) [然后 你就可以将 Memgraph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=675) [传递给命令行工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=678) [而不是目标本身](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=679) [这样就可以了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=680) [我在 Xcode 10 中运行我的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=682) [然后收到一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=683) [内存资源异常](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=685) [这可不太好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=686) [我也许应该提取 Memgraph 来进一步研究](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=687) [但接下来我该怎么做呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=689) [显然 去终端](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=691) [我经常使用的第一个工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=693) [是 vmmap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=695) [通过输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=696) [分配给进程的虚拟内存区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=697) [它给你的 App 提供了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=698) [内存消耗的高级分析](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=700) [-summary 参数 是一个很好的起点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=703) [它可以打印出很多细节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=706) [比如该区域的内存大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=709) [脏区域的数量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=712) [以及交换内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=715) [也就是 iOS 中的压缩内存的数量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=716) [请记住这里的脏和交换区域大小 是非常重要的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=718) [请记住这里的脏和交换区域大小 是非常重要的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=718) [值得注意的一点是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=722) [交换区域大小指的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=723) [数据压缩前的大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=725) [而不是压缩后的大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=727) [如果你真的需要深入了解](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=730) [想要更多的信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=731) [你可以在 Memgraph 上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=733) [运行 vmmap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=734) [你会得到所有区域的具体信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=736) [我们首先向你们展示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=737) [“Non-writable regions（不可写入区域）”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=739) [比如程序的文本](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=740) [或可执行代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=742) [然后是 “Writable regions（可写入区域）”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=744) [比如数据部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=746) [这就是你的进程堆](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=747) [所在的位置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=749) [除了这些之外还有很酷的一点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=750) [就是所有这些工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=751) [都可以很好地使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=753) [标准命令行实用程序](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=754) [例如 前几天](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=756) [我在 VM Tracker 中分析我的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=758) [然后我看到了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=759) [脏内存增加的情况](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=761) [所以我导出了 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=763) [我想知道这些脏数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=765) [是否有一部分是由我链接的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=768) [框架或库造成的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=769) [于是我在这个 Memgraph 上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=772) [运行 vmmap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=774) [我使用了 -pages 参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=776) [这意味着 vmmap 将输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=778) [这意味着 vmmap 将输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=778) [内存页的数量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=780) [而不仅仅是原始字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=781) [然后我将它传输到 grep](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=782) [并在那搜索 ‘.dylib’](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=786) [所以我在这里需要动态库](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=788) [最后 我将它导入到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=791) [一个特别简单的 awk 脚本中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=792) [来合计脏列](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=794) [然后最终将其输出为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=795) [脏内存页的数量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=796) [我觉得这很酷](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=799) [而且我一直在使用它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=800) [它让你能够](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=802) [为你和你的团队编写](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=803) [非常强大的调试工作流](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=805) [另一个 macOS 开发人员](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=806) [可能已经熟悉的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=810) [命令行实用程序是 leaks](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=811) [它在运行时跟踪堆中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=813) [没有根的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=815) [所以请记住](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=817) [如果你在 leaks 中看到一个对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=818) [那它占用的是你无法释放的脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=819) [让我们看看 内存调试器中的内存泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=821) [这里我有 3 个对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=826) [它们相互之间都有很强的引用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=828) [创建了一个经典的 “Retain Cycle（留置环）”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=829) [让我们在 leaks 工具中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=831) [看看这个泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=834) [今年 leaks 已被更新](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=836) [不仅可以显示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=837) [泄漏的对象 还可显示它们所属的 Retain Cycle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=839) [泄漏的对象 还可显示它们所属的 Retain Cycle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=839) [如果进程中启用了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=845) [malloc 堆栈日志记录](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=847) [我们甚至为你提供了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=848) [根节点 回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=851) [我经常问自己的一个问题是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=854) [内存都去哪了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=855) [我查看了 vmmap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=858) [发现堆很大](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=859) [但是接下来要做什么呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=860) [heap 工具提供了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=862) [关于进程堆中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=864) [对象分配的各种信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=865) [它可以帮助你追踪](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=867) [非常复杂的分配](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=868) [或者很多同类的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=870) [我这里有一个 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=874) [它是我在 Xcode 捕获到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=876) [内存资源异常时得到的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=877) [我想研究它的堆](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=879) [所以我把它传递给了 heap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=880) [它告诉我](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=883) [每个对象的类名](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=885) [它们的数量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=889) [它们的平均大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=890) [以及这类对象的总大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=892) [在这里](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=894) [我看到了很多很多小对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=896) [但我不认为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=898) [这是什么问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=898) [我不认为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=899) [我不认为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=899) [这是主要的问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=901) [默认情况下 堆将按数量排序](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=905) [但是我希望看到的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=908) [是最大的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=909) [而不是数量最多的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=911) [因此将 -sortBySize 参数传递给堆](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=912) [能让它们按大小排序](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=914) [这里我看到了一些](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=916) [硕大的 NSConcreteData 对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=917) [我应该将这个输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=919) [和 Memgraph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=921) [附加到 Bug 报告中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=922) [但这还不够](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=924) [我得弄清楚](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=925) [这些对象是怎么来的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=925) [首先 我需要获得](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=927) [其中一个 NSConcreteData 对象的地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=929) [然后是 heap 工具中的 -addresses 参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=931) [当你将 -addresses 参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=933) [与一个类名一起传给 heap 工具时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=934) [它将为你提供堆上的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=935) [每个实例的地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=936) [现在我有了这些地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=939) [我可以知道它们每一个都来自哪里](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=941) [这就是 malloc 堆栈日志记录](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=943) [派上用场的地方](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=944) [当启用时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=946) [系统将记录每个分配的回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=947) [当我们记录一个 Memgraph 时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=950) [这些日志就会被捕获](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=952) [它们将用于为我们的一些工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=953) [注释现有的输出 你可以在](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=954) [“Scheme Editor（Scheme 编辑器）”中的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=957) [“Diagnostics（诊断）”标签页中 轻松启用它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=958) [“Diagnostics（诊断）”标签页中 轻松启用它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=958) [我建议你们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=961) [在 Memgraph 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=962) [使用实时分配选项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=963) [我的 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=966) [在 malloc 堆栈日志记录中被捕获](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=968) [现在我们要找到分配的回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=970) [这就是 malloc_history 发挥作用的地方](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=973) [你只需传递 malloc_history](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=975) [Memgraph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=977) [以及内存中实例的地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=978) [那么 如果捕获到它的回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=979) [malloc_history 就会将其提供给你](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=980) [这里我取了其中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=984) [一个很大的 NSConcreteData 的地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=985) [我把它传递给了 malloc_history](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=987) [然后我就得到了一个回溯记录](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=988) [有趣的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=991) [看起来我的 NoirFilter.apply() 方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=992) [创建了一个巨大的 NSConcreteData](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=994) [我应该将这个和 Memgraph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=997) [附加到一个 Bug 报告中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=998) [其他人就可以查看它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1000) [这些只是几种](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1003) [可以深入研究](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1004) [App 行为的方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1006) [当遇到内存问题时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1008) [你会选择哪个工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1009) [有 3 种思考方式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1012) [你想看到对象的创建吗](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1013) [你想要查看内存中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1015) [引用对象或地址的内容吗](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1016) [或者你只是想看看 一个实例有多大](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1019) [或者你只是想看看 一个实例有多大](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1019) [如果你在进程启动时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1022) [启用了 malloc 堆栈日志记录](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1023) [那么 malloc_history](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1025) [可以帮助你查找 该对象的回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1026) [如果你只是想看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1030) [在内存中引用对象的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1031) [你可以使用 leaks](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1033) [和在内存页面中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1035) [提供的其他工具来帮助你](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1036) [最后 如果你只是想了解](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1037) [一个区域或一个实例有多大 vmmap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1040) [和 heap 是首选工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1043) [作为起始点 我建议在进程的 Memgraph 上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1044) [运行带有 -summary 命令的 vmmap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1047) [然后顺着线程继续进行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1050) [现在 我想请回 Kyle 他将会讨论](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1054) [iOS App 中最大的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1056) [那就是图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1057) [有请 Kyle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1060) [[ 掌声 ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1062) [&gt;&gt; 谢谢 James](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1066) [说到图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1067) [关于图像需要记住的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1070) [最重要的就是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1071) [内存使用与图像的尺寸有关](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1074) [而不与它的文件大小有关](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1075) [举个例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1079) [举个例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1079) [我有一张非常漂亮的图片](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1081) [并且我想把它作为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1083) [一个 iPad App 的壁纸](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1084) [它的尺寸是 2048*1536](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1086) [磁盘上文件的大小是 590KB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1090) [但是它实际使用了多少内存呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1093) [10MB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1098) [10MB 这可够大的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1100) [这是因为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1102) [把像素的宽度乘以高](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1103) [即 2048 乘以 1536](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1105) [然后每像素乘以 4 字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1108) [就会达到 10MB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1110) [那么为什么它会大这么多呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1111) [我们要谈谈图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1115) [是如何在 iOS 上工作的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1116) [有加载 解码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1118) [和渲染三个阶段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1119) [在加载阶段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1121) [这个被压缩的 590KB 的 JPEG 文件被接收](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1123) [并被加载到内存中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1125) [在解码阶段 JPEG 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1129) [将被转换为 GPU 可以读取的格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1131) [图像需要被解压](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1135) [这使得文件大小增至 10 mb](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1136) [被解码之后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1139) [被解码之后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1139) [图像就可以被随意渲染了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1141) [要了解更多关于图像的信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1143) [以及如何对它们进行优化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1145) [我建议你们查看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1146) [本周早些时候举行的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1148) [“Images and Graphics](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1150) [Best Practices” 的讨论会](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1151) [在 SRGB 格式中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1154) [每个像素有 4 个字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1156) [这通常是图形中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1158) [图像最常见的格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1159) [它是每个像素 8 位](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1162) [所以红色 1 字节 绿色 1 字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1166) [蓝色 1 字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1168) [Alpha 通道 1 字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1170) [但是 我们还可以将其继续变大](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1173) [iOS 硬件可以渲染宽格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1176) [宽格式中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1179) [为了得到有表现力的颜色](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1180) [每个像素需要 2 个字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1182) [所以我们将图像的大小加倍](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1184) [iPhone 7 iPhone 8 iPhone X](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1186) [以及一些 iPad Pro 上的摄像头](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1189) [非常适合捕捉这种](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1191) [高保真的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1193) [你也可以用它来制作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1195) [非常精确的颜色](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1196) [比如运动商标等等](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1197) [但是这些只在](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1200) [宽格式显示器中有用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1201) [所以我们不希望](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1202) [在不需要的时候使用它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1203) [另一方面 我们也可以使图像变小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1205) [比如 AL8 格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1208) [这种格式只存储灰度值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1210) [和 Alpha 值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1213) [它通常用于着色器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1214) [比如 Metal App 等等](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1216) [这个格式并不常用 实际上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1219) [我们还可以让它继续变小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1221) [我们可以使用所谓的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1223) [Alpha 8 格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1224) [Alpha 8 只有 1 个通道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1226) [每个像素 1 个字节 非常小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1228) [它比 SRGB 小 75%](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1230) [这很适合蒙版](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1233) [或单色文本](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1234) [因为我们节省了 75% 的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1236) [如果我们分开来看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1239) [我们可以从 Alpha 8 格式的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1242) [每个像素 1 个字节开始](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1244) [一直增加到宽格式的每个像素 8 个字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1245) [这个范围很大](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1247) [所以我们真正需要做的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1248) [知道如何选择正确的格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1250) [那么我们如何选择正确的格式呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1252) [简短的回答是不要选择格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1255) [让格式来选择你](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1258) [如果你不再使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1261) [自 iOS 诞生起就存在于 iOS 的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1263) [UIGraphicsBeginImageContext](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1264) [WithOptions API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1267) [而是切换到 UIGraphicsImageRenderer 格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1269) [你可以节省很多内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1272) [因为 UIGraphicsBeginImage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1275) [ContextWithOptions 总是一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1277) [每像素 4 字节的格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1279) [它总是 SRGB 格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1281) [所以只要你不想 你就不会得到宽格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1283) [也不会得到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1285) [每像素 1 字节的 A8 格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1287) [如果你使用在 iOS 10 中引入的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1288) [UIGraphicsImageRenderer API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1291) [在 iOS 12 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1293) [它会自动为你选择最好的图形格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1295) [这有一个例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1296) [假设我画了一个圆作为一个蒙版](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1299) [使用旧 API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1301) [高亮的部分是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1303) [我的绘制代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1305) [只是为了绘制一个黑色圆圈](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1306) [我得到的却是每个像素 4 字节的格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1308) [如果我转而使用新的 API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1311) [我使用的是完全相同的绘制代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1312) [通过使用新的 API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1315) [我现在得到的是每个像素 1 字节的图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1317) [这意味着它减少了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1319) [这意味着它减少了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1319) [75% 的内存使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1321) [在保证相同保真度的同时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1322) [也获得了可观的内存节省](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1324) [另外一个好处是 如果我想再次使用这个蒙版](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1325) [我可以在一个 imageView 上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1331) [改变 tintColor](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1333) [而且只用一个点号就可以做到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1336) [这意味着我不必再分配内存了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1337) [我不仅可以把它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1341) [设成一个黑色的圆圈](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1343) [还可以设成蓝色的 红色的 绿色的圆圈](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1344) [且没有额外的内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1345) [这很酷](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1347) [我们通常对图像做的另一件事是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1352) [对它们进行下采样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1354) [当我们想要制作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1355) [比如缩略图的时候](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1356) [我们想要缩小它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1358) [我们不应该](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1359) [用 UIImage 进行缩小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1361) [如果我们使用 UIImage 绘图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1362) [由于内部坐标空间变换](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1364) [这种方法性能并不高](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1366) [就像我们之前看到的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1369) [它会解压缩内存中的整个图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1370) [取而代之 我们可以使用 ImageIO 框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1373) [ImageIO 可以对图像进行下采样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1376) [它使用 Streaming API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1378) [它使用 Streaming API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1378) [这样你只需为生成图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1380) [使用一些脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1383) [这将为你节省一个内存峰值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1384) [例如 这里有一些代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1386) [以及我在磁盘上获得的一个文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1389) [也可以是我下载的一个文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1390) [我现在用 UIImage 绘制一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1392) [更小的矩形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1396) [仍然会有一个大峰值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1398) [如果切换到 ImageIO](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1401) [我仍然需要从磁盘加载文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1402) [因为它是一个较低级的 API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1405) [我设置了一些参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1407) [来表示我希望这个图像有多大](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1409) [所以我让它用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1411) [CGImageSourceCreateThumbnailAtIndex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1413) [创建图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1414) [现在 我可以用 UIImage 封装这个 CGImage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1415) [并准备好进行下一步了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1417) [我有一个小得多的图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1419) [而且比之前的代码快 50%](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1420) [我们要讨论的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1425) [另一件事是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1427) [如何进行后台优化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1428) [假设我在一个 App 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1429) [有一个全屏的图像 它很美](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1433) [我很喜欢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1434) [但之后 我需要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1435) [到我的主屏幕上处理通知](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1437) [或者转到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1438) [或者转到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1438) [另一个 App 上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1440) [那张图像还在内存中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1441) [经验之谈](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1444) [我们建议你卸载](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1446) [看不到的大型资源](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1448) [有两种方法可供选择](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1450) [第一种是 App 生命周期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1453) [如果你把你的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1455) [放在后台或者前台](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1456) [App 生命周期事件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1457) [可以帮助你了解它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1459) [这主要适用于](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1461) [屏幕上的视图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1462) [因为它们不遵循](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1464) [UIViewController 外观的生命周期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1465) [UIViewController 方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1467) [适用于标签控制器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1468) [或导航控制器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1471) [因为你会有多个视图控制器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1472) [但只有一个出现在屏幕上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1474) [如果你利用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1476) [viewWillAppear 和](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1477) [viewDidDisappear 的代码或回调](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1478) [就可以使](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1480) [内存占用更小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1481) [举一个例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1484) [如果我为进入后台的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1486) [App 注册通知](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1488) [我可以卸载我的大型资源](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1489) [在这里就是图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1490) [当 App 回到前台时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1493) [我就会收到通知](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1494) [如果我在这里重新加载图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1497) [当用户返回时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1499) [当用户返回时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1499) [我就可以在后台保存内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1500) [并保持同样的保真度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1502) [这对他们来说是完全一样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1504) [但是系统有](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1505) [更多的内存可用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1507) [与此类似 如果我在导航控制器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1510) [或标签控制器中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1512) [我的视图控制器可以](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1514) [在图像消失时卸载它们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1515) [在返回 viewWillAppear() 方法之前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1517) [我可以重新加载它们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1518) [用户还是不会注意到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1522) [有什么不同](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1523) [我们的 App 如今使用更少的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1524) [这很好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1525) [现在 我想邀请 Kris](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1527) [用一个很好的演示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1531) [向你们展示之前的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1532) [Kris](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1534) [[ 掌声 ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1535) [&gt;&gt; 好的 我现在要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1540) [切换到演示机器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1541) [我们开始吧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1543) [我一直在开发这个 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1544) [这些是我从](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1545) [NASA 那里得到的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1547) [太阳系的高分辨率图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1550) [这个 App 可以让你](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1552) [对它们应用不同的滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1554) [接下来我们会看到一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1556) [简单的例子 在太阳上应用一个滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1557) [简单的例子 在太阳上应用一个滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1557) [我对目前的进展非常满意](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1560) [所以我把它发给 James](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1562) [征求他的意见](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1564) [他给我回了一封](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1565) [带有两个附件的邮件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1568) [一个附件是 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1569) [另一个是这个图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1572) [James 是一个相当保守和低调的人](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1575) [所以当他发送了两个红色的惊叹号](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1579) [和一个尖叫的表情符号时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1581) [我知道他很难过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1583) [所以我去找 James](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1585) [我说 “你知道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1587) [我不明白这有什么大不了的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1588) [很明显我需要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1589) [再使用至少 0.5 GB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1591) [才能出现内存不足的情况](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1593) [然而我还有一些可用的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1594) [我难道不能用它吗”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1595) [James 一个比我](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1597) [优秀得多的开发者](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1599) [他指出了一些](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1601) [我的逻辑有问题的地方](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1602) [首先 这个测量计](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1604) [测量的是一个有 2GB 内存的设备](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1607) [并不是所有的设备](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1610) [都有那么多的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1611) [如果这段代码运行在](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1612) [只有 1GB 内存的设备上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1614) [那么很有可能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1615) [我们的 App 已经被操作系统终止了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1617) [我们的 App 已经被操作系统终止了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1617) [其次 操作系统](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1620) [在决定何时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1624) [终止 App 时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1626) [不仅依照你的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1628) [使用的内存大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1629) [还依照操作系统中的其他内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1631) [所以仅仅因为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1633) [我们还没有耗尽内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1635) [并不意味着我们没有被终止的危险](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1636) [最后 这对用户来说](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1640) [是一种糟糕的体验](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1642) [事实上 如果你查看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1644) [使用比较图表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1645) [你可以看到其他进程的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1647) [内存为 0KB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1649) [那是因为它们都被](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1651) [操作系统抛弃了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1652) [只是为我们的 App 腾出空间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1653) [你们可能都在静静地看着我](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1656) [然后摆出一个嫌弃的表情](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1658) [因为当用户想去](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1660) [看你们的 App 时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1661) [它必须从头开始加载](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1663) [James 说得很有道理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1665) [我认为 总的来说](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1667) [我们应该让这个内存指针](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1668) [尽可能向左](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1669) [而不是向右](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1671) [看看我们能做什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1674) [让我先来看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1676) [Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1677) [我有一些](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1679) [我有一些](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1679) [在使用 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1684) [的日常技巧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1686) [或者说是策略](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1688) [第一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1689) [我需要把它向上拖动一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1690) [就是寻找泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1693) [如果我前往过滤器工具栏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1695) [轻点泄漏过滤器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1698) [它就会显示 Memgraph 文件中的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1699) [每一个泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1702) [这个 Memgraph 文件没有泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1704) [这既是好消息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1707) [又是坏消息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1709) [好处在于 没有泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1711) [但现在我得弄清楚](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1712) [到底发生了什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1713) [Memgraph 的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1715) [另一个好处是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1717) [告诉我一个对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1720) [在内存中有多少个实例](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1721) [以及是否比我预期的要多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1723) [当我查看这个 Memgraph 文件时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1724) [如果我特意关注](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1726) [代码中的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1727) [就可以看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1729) [内存中只有 5 个对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1732) [且每种都只有 1 个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1733) [如果内存中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1736) [有多个 RootViewController](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1737) [多个 NoirFilter](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1739) [多个 NoirFilter](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1739) [多个滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1741) [或其他预料之外的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1743) [那些就是我可以调查的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1744) [这里的实例数量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1746) [在我的预料内](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1749) [但也许其中存在一个很大的实例](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1750) [尽管不太可能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1752) [我还是得检查一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1753) [所以我需要使用内存检查器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1754) [我要看看这些](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1757) [它们中的每一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1758) [都列出了每个对象的大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1759) [我可以看到我的 AppDelegate 是 32 字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1761) [DataViewController 是 1500 字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1763) [当我浏览每一个的时候](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1766) [没有一个明显地占用了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1768) [我的 App 正在使用的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1770) [1GB 多的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1773) [这就是我在 Xcode 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1777) [处理 Memgraph 的技巧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1778) [我接下来要做什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1781) [我刚刚看了这个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1783) [关于在 Memgraph 文件中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1785) [使用命令行工具的 WWDC 讨论会](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1788) [让我来试试](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1791) [能不能找到什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1793) [回想起来](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1795) [James 提出的第一件事](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1797) [就是使用 vmmap 的 -summary 参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1799) [就是使用 vmmap 的 -summary 参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1799) [所以我来试试](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1802) [传入 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1804) [我们来看看这个输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1806) [现在 我应该在这里](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1811) [寻找什么呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1813) [总的来说](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1814) [我在寻找非常大的数字](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1815) [我想弄清楚](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1816) [是什么在使用这些内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1817) [大的数字意味着更多的内存使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1819) [这里有很多列](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1821) [有些列比其他列更重要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1825) [首先 “VIRTUAL SIZE（虚拟内存大小）”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1827) [虚拟意味着不是实际的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1830) [我几乎可以忽略这一列](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1832) [它是 App 所需的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1834) [但不一定要使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1836) [脏内存听起来像是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1838) [我绝对不希望在 App 里存在的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1840) [我希望我的 App 是干净的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1842) [而不是脏的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1844) [所以我想要这个数字尽量小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1845) [然后交换内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1847) [因为我们谈的是 iOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1848) [所以指的是压缩内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1849) [正如 Kyle 和 James 之前提到的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1852) [操作系统凭借](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1855) [脏内存大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1857) [加上压缩内存大小的总和](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1859) [加上压缩内存大小的总和](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1859) [来确定我的 App 实际](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1860) [实际使用了多少内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1862) [所以这就是我想要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1864) [关注的两列](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1865) [我们再来看一些较大的数字](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1866) [我马上就看到了 “CG image” 非常显眼](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1868) [它占用了非常多的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1871) [脏内存和交换内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1873) [这是一个危险信号](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1875) [让我们继续观察](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1876) [我可以看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1878) [“IOSurface” 占用了很多的 脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1881) [但不占用交换内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1883) [“MALLOC_LARGE” 占用了很多脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1885) [但占用较少的交换内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1890) [之后就没有](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1891) [这么大的数字了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1893) [基于我在这里看到的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1895) [我认为我应该集中处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1897) [CG image 的虚拟内存区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1899) [让我们把它复制下来](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1903) [下一步该是什么呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1905) [我们想要了解更多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1908) [关于虚拟内存的信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1910) [所以 vmmap 似乎还是我们要用的工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1912) [这次我将不再](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1914) [使用 -summary 参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1915) [而是传递我的 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1917) [而是传递我的 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1917) [但我只关心](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1921) [“CG image” 的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1922) [并不关心 vmmap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1924) [会告诉我的其他](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1925) [虚拟内存区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1929) [所以我应该使用 “grep”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1930) [只向我展示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1932) [关于 “CG image” 的行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1935) [让我们看看会发生什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1938) [现在 我有三行信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1940) [我可以看到 有两个虚拟内存区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1941) [在那里我可以看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1945) [它们的起始地址和终止地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1946) [然后我可以看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1948) [和之前相同的列](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1950) [分别是虚拟内存 常驻内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1951) [脏内存和压缩内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1954) [这里显示的最后一行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1956) [是总结行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1957) [也就是和上面一样的数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1960) [看看这两个区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1964) [我有一个很小的区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1965) [和一个很大的区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1967) [我显然更想了解](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1969) [这个大一点的区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1970) [那么我怎样才能找到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1973) [更多关于这个虚拟内存区域的信息呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1975) [我查看了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1978) [我查看了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1978) [vmmap 的文档](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1980) [然后注意到一个 -verbose 参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1982) [顾名思义](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1983) [它会输出更多的信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1985) [我想知道它能告诉我什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1988) [让我们继续](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1991) [传入 -verbose 和 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1992) [同样 我只关心 “CG image” 区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=1997) [所以我用 “grep”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2002) [来进行过滤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2004) [现在我看到了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2006) [更多的区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2008) [为什么会这样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2010) [默认情况下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2011) [如果 vmmap 找到连续的区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2013) [它会把它们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2015) [合并在一起](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2017) [实际上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2018) [如果你从第二行开始看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2019) [这个区域的终止地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2021) [和这个区域的起始地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2023) [是一样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2024) [下面也一样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2026) [因此 vmmap 在默认情况下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2028) [将其折叠成一个区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2031) [但是看看这里的细节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2032) [却能发现一些](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2034) [不同之处](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2034) [特别是其中一些区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2035) [使用了更多的 脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2037) [使用了更多的 脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2037) [而另一些使用了更多的压缩内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2040) [这就会帮助我找到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2042) [应该关注的地方](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2044) [但这里我要用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2046) [另一种策略](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2047) [我知道 操作系统中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2049) [虽然不一定 但一般来说](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2050) [虚拟内存区域创建得越晚](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2054) [在 App 生命周期中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2057) [它发生得就越晚](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2059) [由于这个 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2062) [是在内存使用峰值时获取的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2063) [所以很有可能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2065) [这些后面的区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2067) [与导致峰值的原因更有关联](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2069) [所以我不想寻找](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2072) [最大的 脏内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2073) [和压缩内存数字](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2075) [而是要从底部这里开始](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2076) [我要获取最后一个区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2078) [的起始地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2080) [我该怎么做呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2083) [James 提到的一个工具是 heap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2085) [但它作用于堆上的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2087) [而我正在处理一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2090) [虚拟内存区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2091) [所以它并不适用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2093) [还有 leaks 工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2096) [但是我这里并没有泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2098) [我已经从 Memgraph 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2099) [我已经从 Memgraph 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2099) [知道了这里没有泄漏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2100) [所以它看起来不像是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2102) [我可以使用的工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2103) [但是我查看了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2104) [关于 leaks 的帮助信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2106) [发现 leaks 可以做很多事情](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2109) [包括告诉我](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2111) [哪些对堆上的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2114) [或虚拟内存区域有引用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2116) [我们来看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2119) [它会告诉我们什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2120) [我将使用 leaks](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2121) [然后传递](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2123) [-traceTree 参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2125) [它的作用是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2127) [给了我一个树形视图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2129) [可以涵盖所有](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2132) [与我要传入的地址有关的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2133) [在这个例子中 我传入的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2134) [虚拟内存区域的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2136) [起始地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2139) [最后我们提供](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2142) [这个 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2144) [它会是什么样子呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2145) [这里我们能看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2147) [所有引用的树](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2149) [如果我们向上滚动到顶部](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2150) [在这里 我可以看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2153) [这是我的虚拟内存区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2155) [这是我的 “CG image” 区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2156) [然后我可以看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2158) [这个树视图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2159) [这个树视图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2159) [包含了所有具有引用的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2162) [以及引用它们的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2163) [以及引用这些东西的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2164) [等等等等](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2166) [如果我们回到 Xcode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2166) [我们实际上过滤了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2168) [相同的地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2171) [我来看看这个对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2174) [这个树视图和我从 leaks 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2176) [看到的一样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2178) [如果我想的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2179) [我可以沿着树走下去](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2180) [并展开每一个节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2182) [看看每个节点的细节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2183) [但是这需要一段时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2185) [而且有点乏味](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2186) [leaks 的输出的优点是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2188) [我不仅可以](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2189) [快速浏览它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2192) [还可以随意搜索或筛选](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2193) [或者我可以把它放进](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2196) [一个 Bug 报告或电子邮件中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2197) [然而我却不能对 Xcode 中的图形视图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2199) [进行上述的操作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2200) [那么在这个 leaks 的输出中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2203) [我要找什么呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2204) [理想情况下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2206) [我会找到一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2208) [我负责的类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2209) [一个来自我的 App 的类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2211) [我之前看过这个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2212) [我知道这里](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2214) [没有我的类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2215) [那么我还能找到什么呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2216) [我正在创建的类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2218) [我正在创建的类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2218) [比如一个框架类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2220) [它也许是以我的名义创建的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2221) [也可能是我](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2222) [直接创建的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2224) [我知道我的 App 有 UIViews](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2225) [它有 UIImages](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2228) [我可以用这些 Core Image 类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2229) [来进行过滤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2232) [我们继续看这里](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2233) [我用的是一个非常复杂的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2235) [叫做 “My Eyeballs” 的调试工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2238) [我们继续寻找](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2241) [我看看能不能找到我想要的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2243) [这是一个很大的终端输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2249) [所以让人更加困惑](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2252) [举个例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2255) [这里有一个字体引用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2256) [我知道我的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2258) [使用字体](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2259) [但是字体并不会导致](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2262) [很多的内存使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2264) [所以它没有帮助](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2266) [我们再往下看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2267) [我可以看到有很多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2269) [这样的 CI 类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2271) [它们是 Core Image 滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2274) [或者是 Core Image](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2276) [在我的 App 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2277) [起滤镜作用的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2278) [起滤镜作用的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2278) [它也许也是我该](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2280) [进一步研究的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2282) [我已经做了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2284) [但没有发现任何有用的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2285) [我无法进一步研究](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2289) [leaks 的输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2291) [这很不幸](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2293) [接下来我该做什么呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2295) [幸运的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2298) [James 在捕获](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2303) [这个 Memgraph 时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2305) [打开了配置内存的回溯记录](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2306) [这意味着我可以使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2309) [他谈到的另一个工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2311) [来查看对象的创建回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2313) [我将使用 malloc_history](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2316) [这一次 我先传入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2320) [Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2322) [然后再传入这个从帮助文档中获知的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2324) [-fullStacks 参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2328) [它的功能就是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2331) [使每一帧都在它自己的行上显示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2332) [这样让人更容易阅读](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2335) [然后我将传递](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2337) [虚拟内存区域的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2338) [虚拟内存区域的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2338) [起始内存地址](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2340) [让我们看看是什么样子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2341) [实际上这并不是一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2344) [很大的回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2345) [我可以看到我的代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2346) [出现在这里的几行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2349) [第 6 行到第 9 行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2350) [实际上来自我的 App 代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2352) [我可以在第 6 行看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2354) [NoirFilter.apply() 函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2356) [负责创建](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2359) [这个特定的虚拟内存区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2361) [这是一个很好的证据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2364) [展示了我如何在 App 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2367) [找到造成这些内存使用的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2368) [如果我们回到 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2371) [就可以发现这和 Xcode 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2374) [出现的回溯是一样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2376) [你可以看到这里](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2379) [也是 NoirFilter.apply() 方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2380) [我们没有像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2382) [通常在回溯视图中看到的那样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2384) [得到很好的高亮显示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2385) [因为我们没有调试一个活动进程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2387) [我们正在加载一个 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2388) [但是你可以看到它的输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2390) [和我们从 malloc_history 中得到的输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2391) [是完全一样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2392) [事实上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2393) [为了进一步确认](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2397) [我需要查看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2399) [我需要查看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2399) [“CG image” 虚拟内存区域的完整列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2402) [接下来我选取了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2405) [倒数第二个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2409) [我们来看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2410) [这个区域的回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2411) [结果是相同的回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2415) [同样的代码路径](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2417) [也指向这个区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2418) [如果继续观察](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2420) [其中的几个区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2423) [实际上仍使用了相同的回溯](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2424) [这样我就明白了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2426) [在我的 App 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2427) [是什么创建了这些](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2430) [占用了 App 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2432) [大量内存的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2433) [虚拟内存区域](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2434) [那么我们能做些什么呢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2436) [让我们回到 Xcode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2438) [我现在可以关闭 Memgraph 文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2440) [我要做的第一件事是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2443) [看看这里的代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2446) [如果看看与我的滤镜相关的代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2448) [我可以看到这里是 apply() 函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2452) [我可以马上看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2454) [一些东西跳出来](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2455) [它们是我正在使用的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2457) [UIGraphicsBeginImageContextWithOptions](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2458) [UIGraphicsBeginImageContextWithOptions](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2458) [以及 UIGraphicsEndImageContext](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2462) [我记得 Kyle 说过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2464) [你们不应该使用它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2466) [在那些情况下有更好的 API 可以使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2466) [这是我肯定想要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2469) [再次讨论的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2470) [但我首先需要的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2472) [是某种基线](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2473) [我需要知道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2474) [我的 App 使用了多少内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2475) [这样我就可以确保我的更改](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2477) [能让结果变得不同](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2478) [我要运行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2480) [我的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2481) [然后找到调试导航器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2484) [查看内存报告](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2486) [现在 我可以看到我的 App](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2488) [在运行时使用的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2490) [我真的很喜欢这个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2493) [土星北极的图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2495) [它是一个奇怪的六边形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2497) [炫酷的同时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2499) [又有点古怪](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2501) [我们来看看这个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2502) [应用这个滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2504) [然后看看会得到什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2505) [1GB 3GB 4GB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2507) [6GB 7GB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2511) [这可不太好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2513) [不过可以](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2514) [很好地告诉我们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2518) [它根本不会在设备上流畅运行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2519) [它根本不会在设备上流畅运行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2519) [所以当你在模拟器中运行时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2522) [你必须记住](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2523) [它对于调试和](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2524) [测试变更很有用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2526) [但是你也需要在设备上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2527) [验证所有的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2528) [但同时 另一件好事是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2529) [模拟器永远不会耗尽内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2531) [如果我遇到了 App 在设备上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2534) [被关闭的情况](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2535) [可以在模拟器中试试](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2536) [我可以等待一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2539) [非常大的分配](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2540) [而不会被关闭](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2541) [然后从那里进行调查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2543) [我想指出的一点是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2545) [我们其实给你们看了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2546) [这里标志的内存峰值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2548) [在这个例子中 我最多使用了 7.7GB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2551) [这很糟糕](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2555) [我们来看看能做些什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2556) [回到我的 apply() 函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2559) [现在](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2564) [我想使用这个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2566) [beginImageContextWithOptions](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2567) [但是回想一下 Kyle 说过的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2568) [当你处理图像时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2570) [内存使用中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2572) [最重要的是什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2574) [是图像的尺寸](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2576) [让我们看看它是什么样子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2578) [让我们看看它是什么样子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2578) [我要再次](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2580) [使用这个滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2583) [我在调试器中停止时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2584) [就可以看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2587) [这个图像的尺寸](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2591) [在我按回车](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2594) [我要先喝一小口水](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2595) [我其实并不想喝水](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2599) [它是 15000*13000](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2604) [我检查过文档](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2607) [在 UIImage 上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2609) [那是点（pt） 不是像素（px）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2612) [如果这是 2X 设备](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2613) [或 3X 设备](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2616) [你必须把它乘以一个很大的数字](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2618) [Kyle 会很生气](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2621) [因为一张图片就占用了 10MB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2623) [没人告诉他这件事](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2625) [为了证实这一点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2627) [我想尝试一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2629) [我要将 15000 乘以 13000](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2631) [iPhone X 是一个 3X 设备](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2636) [iPhone X 是一个 3X 设备](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2636) [所以是 3 倍的宽度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2640) [乘以 3 倍的高度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2642) [再乘以 4 字节每像素](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2646) [这个数字看起来很熟悉](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2650) [所以我很确定](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2655) [我清楚地知道到底是什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2657) [使用了 7.5GB 的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2659) [并不一定是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2660) [我的 beginImageContext](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2664) [而是图像的尺寸](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2665) [没有理由需要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2667) [这么大的图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2669) [我要做的是把它缩小成](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2670) [和我的视图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2672) [相同的尺寸](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2673) [这样 它就会占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2674) [更少的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2676) [那么 我要回到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2677) [上面的图像加载代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2678) [实际上 在我这么做之前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2680) [我想先禁用这个断点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2681) [让我们看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2682) [它是做什么的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2685) [很简单](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2686) [它从一个 Bundle 中获取 URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2687) [它从那个 URL 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2689) [加载一些数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2691) [并将其加载到 UIImage 中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2692) [然后传递给滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2695) [我想做的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2697) [在我把它发送到滤镜之前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2698) [在我把它发送到滤镜之前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2698) [我想缩小这个图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2700) [然而 我还记得 Kyle 说的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2702) [我不应该在 UIImage 上进行缩放](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2704) [因为它仍然会](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2705) [把整个图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2707) [加载到内存中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2708) [这是我要避免的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2710) [把这个函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2711) [折叠起来](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2713) [我要用 Kyle 建议的代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2716) [来替换它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2717) [好的 我们来看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2720) [这段代码在做什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2723) [这里是一样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2725) [我们从 Bundle 中获取图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2728) [但是这一次](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2731) [我得稍微调宽一点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2733) [我调用了 CGImageSourceCreateWithURL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2735) [来获取对图像的引用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2738) [然后将其传递给](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2739) [CGImageSourceCreateThumbnailAtIndex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2741) [现在 我可以将图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2744) [缩放到我想要的大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2745) [而不需要将整个内容载入内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2747) [让我们试一试](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2749) [看看会不会有什么不同](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2751) [我将重新构建](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2752) [然后等待它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2753) [在 App 上启动](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2756) [重新生成中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2759) [重新生成中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2759) [哦 有一个警告](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2762) [我需要再调整一下这个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2766) [再来看一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2770) [好了 正在构建](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2772) [构建 构建 构建](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2775) [好的 正在启动 没有问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2777) [现在 让我们来看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2779) [内存报告](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2780) [让我们回到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2782) [我一直很喜欢的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2785) [土星北极的图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2787) [我们应用这个图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2789) [看看会占用多少内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2792) [现在是 75](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2793) [93MB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2795) [在这里 我们的内存峰值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2796) [是 93MB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2798) [明显地改善](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2801) [[ 掌声 ] 这要比](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2804) [几乎百分百被关闭的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2806) [7.5GB 的内存占用要好得多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2808) [但现在 我记得有件事](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2811) [我想回去](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2813) [先停止运行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2815) [我还是想回到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2818) [我的 filter() 方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2819) [我的 filter() 方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2819) [改变这个 UIBeginImageContext 代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2823) [然后按照 Kyle 的建议去做](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2825) [所以我要删除这段代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2826) [然后添加新的滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2828) [在这里](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2834) [我要创建一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2836) [UIGraphicsImageRenderer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2838) [我要在这个渲染器中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2839) [使用 CIFilter](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2841) [来应用这个滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2844) [让我们运行这段代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2846) [希望它可以成功构建](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2849) [然后看看是否会对我的内存使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2850) [产生影响](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2852) [让我们回到调试导航器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2855) [和内存报告中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2857) [再一次](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2860) [我们回到土星图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2862) [然后应用我们的滤镜](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2866) [让我们来看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2871) [这次的内存峰值是多少](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2871) [98MB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2874) [这和上次基本是一样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2876) [但是如果你仔细思考](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2879) [但是如果你仔细思考](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2879) [这个其实就是我所期望的结果](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2880) [在这种情况下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2882) [我的图像仍然是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2883) [每个像素 4 个字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2885) [所以我不会使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2887) [这个新方法来节省内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2888) [然而 如果有一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2890) [节省内存的机会](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2892) [例如 如果操作系统可以判断](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2894) [图像可以每像素使用更少](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2897) [或更多的字节](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2900) [那么系统就可以做出正确的处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2901) [我就不需要担心了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2903) [因此 在代码经过这些更改后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2904) [即使我没有看到很大的改进](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2905) [我也知道它变得更好了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2908) [我还可以做更多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2910) [我想确保当 App 进入后台时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2913) [我们会卸载图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2915) [而且我们不会在屏幕之外的视图中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2917) [显示任何图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2919) [我还有很多可以做的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2921) [但是我对这些结果](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2922) [已经很满意了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2924) [所以我想把它们送回给 James](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2925) [我要抓取一个屏幕快照](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2927) [并给 James 添加一点备注](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2928) [让他知道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2930) [我对这一切是多么的满意](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2933) [我想我们可以](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2936) [给他发一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2937) [星星眼的表情符号](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2941) [希望 James 会对这些结果](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2944) [感到满意](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2946) [现在 我想请回 Kyle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2947) [他会帮我们整理一遍](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2951) [谢谢大家](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2953) [[ 掌声 ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2954) [&gt;&gt; 谢谢 Kris](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2956) [谢谢 Kris](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2960) [太棒了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2961) [只做了一点点工作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2962) [我们就能大大减少内存的使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2964) [总结起来 内存是有限的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2970) [也是共享的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2974) [我们使用得越多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2976) [系统就为其他 App 分配越少的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2977) [我们真的需要做一个好市民](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2979) [并注意我们对内存的使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2980) [只使用我们需要的内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2981) [在调试时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2986) [Xcode 中的内存报告是至关重要的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2987) [当我们的 App 运行时我们就可以打开它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2990) [因为当我们监视它的时候](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2991) [随着调试的进行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2992) [我们能注意到内存使用的消退](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2994) [我们要确保 iOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2999) [我们要确保 iOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=2999) [可以为我们选择图像格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3001) [通过使用新的 UIImage 的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3003) [GraphicsRenderer API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3006) [我们可以从 SRGB 到 alpha 8 的转变过程中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3008) [节省 75% 的内存使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3010) [这对蒙版和文本来说都很重要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3011) [除此之外 我们可以使用 ImageIO](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3016) [来对图像进行下采样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3018) [它可以防止过高的内存峰值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3021) [相较于将 UIImage 绘制到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3022) [更小的环境中时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3024) [它也会更快](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3025) [最后 我们要卸载](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3027) [不在屏幕上的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3030) [大型图像和资源](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3032) [使用这些内存是没有意义的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3033) [因为用户看不到它们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3034) [即使经历了所有这些努力](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3038) [我们仍然没有完成](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3040) [正如我们刚才看到的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3042) [使用 Memgraph 可以帮助我们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3044) [进一步了解发生了什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3046) [并减少内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3047) [结合 malloc_history](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3048) [我们可以深入了解](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3049) [内存的去向以及用途](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3050) [所以我建议](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3054) [大家能在讨论会后打开 malloc_history](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3056) [分析你的工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3058) [分析你的工具](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3058) [然后开始深入研究](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3060) [要了解更多的信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3063) [你们可以查看我们的幻灯片](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3064) [除此之外 如果你们还有其他问题的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3067) [我们稍后会去技术实验室](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3071) [谢谢大家 希望你们享受](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3075) [WWDC 中的其他讨论会](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3075) [[ 掌声 ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/416/?time=3078)