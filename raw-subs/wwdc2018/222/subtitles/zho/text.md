# Data You Can Trust

## Summary
A lot can go wrong when loading data into your app. Whether you work directly with JSON and property lists, or with higher-level APIs such as NSCoding and Codable, learn how to defend your customers and secure your code against invalid or malicious data. Avoid fatal assumptions by validating payload structure, type information and domain correctness, to turn the data you work with into data you can trust.

## Info
* Developer Tools
* WWDC 2018 - Session 222 - iOS, macOS
* https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/

## Text
 [（你可以信任的数据
更安全的COCOA归档和序列化）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=16) [大家早上好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=28) [感谢你们在喝咖啡前
就参加了我的演讲](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=30) [我叫Itai
我在Foundation团队工作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=33) [本次演讲中 我想介绍](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=36) [数据在你app中的流向
是如何影响app本身的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=38) [以及你要如何建立在数据中的信任](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=41) [来更好地保护你的用户](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=43) [让我们开始吧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=45) [app不是生存在真空中的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=48) [为了能让你的app
做些有意义的事情](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=50) [它们要从外部资源中提取数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=52) [像是磁盘 网络 或是用户本身](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=54) [然后利用这些数据做些有意义的事情](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=57) [然后利用这些数据做些有意义的事情](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=57) [再将其呈现给你的用户](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=60) [为了让该数据是可消耗的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=62) [它应该以某种已知格式或结构来呈现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=65) [若非这样的格式或结构呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=68) [这通常意味着数据被损坏了
或某种程度上是无效的 可以被忽略](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=71) [但有时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=77) [这些数据会让你app
所做的设想无效化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=78) [且它会导致你的app不能正常工作
或者甚至是崩溃](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=82) [这会给在等待你的app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=88) [在App Store更新的用户
带来不好的体验](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=90) [如果在发布时崩溃就更糟糕了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=93) [因为他们甚至连app都用不了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=96) [与此同时 在你等待的时候](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=98) [你会得到一波一星评价](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=100) [这对谁来说都不是好事](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=103) [如果你是个框架开发者的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=106) [这类事情就更容易被人记住](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=108) [因为它可能不仅仅会影响一个app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=110) [还可能影响许多app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=113) [今天我们要介绍的是关于信任的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=116) [更具体地说](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=119) [我们要讨论的是如何通过保证两件事](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=120) [在数据中建立信任](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=123) [（令人信任的数据）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=124) [首先就是我们要使用的数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=125) [没有被除我们之外的人修改过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=127) [第二点就是它要包含我们想要的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=130) [格式和结构](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=133) [要实现这些目的
我们要看一下数据的生命周期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=137) [以及我们在生命周期的每个阶段
可以如何验证该数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=141) [然后我们再看下可以应用的
NS安全编码协议](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=146) [来实现哪种类型级别的验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=150) [然后再对可编码类型进行相同的处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=153) [让我们开始吧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=157) [（数据建模）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=158) [为了介绍该数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=160) [我们要建立一个关于app中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=161) [可获取的数据形式的构思模型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=163) [在最基本的层级](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=167) [数据是以字节流的形式
出现在我们的app中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=169) [在这个阶段
如果我们不看的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=174) [是讲不出有关这类数据的更多内容的
我们将其称之为原始数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=176) [要处理该数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=181) [我们需要保证
它是遵从已知格式或结构的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=183) [在这种情况下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=187) [每个编码点要对应一个UTF编码点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=188) [抱歉 稍等一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=192) [让我把它变得更好读一点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=193) [看来这是JSON数据文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=195) [而在我们保证了该数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=197) [是我们想处理的某种格式后
我们将其称为格式化数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=200) [格式化数据本身没有太多意义](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=204) [我们要对其创建主要值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=207) [字符串 数组 以及字典](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=210) [这样我们就可以在以后的算法中
将其作为构建块使用了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=212) [我们将其称为我们的主要数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=215) [我们有经常要用到的构建块](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=219) [不仅是作为主要值
还有我们自己的模型类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=221) [在我们这么做之后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=226) [我们会用到这个叫做
结构化数据的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=227) [这些我们app中的数据形式
会形成一个抽象时间线](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=232) [原始数据是我们所处理的
数据中最不抽象的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=239) [原始数据是我们所处理的
数据中最不抽象的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=239) [而我们自己的
结构化模型类型是最抽象的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=242) [我们现在的目标](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=245) [就是尽可能大范围地获取数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=246) [我们的app可在任何合适点停下来
利用这些数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=250) [但我们还想要随时处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=254) [我们自己的模型类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=256) [现在的目标](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=258) [就不仅仅是获得
尽可能大的抽象范围了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=259) [而是在过程中建立信任](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=263) [在每个阶段 数据都会变得更复杂](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=266) [而且会比我们进行验证
所需要的数据更多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=269) [而在这么做之后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=271) [会得到比所需信任的数据
更多的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=272) [对于我们今天的用例而言](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=276) [我们不会太过介绍格式化数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=277) [它通常就是原始数据
和主要数据间的踏脚石](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=280) [你不会直接用到它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=283) [例如 给出了原始数据后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=285) [foundations JSON序列化
会给你返回主要数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=287) [你不会直接看到格式化数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=290) [也不会用到它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=292) [所以今天我们要介绍的是
原始主要和结构化数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=294) [让我们从原始数据开始讲起](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=300) [正如我们刚才所说的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=302) [原始数据就是进入你app的
一个字节流](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=304) [在你检查了该数据并赋予其意义之前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=308) [你用它干不了什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=311) [（原始数据）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=312) [现在我们或许想知道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=313) [在我们开始检查这个数据前
能看到什么内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=316) [这样做是不是安全呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=319) [我们在用该数据之前
所能验证的一个内容就是它的长度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=322) [比如 你的app
要从磁盘加载1字节的文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=326) [但是在磁盘中找到了十亿字节的文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=329) [你是不是应该加载这个数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=332) [并且开始读取它呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=334) [当然不是了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=335) [有时候我们或许不能确定](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=338) [数据的长度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=341) [可能它是不被我们拥有的外部数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=342) [我们不知道会有多少数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=344) [但是在某些情况下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=346) [我们可以验证校验和](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=347) [或是加密签名](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=349) [这样就呈现了数据看起来是什么样子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=351) [即使我们不知道内部什么样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=353) [校验和就是对所有数据进行哈希处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=356) [如果数据有任何的变化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=358) [如果数据有任何的变化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=358) [不管是由于潜在的第三方恶意破坏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=360) [还是常规的数据损坏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=363) [磁盘的坏道
糟糕的网络连接…](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=364) [如果数据的任何一个比特变化的话
就会让校验和](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=367) [或签名无效](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=371) [我们会在读取这些字节之前就知道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=372) [数据是不正确的
你不应该信任它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=374) [我们不总有一个检验和](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=379) [可能这个数据不是我们所有的
我们不能提前得到它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=381) [所以在这个阶段
除了读取并且检查数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=384) [我们不能对它进行更多处理了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=387) [在我们处理完原始数据后
就得到了主要数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=390) [正如我们之前提到的
我们获取原始数据后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=394) [将其传过
通常会将它去序列化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=397) [像是foundations
JSON序列化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=399) [当我们完成操作时
我们会得到不活跃的字符串和字典](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=402) [数字数组
以供我们使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=405) [若这个过程成功了
我们就能了解该数据两方面内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=408) [（主要数据）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=410) [第一点就是
该数据确实是我们所期望的正确格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=412) [例如
XML数据不会通过JSON序列化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=415) [第二点就是
如果我们信任去序列化器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=419) [第二点就是
如果我们信任去序列化器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=419) [我们会知道我们得到的运行时间对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=422) [会是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=424) [foundations JSON
序列化会给你](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=426) [可用的字符串、数字和数组](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=429) [它是我们可以信任的独立值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=432) [但在这个阶段 我们可能感到奇怪](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=435) [“好吧…我们应该如何使用这个数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=437) [我们可以信任它的哪些方面](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=439) [我们还需要进行什么验证呢？”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=440) [在我们实际看到这个数据前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=444) [我们对它内容没多少了解](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=448) [事实上 我们只有开始检查它的时候](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=450) [才能更好地了解数据结构](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=453) [如果你曾以这种方式
用过动态去序列化的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=455) [你就会了解它有很多的缺点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=457) [你不能提前得到数据是什么样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=460) [因为它是非常概括性的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=462) [因此我们想看下该数据包含什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=464) [我们可以如何使用它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=467) [让我们举例来说一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=469) [我最近一直在开发一个叫
Sell My Old Junk的app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=471) [它可以让我
把旧货卖给朋友和家人](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=474) [当他们有人打开我的app时
我的app会向服务器发一个请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=478) [当他们有人打开我的app时
我的app会向服务器发一个请求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=478) [它会请求一个目前可以卖给](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=483) [我的朋友和家人的物品列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=487) [（我的app）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=488) [当服务器收到这个请求时
它会回应一个JSON文件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=490) [这就表明
这里就是要卖的产品](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=493) [从我的服务器
返回的API就是这样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=497) [它是一个产品列表的数组
其中有些有意思的字段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=501) [你值得去看一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=504) [（API响应示例）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=505) [例如 每个列表中有个产品ID](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=507) [这是个用来标识产品的唯一正整数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=510) [在本例中
它们是些顺序的整数ID](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=513) [每个列表还有字符串型的名字和描述](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=517) [还有另外一些有类型的字段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=520) [值得我们看一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=521) [例如 有一个字段是一个布林值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=524) [它表明了这个列表项
是不是已经被卖掉了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=526) [在其中还有一些内部结构](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=530) [我们可能会用到
这个字符串型的标签列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=531) [还有一些字符串型的字段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=536) [呈现的是我们想看的其他数据形式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=538) [呈现的是我们想看的其他数据形式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=538) [例如 URL和日期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=542) [让我们来使用下这个数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=545) [我的app中 我可从如URL会话
或其他可能网络环境中抓取到该数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=547) [我会验证其长度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=551) [我的服务器可能会生成一个校验和](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=553) [或加密签名来让我进行验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=556) [在我完成之后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=560) [我可以将该数据传入JSON序列化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=560) [如果该数据的去序列化失败了
JSON序列化会抛出一个错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=564) [以供你接下来检查 捕捉并处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=568) [它可能会给我的用户显示对话框](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=570) [我们现在的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=573) [我们就像获取原始数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=575) [并将其以抽象范围内变为主要数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=578) [如果出现了任何问题
我们可以处理那个错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=580) [现在我们需要使用这个数据了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=584) [我们能如何使用它呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=586) [JSON是包含着实际值的变量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=587) [所以我可以将其向下转型成](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=592) [我想要的字典数组](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=593) [我的app这个部分只关注](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=596) [与音乐有关的产品列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=598) [与音乐有关的产品列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=598) [这样就会过滤掉
所有不含音乐标签的产品](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=600) [这里我有标签列表这个子结构](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=603) [我可将其向下转型为一个字符串数组
并且可以使用这个数组](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=606) [哎呀](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=611) [每个这样的强制向下转型
其实都包含着一个隐藏的致命错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=613) [如果因为API或是数据
在发送到app前发生了变化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=618) [而导致某个转型失败的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=621) [可能是由于数据损坏或是恶意篡改](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=624) [这些向下转型就会失败](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=628) [当它们转型失败的时候就会中止
并且会让我的app崩溃](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=629) [这会给我的用户带来糟糕的体验](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=633) [让我们看看这是如何发生的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=636) [这里是那个示例API响应](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=639) [让我们看下这里的标签列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=642) [（类型验证）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=644) [比如 这里的第二个标签被修改了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=645) [由字符串变成了数字](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=649) [它是由第三方恶意篡改的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=651) [或是由于常规数据损坏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=653) [我们不总能分辨出造成的原因](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=655) [向下转型这个标签列表会失败
因为它们不是字符串](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=657) [向下转型这个标签列表会失败
因为它们不是字符串](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=657) [而且我们在进行转型前
从来没有检查过是不是可以转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=662) [（先验证 再执行）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=665) [为了避免该问题
我们今天会一直强调](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=667) [要先验证 再执行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=668) [不要妄下断言你知道数据是什么结构](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=673) [先检查一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=676) [不要盲目假设](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=677) [看看如何进行检查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=679) [这里又是第一个强制向下转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=681) [不要强制向下转型这些值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=684) [我在这里会有条件地向下转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=687) [这可以让我验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=692) [该数据是不是包含我真正想要的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=695) [如果转型失败的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=698) [我就可以对错误进行处理
而不是得到致命错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=700) [同样地 接下来向下转型
那个字符串列表时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=704) [不要强制向下转型
我会进行有条件地向下转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=708) [在本例中 不会抛出错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=712) [而是我会给出一个默认值
来让执行继续](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=714) [在本例中 我会忽略掉所有](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=718) [在本例中 我会忽略掉所有](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=718) [无有效标签列表的产品列表项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=720) [我可以抛出一个错误
但是在这里 我不会这么做](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=723) [类型验证不是你能在这个阶段所用的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=727) [唯一验证形式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=730) [例如 如果被替换成空的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=733) [在JSON中是完全有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=736) [（可空性验证）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=737) [我看到过一个类似的崩溃](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=739) [在Swift中 强静态类型
系统可空性是类型的一部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=742) [而且你不能将空向下转型成字符串](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=745) [所以这个转型是会失败的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=748) [即使所有值都有正确的类型和可空性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=752) [我们还应该注意其他的验证形式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=756) [例如 我说过每个产品列表项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=759) [都有一个正整数ID](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=761) [在我的例子中 它们是顺序的整数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=763) [若这些ID中有负数的话有意义吗？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=766) [是没有意义的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=769) [即使它一直是正数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=770) [如果是很大的正整数值有意义吗？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=772) [我卖不了那么多东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=776) [所以在本例中是没意义的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=778) [这可能是有人想在我的app中
引起溢出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=779) [这可能是有人想在我的app中
引起溢出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=779) [这是你需要注意的地方](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=783) [跟范围验证类似的是长度验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=786) [每个产品列表项都有一个描述](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=790) [那么可以让描述是空的吗？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=793) [（长度验证）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=795) [在我的例子中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=796) [我知道在我上传产品列表项的时候](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=797) [我总会放一个描述信息的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=800) [所以在我的例子中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=802) [将其设为空是说不通的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=803) [不过即使它不是空的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=806) [填满长度和内容有意义吗？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=808) [是没有意义的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=811) [这里有地方出错了
我需要看一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=812) [还有一些验证形式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=818) [是我们需要注意的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=819) [即使所有的字段都有正确的类型
可空性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=820) [有如我们预期的范围和长度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=823) [它们的值和内容也同样重要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=826) [每个产品列表项都有一个URL
我可以将其发送给用户](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=830) [让他们看到
关于该产品列表项的更多信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=833) [我是以字符串形式得到的
但它实际上包含了一个URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=836) [如果它是任意字符串的话有意义吗？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=839) [如果它是任意字符串的话有意义吗？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=839) [在我的例子中是没有意义的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=842) [我想确保它表示的是URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=844) [但更重要的是
仅仅因为它看着像是个URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=847) [并不意味着它会指向我的域名](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=850) [而这是我非常注意的一点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=852) [我非常想保证我用户的安全性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=855) [我不想发给他们一个网络钓鱼域名](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=858) [虽然看起来像是我的网址
但其实不是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=861) [所以这是我很小心留意的一件事](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=865) [（值间验证）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=867) [最后 即使每个字段本身是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=869) [有时候字段间的关系也很重要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=872) [例如 每个产品列表项在被创建](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=877) [以及最近更新时都会产生一个日期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=879) [它们本身是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=882) [但是如果最近更新的日期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=883) [早于它的创建日期
这样说得通吗？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=886) [不 在我的例子中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=889) [这可能不会在我的app中
造成安全漏洞](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=890) [但这可能是你需要注意的地方](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=893) [因为它会在出现问题的时候
很好地给你提醒](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=895) [或许我不应该信任这个数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=897) [让我们来看看
如何开始实现这个功能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=900) [这里我写了个函数
来接收这样一个列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=903) [并且开始验证所有的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=906) [我会获得一个列表
并调出产品ID](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=909) [这里我们已经学过了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=913) [不要强制将这个ID
向下转型成整型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=915) [而是要有条件地向下转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=917) [如果这个转型失败
guard语句会失败并抛出一错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=919) [现在我不想就此打住](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=923) [我想要执行范围验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=924) [以确保这个产品ID也是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=926) [这个ID是正数而且不会太大](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=928) [如果出现问题的话
我会抛出一个错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=930) [然后我想要检查下URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=936) [我会将其向下转型为字符串
而不是强制向下转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=939) [这里我可以检查这个链接](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=944) [在我的例子中 我知道
我的服务器不会生成太长的URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=945) [所以如果我发现了一个很长的URL
我就会知道它是无效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=949) [在我验证了它之后
我会将它以URL类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=954) [执行特定域名验证
以确保它真的是一个URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=957) [执行特定域名验证
以确保它真的是一个URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=957) [而不是一个垃圾字符串](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=960) [同样地 如果出现问题的话
我会抛出一个错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=961) [我不想止步于此
在我获得一个真正的URL后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=965) [我想要确保它会指向我的域名
而不是钓鱼网站](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=969) [我会留意这一点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=972) [在这里](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=975) [我可以将相同类型的验证
app到其他字段上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=976) [如果出现问题的话
我会抛出一个错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=978) [有了这个函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=981) [我可以将其app到所有
我从负载中所加载的产品列表项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=982) [如果出现问题的话
我就会停止执行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=987) [这就是我们要如何来验证主要数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=993) [如我们所见 主要数据是很笼统的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=997) [（结构化数据）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=999) [字符串可以是字符串
但也可以是日期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1000) [也可以是一个URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1006) [有时候我们希望数据的语义
是和我们有关系的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1010) [我们想确保URL的主机名
是我们的域名](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1014) [而使用常规的字符串是做不到的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1017) [而使用常规的字符串是做不到的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1017) [与之相似的 字典可以表示
像是这个列表一样的模型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1021) [或是表示任意的我们根本不了解的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1025) [用户数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1027) [不用在各个地方执行相同的验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1030) [来保证所有我们关注的字段是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1032) [而是使用我们自己的模型类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1034) [保障总是在那里不是很好吗？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1037) [是的 在我们的例子中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1041) [我们想在所有可能的地方
使用结构化数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1042) [我们可以将主要数据
作为构件块来使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1045) [不过我们想处理那个数据形式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1048) [让我们来看下要如何实现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1051) [在我app的其他地方有个购买类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1055) [就像是这样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1058) [当有顾客进行购买时
我会将该数据存储到磁盘上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1060) [然后当他们打开app时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1064) [即使他们没有连接到网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1065) [也可浏览自己的购买历史纪录](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1067) [每条购买记录会追踪](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1070) [它所对应产品列表项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1072) [是何时进行的购买
以及一个收据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1073) [我可以像这样 利用NS编码
和NS键归档将其保存到磁盘上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1078) [我可以像这样 利用NS编码
和NS键归档将其保存到磁盘上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1078) [我会对它进行归档](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1082) [但正如我们所见
当我们解压数据的时候](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1084) [我们在处理原始数据和主要数据时
我们要对它进行验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1086) [让我们看看](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1090) [这里的编码器是如何初始化的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1092) [若你曾写过编码器初始化方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1094) [这可能让你看上去很熟悉](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1095) [我们要先解码这个产品列表项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1097) [我们提到了
要用有条件地向下转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1100) [而不是强制向下转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1102) [如果出现问题的话
这是个可出错的初始化器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1105) [我们返回空就好了 对吧？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1107) [如果解码成功了
我会将其分配给我的属性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1111) [然后接着操作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1114) [我会对购买数据做相同的处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1115) [有条件地向下转型为日期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1117) [如果出现问题了
我会失败 诸如此类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1119) [我对我类型的每个字段
都重复这个操作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1122) [当我想将其中一个购买记录
保存到历史纪录时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1125) [我有一个函数可以让我这么做](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1128) [它会将购买记录归档为二进制数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1130) [随后我将其保存到磁盘上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1135) [或是将该数据保存到数据库等处](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1136) [当我想将数据加载回来时
我可以进行相同的操作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1141) [我可以获得原始数据 然后将其传给
KeyedUnarchiver](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1143) [然后得到一个返回的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1148) [正如我们所说的 在这的每个点
数据都会变得更为复杂](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1151) [在我们可能信任它之前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1155) [我们还得对它进行更多验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1157) [你可能会感到奇怪
“好的 有什么呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1159) [还剩下什么可验证的呢？”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1161) [这里的向下转型就是一个不错的点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1163) [这个向下转型是发生于
我们解压对象后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1167) [这怎么会失败呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1172) [这表示有些其他的问题出现了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1175) [让我们来看一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1177) [（有键归档中的模型表示）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1179) [这是个我的归档中的模型对象的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1180) [抽象表示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1182) [这里有所有我们在编程中关心的字段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1186) [每个字段都包含自己的结构 子结构](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1189) [以及内容等等](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1191) [但这里有意思的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1193) [这个表示还包含了这个对象的类名](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1195) [这个表示还包含了这个对象的类名](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1195) [让我们来看下KeyedUnarchiver
是如何使用这个信息的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1201) [我们正在进行一个解码调用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1205) [这会创建一个
KeyedUnarchiver](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1208) [并为对象键解码一个对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1210) [（对象解码）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1213) [当你在KeyedUnarchiver中
执行它时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1214) [KeyedUnarchiver
会在归档的对象中查找该类名](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1216) [并将它调出来](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1220) [然后在你的app中
动态查找有着相同名字的类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1221) [然后它会分配该类的一个实例](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1226) [将其初始化
以便它可以解码自己的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1229) [然后它会唤醒对象
让对象可以结束自己的状态](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1234) [我们的对象用起来很好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1240) [不过我们可能会感到奇怪
如果数据被恶意篡改](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1243) [包含了一个我们不想要的
类的对象呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1247) [我们刚执行过的整个过程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1251) [会以不同的类型出现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1253) [我们分配、初始化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1256) [并且唤醒了一个
我们不想要的类的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1259) [并且唤醒了一个
我们不想要的类的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1259) [这会对app产生何种影响呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1262) [正如我们之前所见
这里的有条件地向下转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1266) [会防止我们意外地使用
这个不想要的类的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1268) [我们只会用
我们想要的类型的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1272) [向下转型失败的话
我们就会出错](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1275) [但解码这样一个对象会对app
产生一个持续的影响](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1280) [比方说这个类有个
会改变全局状态的alloc方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1284) [它可能会分配一个单例
或是改变某个全局数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1288) [即便我们扔掉了这个对象
如果出错的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1293) [这会对app产生一个持续的影响](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1296) [并且会导致某处出现异常行为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1297) [而且归档可以这种方式被恶意构造](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1300) [从而导致我们app发生这种问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1303) [我们该如何验证这数据
防止这样的问题呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1306) [NSSecureCoding协议
这时候就会起作用了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1310) [（NSSECURECODING）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1312) [NSSecureCoding
是继承于NSCoding的协议](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1313) [其目标就是为了防止这类攻击](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1317) [其目标就是为了防止这类攻击](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1317) [（NSSECURECODING
的目标）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1321) [通过让你提前传入类型信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1322) [它会防止验证归档内容
随意的代码执行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1326) [以确保它只包含你想要的类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1331) [NSSecureCoding
的标志性内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1335) [为键解码对象
的两种替代方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1338) [它可以让你提前传入类型信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1341) [通过使用该类型信息
NSKeyedUnarchiver可以保证你的安全](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1344) [（NSSECURECODING中
的对象解码）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1347) [让我们来看下目前应对键调用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1348) [的解码对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1350) [这个最上层解码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1352) [如果我们使用变量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1354) [让我们提前传入这个类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1356) [在本例中 我们想解码购买记录](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1358) [不用执行整个过程
以及归档中的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1361) [你可以先进行类检查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1365) [让我们看下这个类检查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1369) [在解码的每个阶段
如果开启了安全编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1372) [NSKeyedUnarchiver
会维护一个可以有效解码的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1375) [类的列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1378) [当我们进行这么一个调用时
NSKeyedUnarchiver](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1381) [会利用我们使用的对象
也就是这个类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1383) [并从这个类
构造一个允许的类的列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1387) [当我们接着
从归档中解码一个对象时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1390) [允许的类列表
会首先检查这个类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1394) [如果它没有出现在列表中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1397) [这个解码调用就会被拒绝](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1399) [如果我们在归档中
找到的类的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1402) [出现在允许的类列表中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1405) [我们需要执行几个检查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1407) [我们需要保证这个类本身](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1410) [也遵从于
NSSecureCoding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1412) [如果它不遵从的话
我们就没法保证它本身](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1415) [会在后面安全地
解码它自己的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1418) [那样的话我们就不能
安全地解码其中的对象了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1421) [在我们的例子中
这个购买记录类遵从于该协议](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1424) [所以它可以安全地解码并追踪](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1426) [还有其他两种检查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1430) [是跟超类、子类关系有关的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1431) [如果你有两个类
一个是另一个的子类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1435) [两个类都遵从NSCoding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1438) [两个类都遵从NSCoding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1438) [超类采用了
NSSecureCoding一致性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1440) [而子类继承了这个一致性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1443) [子类没有办法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1447) [重写编码器的初始化
来实现安全性方面的功能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1450) [所以这里我们有一个出口](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1453) [支持安全编码的方法
可以让你说](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1457) [我其实不支持安全编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1459) [并且你可以把这个功能关了说
“我还没准备好”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1462) [如果你还是说支持](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1466) [我们得确保 你或是继承了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1469) [来自超类 对于NSSecureCoding
的完全一致性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1472) [或是你覆盖了这两个方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1475) [表明
是的 我真的支持安全编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1478) [这里没有问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1480) [在我们的例子中
购买记录符合这些需求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1484) [所以我们可以从归档中
安全地对其进行解码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1486) [现在让我们解码一个购买记录](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1491) [它本身会解码一个列表项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1493) [并且它会利用相同类型的调用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1495) [来表明它想要一个列表项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1497) [（利用NSSECURECODING
来解码对象）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1499) [（利用NSSECURECODING
来解码对象）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1499) [当它这么做的时候
NSKeyedUnarchiver](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1501) [会使用这个类
来构造一个新的允许类列表](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1503) [这个新版本的列表的
所有内容都会被检查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1506) [我们解码一个对象时
会执行相同的检查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1509) [在本例中
列表项仍然是可以有效编码的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1512) [但是…](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1517) [如果我们试图解码一个不在列表中的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1518) [不想要的类的对象的话
它会被拒绝](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1521) [让我们看下
这样的拒绝是什么样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1525) [这叫做解码失败](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1528) [还有几种类型的失败](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1530) [我们应该留意一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1532) [当开启了安全编码时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1533) [我们可以看到像是这样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1535) [违反安全解码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1537) [还有其他的失败形式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1538) [例如 如果你试图解码对象的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1541) [可能会出现类型的不匹配
出现在这个位置的归档中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1543) [有一个像是整数的主要值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1546) [或者你试图解码一个
像是整数的主要值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1549) [但我们找到一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1552) [不兼容类型的对象或是主要值
像是双整形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1553) [这就会导致解码失败](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1557) [（解码失败）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1558) [（解码失败）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1558) [这里还有可能出现另一个形式的失败](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1560) [那就是归档损坏](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1562) [如果归档本身损坏严重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1564) [而且不符合
NSKeyedUnarchiver所期望的格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1565) [我们就不能解码任何内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1569) [因此你就会得到相同类型的失败](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1571) [出现失败时会发生什么](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1574) [是取决于Unarchiver上的
解码失败政策的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1576) [这里有两个选项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1580) [在失败的时候
我们可以抛出一个异常](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1582) [或是储存出现问题的有关信息
并继续执行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1585) [抛出异常是当前的默认选项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1589) [如果我们有个来自前面的调用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1594) [试图解码一个列表项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1596) [我们会在归档中
找到一个不想要的类的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1598) [它会在底层调用
failWithError这个方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1602) [这个方法在Unarchiver中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1604) [并会传入一个表明了
在哪出现了什么问题的错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1606) [在底层 failWithError
要做个决定](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1610) [如果解码失败政策
是抛出异常的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1614) [它就会抛出异常](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1616) [如果你在写Swift app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1619) [如果你在写Swift app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1619) [这是你需要留心的东西](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1620) [Swift不能捕捉
Objective-C或C++异常](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1622) [所以这可能会导致
你的app出现致命错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1625) [这会导致出现崩溃
并给用户带来糟糕的体验](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1627) [如果解码失败政策
是设定错误并返回的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1633) [该错误会被分配到
Unarchiver的错误属性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1636) [然后会继续执行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1639) [在本例中 因为会继续执行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1641) [解码调用必须得返回某些内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1644) [所以它会返回空
来表明没有任何内容可以被解码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1646) [如我们所提过的
如果你要解码一个主要类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1651) [而且我们找到一个
不兼容的对象或是主要类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1654) [那么就会出现一系列相同的步骤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1658) [本例中 就会不返回空](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1660) [我们就返回零](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1661) [failWithError是
NSKeyedUnarchiver上的API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1667) [我鼓励你们使用自己的代码
来表明失败的出现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1670) [以及出现了什么问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1673) [这里不会返回空](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1675) [failWithError
首先会记录该信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1677) [（失败得有意义）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1679) [（失败得有意义）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1679) [如果你这么做的话
需要记住几件事](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1681) [如果解码失败政策
是设定一个错误并返回的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1684) [你要记住
在Unarchiver上设定错误后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1687) [后面就不能重设了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1690) [这是因为一个解码失败](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1692) [经常会导致一系列的解码失败](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1695) [我们不想丢掉
最初是哪里出现了问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1697) [其次你要记住 任何给定的
failWithError调用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1702) [要么会抛出一个异常
要么就会继续执行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1705) [所以这两种选项你都要留意](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1708) [特别是你在用
Objective-C时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1710) [你可能会捕捉到异常](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1712) [有些内容你需要处理一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1714) [最后 要留意下
空或零返回值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1717) [这两个值在解码失败的时候
都有可能出现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1720) [如果解码失败政策
是设定错误并返回的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1723) [或是数据刚刚丢失了的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1726) [或是被编码成空或零](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1728) [为了消除这些情况间的歧义](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1730) [你要检查Unarchiver
上的错误属性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1733) [我们介绍了很多内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1737) [让我们将其提炼成一个清单](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1739) [让我们将其提炼成一个清单](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1739) [看看如何在我们自己的类型上
采用NSSecureCoding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1741) [开始时我们会将
所有键调用的解码对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1745) [转变成允许我们
提前传入类型信息的变量](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1748) [（采用
NSSECURECODING的清单）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1751) [随后如果出现了问题
不要只是返回空](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1752) [用failWithError
来表明出现了什么问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1755) [最后 这是个审计
未来失败点的好机会](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1758) [我们还没有对这些点进行过验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1762) [让我们这么做吧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1764) [这里有个解码调用来解码列表项](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1767) [你会发现如果我们
提前传入类型信息的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1770) [有条件地向下转型
随后会消失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1773) [这个方法有个一般覆盖](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1776) [在静态地给出类型信息时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1778) [会让你没法再有条件地向下转型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1781) [你可以一直获得该类的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1784) [不要在失败时返回空](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1787) [我们想要失败得有意义](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1790) [我们可以在失败时 创建一个
表明在哪出现了什么问题的错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1792) [在本例中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1797) [我们可以使用CocoaError
上的便利内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1798) [我们可以使用CocoaError
上的便利内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1798) [来返回一个包含好的
本地化描述的有意义错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1800) [让我们的用户知道出现了什么问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1803) [如果需要的话 我们可以给自己](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1806) [后面日志上
添加debug描述](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1809) [但这个是核心](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1811) [返回空之前 我们想用
failWithError方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1812) [随后我们解码了购买日期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1817) [这里也是个好机会 让我们添加](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1820) [之前没有进行的验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1824) [如果我们可以解码日期的话
我储存这个属性就可以了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1826) [但我想保证这个日期是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1830) [例如 购买是不可能在](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1833) [我的app在App Store
上架前就发生的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1835) [这些是你可以检查的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1838) [若这里出现问题 我们想在失败时
获得一个有意义的错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1839) [在本例中 数据没有丢失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1844) [而是数据被损坏了
或者说在某种程度上是无效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1846) [我们会表明这一点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1848) [（NSSECURECODING
的采用清单）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1851) [现在我们已经
在我们的类型上这么做了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1853) [我们就可以声明
它是支持安全编码的了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1856) [我们就可以声明
它是支持安全编码的了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1856) [最后遵从
NSSecureCoding协议](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1860) [来表明我们想要运行时间](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1863) [它真的支持安全编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1866) [然后 恭喜你](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1870) [我们获得了
NSSecureCoding徽章](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1872) [实际的徽章是分开卖的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1875) [我们觉得 获得你自己的
NSSecureCoding徽章](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1879) [并使用它们
对你而言是很重要的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1882) [今年我们添加了新的API
和NSKeyedUnarchiver](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1884) [保证了NSSecureCoding
随时可以完成](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1886) [（默认安全的API）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1890) [这个新的初始化器和便利方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1891) [会默认开启安全编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1893) [并且将默认解码失败政策设定为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1895) [在返回时设定错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1897) [所以除非你自己更改了解码失败政策](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1899) [你不需要担心Swift中的异常](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1901) [而旧的初始化器和便利方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1905) [在新的版本中会设为过期了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1908) [我们真的想让你使用它们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1910) [类似地 我们引入了
与NSKeyedUnarchiver相同的API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1913) [让你可以更容易地在归档时
开启SecureCoding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1917) [让你可以更容易地在归档时
开启SecureCoding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1917) [这是很重要的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1920) [因为它可以保证你不会不小心地归档](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1922) [不遵从
NSSecureCoding的对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1925) [你后面就不能将它解码了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1927) [旧的初始化器和便利方法
也会被设为过期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1930) [这就意味着如果你有](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1933) [像是这样的旧代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1935) [在归档时
打开SecureCoding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1937) [并切换到允许你提前传入类型信息的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1940) [便利方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1942) [这样你就可以使用
SecureCoding徽章了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1945) [请确保你获得了该徽章](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1948) [如果你因为你的类型不能遵从](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1951) [还不能支持安全编码的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1953) [或它们本身是取决于还未遵从的类型
那没关系](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1955) [你还是可以在代码中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1958) [使用这些方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1960) [只需要关掉安全编码需求就可以了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1961) [在解码中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1964) [这些便利中的安全编码一直是启用的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1965) [你可以使用新的初始化器来创建
KeyedUnarchiver](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1968) [并手动关闭安全编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1972) [你可以在需要的时候将解码失败政策](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1975) [重设回旧的默认值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1979) [重设回旧的默认值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1979) [在你有了Unarchiver后
你就可以像往常一样解码了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1982) [如果你在开发Swift app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1988) [NSSecureCoding
就不是唯一一个可用来将你模型类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1990) [与外部表示间相互转换的方法了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1994) [（可编码）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1996) [去年在Swift 4中
我们引入了可编码协议](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=1997) [可以更容易地实现那些功能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2000) [重要的是 所有NSSecureCoding
的设计决策](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2002) [从一开始就出现在可编码中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2005) [可编码从来不会将类型信息
写入归档中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2011) [所以后面没有什么可信任的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2015) [通过让你提前传入要解码的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2017) [静态类型信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2020) [你可以防止这类攻击](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2022) [可编码也有便利方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2026) [如果你有个类型
它的字段本身都是可编码的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2028) [你就可以得到 初始化需求](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2031) [以及编码需求的同步实现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2033) [而同步实现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2036) [会免费为你进行类型检查
和可空性检查](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2037) [正如我们所见
很多类型如果是来自外部资源的话](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2040) [需要进行额外的验证
就像是我们的这个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2043) [我们需要对其进一步验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2046) [我们可以通过从解码器覆写其初始化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2049) [来对我们自己的类型进行验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2051) [在本例中
有个来自前面的JSON响应](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2054) [我可以通过创建一个
带有同名字段的类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2057) [来将它巧妙地转换成可编码类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2059) [因为所有字段都是可编码的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2063) [我就可以得到初始化
和编码的免费实现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2065) [但我想要覆写初始化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2068) [以确保我所执行的验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2070) [跟我前面对主要值
所做的验证是一样的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2072) [我能以相同的方法在这里实现它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2074) [我从负载解码ID的旧代码
是将其向下转型为整型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2078) [我在这只要从解码器
解码一个整型就可以了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2083) [如果在负载中找到的类型
是不同的或是丢失的类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2088) [这就会抛出一个
表明所出现问题的错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2092) [比这更重要的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2096) [我在这个验证方法中
添加的自己的验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2098) [我在这个验证方法中
添加的自己的验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2098) [这里我想执行相同的验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2102) [以保证ID是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2104) [这里我可以用一个便利方法
来抛出一个有意义的错误](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2106) [来表明所出现的问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2109) [然后在该验证函数中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2113) [我会以字符串调出创建日期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2115) [然后将其传入日期格式化器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2118) [来获取一个有效的日期](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2121) [因为我们使用的是JSON解码器
我们只要直接解码日期就可以了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2125) [我们不需要担心类型转换](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2129) [我们可以用JSON解码器
的日期解码政策](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2132) [来表明会进行哪种转换](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2135) [这样很不错
因为这个转换一行代码就能实现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2138) [而且…](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2142) [其他的解码调用也是一行就能实现](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2143) [这样我就可以更容易地关注](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2145) [我所关心的类型验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2147) [在这个验证函数中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2151) [我可能已经以字符串数组的形式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2153) [调出了标签的子结构](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2156) [然后将这些字符串映射到了
我自己的类型上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2157) [然后将这些字符串映射到了
我自己的类型上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2157) [以供后面的验证所用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2160) [有了可编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2164) [我就可以利用
标签也是遵从可编码的优势](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2165) [所以我就可以直接解码一个标签数组](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2168) [这是自动发生的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2171) [这样我就可以不用关注类型转化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2173) [而是关注对我来说重要的验证了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2175) [这可以让我确保
该数据是我能信任的数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2178) [我们今天介绍了很多内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2184) [我们从原始数据开始介绍](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2187) [然后围绕着抽象范围介绍到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2188) [我们自己的模型类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2191) [接着我们看了下如何通过验证校验和
或是原始数据的长度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2193) [来建立对于该数据的信任](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2198) [我们保证了是通过检查
来证明它是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2201) [甚至检查了它是否遵从于某些格式](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2204) [在我们确保它遵从于一个已知格式后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2207) [我们就知道了
那个格式化数据是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2210) [并且得到了主要值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2213) [（总结）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2216) [通过验证那些主要值的内容和结构](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2217) [通过验证那些主要值的内容和结构](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2217) [我们可以确保这些值是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2221) [并将其转换为我们自己的模型类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2223) [通过验证这些模型类型间的语义](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2226) [和关系](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2227) [我们保证了这些数据是有效的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2230) [并且是可以被信任的数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2232) [然后呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2235) [（下一步）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2237) [你已了解这些内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2238) [我鼓励你们去看看你们的代码
并且就这么去做](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2239) [在每个生命周期验证数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2243) [在该数据生命周期的每个阶段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2245) [检查类型和可空性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2248) [更重要的是 范围和长度
以及域名专属的app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2249) [如果你有NSCoding类型
审计这些类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2254) [来获得
NSSecureCoding徽章](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2257) [不要只是获得这个徽章
你要使用它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2259) [在任何能用的地方
开启安全编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2260) [最后 在所有可以的地方
采用可编码来处理新的数据类型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2263) [并且保证执行该验证](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2267) [保证你只用能信任的数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2270) [（更多信息）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2274) [有关可编码的更多内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2275) [请参见去年关于Foundation新特性
这个演讲](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2277) [若你有更多关于这个主题的问题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2280) [或想就如何将其app
到自己的app 向我们寻求帮助](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2281) [请参加今晚的实验室](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2285) [我们有个Foundation实验室
可以帮到你们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2286) [非常感谢大家来参加我的演讲](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2290) [祝你们度过愉快的一天](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/222/?time=2293)