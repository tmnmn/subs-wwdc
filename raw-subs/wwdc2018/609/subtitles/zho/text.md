# Metal for Accelerating Machine Learning

## Summary
Metal Performance Shaders (MPS) includes a highly tuned library of machine learning primitives leveraging the tremendous power of the GPU. With iOS 12 and macOS Mojave, MPS adds capabilities to accelerate the computationally intensive task of training a neural network. Learn performance optimizations for inference, and understand the training process for both convolutional and recurrent neural networks (CNNs and RNNs).

## Info
* Developer Tools
* WWDC 2018 - Session 609 - iOS, macOS, tvOS
* https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/

## Text
 [（用Metal框架加速机器学习
演讲609）](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=16) [大家下午好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=29) [欢迎来到“Metal框架
加速机器学习”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=31) [我是Anna Tikhonova](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=35) [我是GPU软件团队的工程师](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=37) [Metal性能着色器框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=42) [是基于Metal而建立](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=44) [为GPU提供更快速的原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=46) [并已为iOS和macOS优化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=49) [我们提供的原语包括图像处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=52) [线性代数和机器学习](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=55) [我们曾讲过大量有关推理的内容
在往年的WWDC演讲中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=58) [我们曾讲过大量有关推理的内容
在往年的WWDC演讲中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=58) [这里我只是再强调一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=62) [今年新增的训练支持](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=66) [iOS和macOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=69) [谢谢](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=75) [还有更快速的光线追踪](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=78) [添加到了平台](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=81) [我们为此做过一整场专题演讲
就在本周初](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=82) [主题是
“Metal框架加速光线追踪”](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=86) [演讲的视频很快就会上线](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=90) [今天演讲的主要内容是关于机器学习](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=94) [特别是训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=97) [我提过训练和推断](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=102) [深度学习算法由这两个阶段构成](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=104) [第一个阶段是训练阶段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=107) [举个例子 比如训练一个模型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=110) [对图像分类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=113) [比如猫、狗、长颈鹿等等](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=116) [那么为了训练模型能识别猫](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=119) [那么为了训练模型能识别猫](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=119) [就要输入大量标签为猫的图片](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=123) [再以同样的方法
输入兔子和其他动物的图片](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=127) [让模型去识别](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=130) [训练的计算量很大而且是很耗时的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=134) [迭代进程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=137) [训练的结果是已训练的参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=139) [已训练的参数是下一阶段的必备条件](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=144) [也就是推断阶段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=147) [这个阶段中 模型会看到一张新图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=148) [之前从未见过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=151) [它需要对其分类
以已训练的参数为基础](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=153) [这是只猫](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=156) [GPU加速现在可以](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=158) [同时用于训练阶段和推断阶段](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=160) [但在讲训练之前](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=165) [我要先谈谈CNN推断优化
这是我们今年添加的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=167) [现在FP16计算可以支持](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=171) [卷积和卷积转置原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=175) [Apple A11 Bionic
GPU有此新功能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=178) [Apple A11 Bionic
GPU有此新功能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=178) [我们发现FP16计算推断](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=184) [就精度而言完全足够](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=188) [适合常用的神经网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=191) [FP16计算更为精确还十分省电](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=195) [所以请一定要把它运用到推断中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=200) [这个例子展示了
如何将FP16计算](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=205) [用于卷积原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=209) [你只需设置
accumulatorPrecisionOption属性](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=210) [现在我们开始深入讲解
本场演讲的主题](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=216) [神经网络训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=221) [我们从卷积神经网络讲起](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=223) [这里有一个简单的
手写数字识别网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=228) [以手写数字图像为输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=233) [放入十个类中的一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=236) [从0到9](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=239) [从0到9](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=239) [这个例子中
图片被正确地归类为](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=241) [数字7的图片](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=244) [推断时用已训练的参数
初始化网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=249) [已训练的参数添加权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=253) [到卷积和全连接原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=256) [训练算法的目的
是计算已训练的参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=260) [让网络可以用它们让输入数据
在推断时修正输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=263) [训练进程开始的时候
没有任何权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=270) [我们需要计算](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=273) [所以第一步](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=275) [初始化权重
用较小的随机的数字](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=276) [现在可以开始
训练网络了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=280) [这里列出了
训练过程中的所有步骤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=282) [训练是一个迭代进程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=288) [每次训练的迭代
分为四步](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=290) [第一步是正向传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=293) [这时候将输入
传递给网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=295) [产生输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=299) [产生输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=299) [类似推断进程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=301) [然后计算缺失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=304) [损失直观地衡量了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=306) [网络输出值
与标准值之间的误差](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=308) [训练算法的目标
是最小化损失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=313) [下一步是梯度传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=318) [就是反向传播
网络输出相对](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=321) [标准值的误差
给神经网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=324) [再更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=327) [理念是随着训练不断进行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=329) [网络会越来越准确](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=333) [所以最好能用
输入修正输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=335) [从而最小化误差](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=339) [以上是概述](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=343) [下面分别看看
每个步骤的具体内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=344) [正向传播指
向网络正向传递信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=350) [以计算输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=354) [如你所见
在这个训练场景下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=356) [网络的表现不是很好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=359) [网络的表现不是很好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=359) [结果明显是错误的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=361) [为何这么糟糕？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=363) [其实也不意外](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=365) [因为初始权重
只是随机的数字](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=366) [网络还没有被训练
所以表现不好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=369) [现在要用权重来量化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=373) [网络表现的好坏程度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=376) [我们可以用这个信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=380) [来提高权重
希望经过多次迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=382) [能训练网络
输出更准确的结果](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=385) [为了衡量表现如何](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=390) [我们需要一个正确答案](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=392) [就是标准值
之后我会叫它标签](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=394) [它会与图像
一同输入网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=398) [这个例子中
向量为10个值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=402) [正确类的值为1
类7](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=404) [其他类均为0](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=407) [网络的输出
就是这十个概率值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=411) [每类给一个值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=414) [在这个训练场景下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=416) [网络输出一个很低的值
给正确答案7](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=419) [网络输出一个很低的值
给正确答案7](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=419) [而把最高值
分配给了9](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=423) [因此网络返回的
正确答案是9](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=427) [现在把所有信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=431) [传递给损失原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=433) [我之前讲过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=438) [损失衡量的差值
是网络输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=441) [较之标准值的误差](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=445) [而训练算法的目标
是最小化误差](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=447) [这时就要需要
图形的下半部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=452) [下半部分图形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=456) [包括梯度原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=457) [对应每个正向原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=460) [梯度原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=463) [计算更新权重所需的梯度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=465) [损失原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=469) [计算第一梯度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=472) [就是选定的
损失函数的导数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=474) [基于输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=476) [然后将这个梯度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=478) [反向传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=479) [反向传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=479) [通过网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=482) [通过第一个…](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=484) [梯度原语向后传递](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=486) [这个例子中
梯度原语为SoftMax](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=489) [要用到链式法则](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=494) [链式法则允许反向传播梯度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=495) [通过网络向后走](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=498) [同时计算梯度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=500) [以更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=502) [因此权重的增量很小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=504) [在每次迭代中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=507) [然后用更新后的权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=511) [进行下次训练迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=513) [希望误差值会变小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=515) [这是我们努力的方向](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=518) [实际上
在任何训练场景中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=523) [不可能只处理一张图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=526) [而是处理
一组或一批图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=529) [比如32或64的批大小](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=532) [还要有相应的一批标签](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=535) [用于计算损失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=539) [用于计算损失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=539) [这个例子里
我们有一批标签](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=540) [正确类的值为1
其他为0](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=543) [每个训练场景](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=549) [会使用不同的批图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=551) [和相应的一批标签](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=553) [现在就来运行
多次训练迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=556) [对第一批图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=561) [做正向传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=563) [计算损失
然后梯度传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=565) [再更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=568) [那么第二批呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=570) [完全一样的流程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=572) [正向传播
然后计算损失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=574) [梯度传播
再更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=576) [训练迭代过程中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=580) [我们希望网络的损失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=583) [能降低](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=585) [网络准确度能提高](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=586) [所以继续训练
直到损失降到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=589) [某个阈值以下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=592) [网络的准确度
就达到了理想水平](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=594) [这时我们就知道网络已训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=598) [这时我们就知道网络已训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=598) [我们可以用
已训练的参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=600) [去推断了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=603) [现在看几个必要步骤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=604) [Metal性能着色器框架(MPS)
训练神经网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=607) [神经网络通常会用
图形抽象来表示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=612) [MPS中的神经网络就以图形描述](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=616) [第一步就是创建训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=620) [我们要准备好输入数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=624) [确定权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=626) [然后执行训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=627) [运行正向路径](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=629) [计算损失、梯度传播
再更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=631) [训练是一个迭代进程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=635) [训练网络需要多次迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=638) [因此还要知道
什么时候停止训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=641) [现在就来研究每个课题的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=644) [具体内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=646) [首先是创建训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=647) [我说过MPS中
神经网络是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=652) [一个图形
通过神经网络图形API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=656) [这是可视化的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=659) [这是可视化的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=659) [手写数字识别网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=661) [这个图形里](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=664) [你能看到图像节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=666) [就是白色的小节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=667) [图像节点用于数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=670) [输入输出和所有中间结果](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=673) [它们描述了不同操作时
数据的移动情况](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=678) [然后处理数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=682) [比如卷积或池化](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=684) [以过滤节点表示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=687) [我们支持所有必要的节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=690) [以创建常用的神经网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=693) [现在看看怎么简单地](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=697) [使用神经网络图形API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=699) [这个例子就是
如何创建MPSImageNode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=701) [通过神经网络图形API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=706) [这是如何创建卷积节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=708) [通过图形API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=711) [对于每个正向节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=713) [提供相应的训练梯度节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=715) [只要一行代码
就能创建梯度节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=719) [只要一行代码
就能创建梯度节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=719) [对应正向节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=722) [这个例子展示了
如何创建梯度卷积节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=724) [基于卷积节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=728) [现在创建整个图形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=733) [这里有个很小的网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=736) [一个卷积节点
接着一个池化节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=738) [随后是另一个卷积节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=741) [怎样连接这些节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=743) [到图形中？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=746) [很简单](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=747) [我们将结果节点
不对](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=749) [一个节点的输出图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=752) [以源图片形式
传递到后续节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=754) [这就形成全连接图形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=758) [现在创建训练图形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=762) [首先在图形中
添加损失节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=765) [再添加梯度节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=770) [我说过 只要一行代码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=772) [就能创建梯度节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=774) [对应正向节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=776) [然后跟之前一样连接它们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=778) [然后跟之前一样连接它们](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=778) [完整的训练图就做好了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=780) [通过这个例子 你能看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=785) [图形API简单易用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=787) [训练图可以自动做很多事](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=791) [它能处理所有中间结果](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=793) [甚至输出图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=796) [它能最小化网络的内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=799) [通过将所有的中间图像折叠](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=802) [借助Metal堆](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=806) [它还能融合图形节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=808) [例如它可以融合
批标准化和网络节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=810) [它还能优化away节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=814) [比如优化切割
nation节点的方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=816) [它还可以自动处理填充](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=820) [管理状态对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=823) [这些稍后会讲到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=825) [所以请好好利用图形API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=827) [了解如何创建训练图后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=834) [现在看看
要传递给训练图的输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=837) [现在看看
要传递给训练图的输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=837) [这里就要讲到编码命令](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=842) [将图形编码到GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=844) [我说过 我们不会只发送一张图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=849) [给每次训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=851) [我们要处理一组或一批图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=853) [那么输入数据之一](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=856) [就是一批图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=858) [你一定记得每批图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=860) [都对应一批标签 用于计算损失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=863) [计算损失的标签
以状态形式传递给训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=869) [代码命令也会把一批状态作为输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=874) [现在来讲讲批和状态](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=878) [是什么意思？
首先是批](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=881) [批是一组图像或状态](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=884) [这是我们今年特地为训练增加的支持](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=888) [现在有两个新的MPS类型可用
MPSImageBatch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=892) [和MPSStateBatch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=896) [下面这个例子
告诉你如何用我们的API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=898) [下面这个例子
告诉你如何用我们的API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=898) [创建单张图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=901) [用现有的Metal纹理创建图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=904) [这个例子展示了如何使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=908) [API创建批图像
再附加一张新图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=910) [传给训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=914) [状态对象是什么？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=918) [MPS状态是不透明的数据容器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=921) [训练中 常要用它捕捉](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=925) [正向节点的状态](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=929) [在调用时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=931) [所以它之后可以用作梯度节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=932) [训练图会处理所有状态对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=937) [所以作为开发者](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=939) [你一般不用担心状态](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=940) [但了解下工作原理也不错](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=943) [我们用具体例子说明](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=944) [回到上个手写数字识别网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=949) [特别注意下退出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=953) [和退出梯度节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=955) [正向退出节点
减少或清零](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=960) [以某个特定概率输入值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=963) [退出状态对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=967) [捕捉正向退出处理的信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=969) [之后可用于梯度节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=973) [因为它清零](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=977) [输出梯度值的位置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=979) [与正向清零的位置一样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=983) [所以我说你不用担心状态](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=988) [训练图都会帮你处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=991) [但是由于计算损失的标签](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=993) [以状态的形式传递给训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=996) [而且需要用户输入数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=999) [就是标准值或正确结果](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1000) [你需要创建一批标签用于计算损失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1004) [再输入给训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1007) [下面这个例子
将展示如何创建单个标签](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1010) [用于计算损失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1013) [首先要创建损失数据描述符](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1015) [描述标签数据在内存里的情况](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1017) [描述标签数据在内存里的情况](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1017) [然后创建
MPSCNNLossLabel对象](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1021) [用这个描述符](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1025) [然后创建批对象用于训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1028) [GPU运行完图形后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1030) [批标签会包含每张图像的损失值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1033) [对这批图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1037) [你检查这些值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1039) [或计算一个单一值给整个批](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1040) [再检查那个值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1043) [那么现在有了训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1047) [下面就是如何输入数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1049) [我们看看如何将权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1052) [添加到需要权重的图形节点上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1054) [唯一能添加权重给卷积、全连接](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1059) [批归一化和实例正则化节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1062) [是通过数据源提供器协议](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1067) [这个例子就是如何创建卷积节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1070) [通过数据源提供器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1073) [你需要部署一个符合协议规则的类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1076) [你需要部署一个符合协议规则的类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1076) [这里就叫做MyWeights](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1080) [数据源提供器在许多方面都很好用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1084) [比如](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1088) [如果在网络里你有许多卷积节点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1089) [网络的整体权重会相当可观](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1093) [但我们并不想让所有卷积节点的权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1096) [同时存入内存](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1100) [我们希望网络的内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1102) [越低越好](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1105) [数据源提供器就派上用场了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1107) [因为它们能及时载入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1110) [和清除权重数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1112) [所以我们加载权重给一个卷积核](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1115) [在处理时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1118) [清除它们后
才继续下一次卷积](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1120) [MyWeights这样实施](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1126) [你要提供](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1129) [初始化方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1131) [拉入内存并做好准备](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1133) [然后训练图会调用load函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1136) [当purge函数被调用时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1139) [当purge函数被调用时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1139) [权重就被释放了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1141) [数据源提供器对训练也很重要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1143) [这个我们稍后讲](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1146) [那么我们有了训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1151) [也准备好了输入和具体权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1153) [就可以在GPU上执行图形了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1156) [要在GPU上执行训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1160) [首先要完成Metal设置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1162) [我们要初始化训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1165) [准备好输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1167) [开始在GPU上训练网络吧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1169) [训练是迭代进程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1175) [因此要设置训练回路](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1178) [通常我们要执行训练图
经过几个轮次](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1180) [轮次次数是总次数…](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1184) [是对整个数据集的迭代次数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1188) [每个轮次应该有多个迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1191) [所以迭代的次数是图像总数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1194) [在数据集中
除以批大小32或64](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1197) [在数据集中
除以批大小32或64](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1197) [现在我们来看每次训练迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1202) [每次训练迭代中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1207) [我们对一批图像编码用于训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1209) [但我们不想让CPU等GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1213) [跑完一次训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1216) [处理一批图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1220) [然后CPU才开始编码
commandBuffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1221) [给下一次图形运行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1225) [我们希望CPU和GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1227) [同时工作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1229) [为此我们要用到双缓冲](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1231) [那么设置中
我们要创建](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1234) [计数信号量
初始值为2](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1237) [这是因为我们只要
2个编码同时运行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1240) [然后在输入
训练迭代函数时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1245) [就会调用信号量权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1248) [进行自减](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1250) [当计数值减到0](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1252) [就等待
否则就继续](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1256) [之后对图形编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1259) [之后对图形编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1259) [编码命令即刻返回](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1261) [用户指定的回调函数会被调用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1264) [在GPU完成图形运行的时候](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1266) [这样我们就知道GPU运行完了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1269) [CPU可以继续为GPU工作编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1272) [就是之前在信号量上
等待处理的部分](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1277) [为什么使用双缓冲呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1281) [为什么不能同时对GPU的
多次运行进行编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1282) [因为编码命令用时少](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1288) [命令缓冲比运行训练图快](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1291) [所以不会编码
多次训练图执行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1293) [为了减少内存占用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1296) [我们讲过了如何执行训练图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1301) [执行图形时 我们做正向传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1303) [计算损失 再梯度传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1306) [然后图形会更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1309) [现在说说权重更新](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1311) [我说过数据源提供器很重要](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1315) [对训练而言](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1319) [对训练而言](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1319) [所有权重更新都使用可选的更新方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1321) [通过数据源提供器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1324) [图形自动调用更新函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1327) [那么更新权重的步骤都有哪些呢？](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1331) [来看一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1333) [回想在梯度传播阶段的梯度计算](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1337) [在每个训练场景](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1340) [添加少许增量给权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1342) [如何将增量分配给权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1345) [由优化器决定](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1347) [它只是个函数将原来的权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1350) [和计算过的梯度作为输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1353) [输出更新后的权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1355) [优化器要在更新函数中使用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1361) [在数据源提供器内](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1363) [我们也支持几种不同的变体](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1365) [来更新GPU权重
包括Adam](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1367) [StochasticGradientDescent
和RMSProp](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1371) [你甚至可以自定义
权重更新步骤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1374) [那么就来看看
如何在MPS中使用优化器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1379) [那么就来看看
如何在MPS中使用优化器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1379) [你记得数据源提供器
有个init函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1386) [这里就是创建优化器的地方](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1389) [因为你只需要创建一次](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1392) [现在看看如何执行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1395) [更新函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1397) [更新函数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1399) [接收源状态
和梯度状态为输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1400) [源状态包含原始权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1406) [梯度状态
包含计算过的梯度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1408) [现在就能用这个数据
编码优化器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1411) [最后一步是将源状态返回](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1414) [其中是更新后的权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1417) [很简单吧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1419) [现在还有最后一步](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1423) [我说过 训练时迭代进程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1426) [训练网络需要多次迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1428) [你要知道何时停止训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1432) [现在就来讨论下
这个决定应该如何做](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1435) [以训练循环为环境](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1438) [以训练循环为环境](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1438) [这是训练回路](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1443) [正在训练神经网络
包含几个轮次](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1445) [为确定何时停止训练
需要一个测试图集](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1449) [测试图集内的图像不是用于训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1453) [只用于评估
网络的准确度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1458) [每个轮次后
你可以选择等待图形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1462) […等待GPU
停止运行图形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1466) [然后使用当前的已训练的参数](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1469) [初始化推断网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1473) [然后在测试图集上
运行推断网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1476) [你可以选择停止训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1480) [当测试集显示
网络精确度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1482) [达到某个水平时](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1485) [我们已经讨论过所有步骤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1490) [关于在MPS训练神经网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1492) [是时候展示一下了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1496) [平台状态汇总中提过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1498) [平台状态汇总中提过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1498) [Metal性能着色器框架可以驱动](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1502) [Core ML、Create ML
和Turi Create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1506) [Turi Create
是一款简单易用](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1510) [灵活且高性能的工具组
用于创建CoreML模型](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1513) [以完成一些任务
如图像分类](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1518) [对象检测和推荐等等](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1521) [有关Turi Create的
更多信息](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1525) [请查看“Turi Create
指南”的演讲视频](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1527) [我们准备了一个演示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1532) [用一个…
训练一个对象检测网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1534) [通过MPS驱动的
Turi Create完成](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1539) [平台状态汇总中提到过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1543) [用MPS的速度比不用快9倍](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1546) [对象检查网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1550) [在被识别的对象周围绘制边框](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1552) [这个演示中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1561) [我用的MacBook Pro
连接了外部GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1564) [Turi Create
在MacBook Pro上运行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1569) [外部GPU用MPS训练网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1573) [这个例子可以很好地演示
如何使用外部GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1578) [提高MacBook Pro的
计算能力](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1582) [我们使用的外部GPU
是AMD Vega GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1585) [在演示配置中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1589) [我已经导入
Turi Create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1590) [并提前加载了
对象检测网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1592) [还有一个训练数据集](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1596) [那么现在开始](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1597) [训练网络用十次迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1600) [现在整个对象检测网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1604) [所有的原语
优化器和权重更新方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1607) [所有的都在外部GPU上运行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1612) [好了 十次训练迭代已完成](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1618) [好了 十次训练迭代已完成](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1618) [也许十次迭代不足以完成
该网络的训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1621) [但在此我们就这样吧](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1623) [我现在要做的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1626) [是加载一个提前训练过的网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1627) [用来运行测试图集](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1631) [展示部分结果](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1633) [看一下](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1634) [好了 这是香蕉](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1638) [分类十分正确](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1640) [而且画上了边框](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1642) [这么美好的早餐
一杯咖啡和一个牛角包](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1644) [还有一枚不好看的鸡蛋](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1649) [以上就是
Turi Create的演示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1654) [谢谢大家](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1663) [现在换个话题
谈谈递归神经网络的训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1667) [首先简单讲讲
什么是递归神经网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1672) [卷积神经网络的一大缺陷](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1677) [卷积神经网络的一大缺陷](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1677) [是它们无法记忆之前发生的事情](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1680) [它们可以接收一个输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1685) [例如图像
然后产生一个输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1686) [例如一组概率值定义图像内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1690) [RNN就不一样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1696) [它能记忆](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1699) [它们善于处理
连续的输入和输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1699) [比如它们可以用一组概率值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1704) [也就是图像内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1707) [CNN产生的结果](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1709) [然后产生一序列输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1711) [就是一序列文字
作图片的说明](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1713) [它们也可用一组输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1718) [比如文字序列就是一个句子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1720) [产生一组输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1724) [句子没变
但被翻译为另一种语言](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1726) [比如俄语或芬兰语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1731) [我们支持几个不同的RNN](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1734) [最常用的一个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1738) [是长短期记忆RNN](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1740) [简称LSTM](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1742) [去年WWDC演讲中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1744) [我们讲过大量关于
LSTM门结构的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1746) [演示过LSTM推断过程](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1750) [所以请查看那场演讲
了解更多关于LSTM推断的内容](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1753) [今年新增的训练支持](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1759) [所有这些RNN](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1762) [本场演讲中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1765) [我会讲到LSTM的训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1766) [看个具体例子](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1772) [这是一个活动分类网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1774) [以动作感官数据为输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1777) [就是读取传感器数据
比如加速传感器或陀螺仪](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1780) [网络然后使用这些数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1785) [识别用户所做的运动](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1787) [比如我们想确定用户是在骑行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1791) [滑雪还是散步](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1794) [你看到网络的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1799) [你看到网络的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1799) [配置很有趣](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1802) [它含有一系列CNN原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1803) [随后是LSTM原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1808) [再后面是更多的CNN原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1810) [为什么这样设置？
我们来一窥究竟](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1812) [尽管输入的是感官数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1816) [但显示的是一批1D图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1820) [6个特征通道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1823) [一个特征通道
用于读取加速传感器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1824) [和陀螺仪上的数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1828) [每张1D图像为2000像素](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1830) [你可以将它们当作即时样本](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1834) [因为我们要识别的动作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1837) [是随时发生的](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1840) [然后通过1D卷积原语
传递这些图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1844) [它将2000个样本压缩到20个](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1849) [但它要占用几个特征通道](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1856) [这样就不会丢失
数据中的任何特征](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1858) [这样就不会丢失
数据中的任何特征](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1858) [然后新的数据图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1863) [被传递给LSTM原语
是长度为20的序列](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1866) [然后运行20个LSTM迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1870) [于是LSTM处理的
是长度为20的序列](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1872) [而不是2000](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1875) [而且是更高级的数据特征表达](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1877) [后面还有几个CNN原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1882) [精细化数据特征](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1885) [序列的最后一个原语
是SoftMax](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1889) [分配概率值给不同的动作类别](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1893) [这就是网络的输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1896) [现在看看怎样训练它](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1898) [我们还是需要一个损失原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1902) [将网络的输出](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1905) [和标签作为输入](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1906) [然后是下半部分图形](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1908) [在下半部分还是梯度原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1911) [对应正向原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1914) [包括LSTM原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1916) [那么训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1919) [那么训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1919) [先是运行网络正向传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1921) [然后计算损失](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1924) [然后梯度传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1927) [计算梯度用于更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1929) [这个设置很像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1932) [CNN训练的设置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1935) [最后一步当然也是更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1937) [大家知道LSTM也有权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1939) [也需要更新](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1942) [现在看看在MPS中
如何训练这个网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1946) [首先来看
如何创建LSTM 层](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1950) [用我们的框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1953) [第一步是创建LSTM层级描述符](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1956) [用初始训练参数
初始化描述符](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1960) [通过数据源提供器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1964) [初始的训练参数是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1966) [随机的小数字或检查点值](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1968) [训练中描述符的设置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1972) [跟推断完全一样](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1974) [我们以前讨论过层描述符的设置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1978) [我们以前讨论过层描述符的设置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1978) [在去年的WWDC演讲
内容十分详实](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1981) [所以推荐大家去看那场演讲了解更多](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1985) [关于LSTM
层描述符的设置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1988) [有了描述符之后](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1991) [就要用它来创建LSTM训练层](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1993) [MPS会添加训练权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1999) [使用描述符定义的数据源](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2002) [还需要一些矩阵](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2006) [实现梯度计算](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2008) [你要用
createWeightGradientMatrices](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2010) [API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2013) [在训练层上
创建这些矩阵](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2014) [然后训练权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2017) [会被用于正向和梯度传播中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2019) [然后被传递给优化器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2022) [与计算好的梯度一起用于更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2024) [现在要准备一些输入和输出
用于训练LSTM](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2029) [这个例子展示了如何创建](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2034) [矩阵去管理输入和输出序列](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2036) [在正向和梯度传播中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2039) [在正向和梯度传播中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2039) [每个需要20个矩阵](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2042) [这是如何初始化矩阵数据](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2045) [现在就可以训练活动分类网络了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2051) [用MPS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2055) [这个代码样本中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2056) [我只强调LSTM过滤器](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2057) [因为时间有限](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2060) [在正向传播中
运行20矩阵的序列](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2063) [正向通过LSTM训练层](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2066) [然后反向传播](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2069) [运行20个矩阵的序列
经过LSTM层](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2071) [计算梯度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2074) [现在已有训练权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2076) [计算好的梯度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2079) [就可以将它们传递到
优化器去更新权重](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2080) [最后我要补充一点](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2085) [卷积神经网络对图像的处理](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2089) [和对LSTM的运行是基于矩阵](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2092) [我们会提供便利内核给这个框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2096) [方便来回转换图像和矩阵](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2099) [方便来回转换图像和矩阵](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2099) [那么要复制](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2103) [一张图像到矩阵](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2105) [需要使用
MPSImageCopyToMatrix内核](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2106) [这是创建方法](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2110) [以及如何给一批图像编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2112) [目的矩阵的每行都含有一个源图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2117) [要从矩阵复制到图像](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2123) [需要内核
MPSMatrixCopyToImage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2125) [这一部分是创建](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2129) [这部分是在GPU上编码](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2130) [大家已经了解了如何使用MPS
训练CNN和RNN](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2135) [也看过了
Turi Create的演示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2141) [现在由MPS驱动](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2144) [现在再看一个演示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2146) [我们在与Google合作](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2149) [添加Metal性能着色器框架](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2151) [给TensorFlow…](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2154) [以提升macOS机器学习的速度](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2157) [也给大家带来了动态演示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2159) [也给大家带来了动态演示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2159) [具体来说 我们要演示的是](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2161) [训练InceptionV3
对象分类网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2163) [使用TensorFlow
驱动是MPS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2168) [这个演示中](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2171) [我还是使用MacBook Pro
外接一个GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2174) [TensorFlow
在MacBook Pro上](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2179) [外部GPU
用MPS训练网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2183) [演示设置](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2187) [我己安装了
TensorFlow](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2189) [也预先加载了
InceptionV3网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2191) [和训练数据集](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2194) [现在训练网络30次迭代](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2196) [你看速度多快](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2201) [同样 整个网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2203) [所有原语
优化器和权重更新步骤](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2204) [都是在外部GPU上运行](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2208) [这就完成了](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2210) [大家看到](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2212) [训练速度大概是
每秒100张图](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2213) [平台状态汇总中说过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2217) [平台状态汇总中说过](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2217) [训练InceptionV3网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2221) [用MPS驱动的
TensorFlow](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2224) [要比不用MPS
快20倍](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2226) [以上就是TensorFlow演示](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2231) [谢谢大家](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2236) [现在做个总结](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2242) [今年新添加了
FP16计算](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2244) [给卷积和卷积转置原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2248) [提升CNN推断的性能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2251) [我们还添加了GPU加速原语](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2255) [用于训练神经网络](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2257) [这些原语都已优化
可用于iOS和macOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2259) [我们还为训练添加了
神经网络图形API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2264) [简化了GPU上对神经网络的训练](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2268) [并让我们可以](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2271) [让不同的GPU
都达到最佳性能](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2273) [本场演讲的更多信息
相关资源的链接](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2278) [本场演讲的更多信息
相关资源的链接](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2278) [请访问开发者网站](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2282) [在明早9点的
Metal机器学习实验室](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2285) [希望能见到你们
欢迎参加](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2289) [谢谢大家的到来
愿你们在WWDC中度过美好时光](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2293)