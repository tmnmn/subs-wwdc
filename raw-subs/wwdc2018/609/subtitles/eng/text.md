# Metal for Accelerating Machine Learning

## Summary
Metal Performance Shaders (MPS) includes a highly tuned library of machine learning primitives leveraging the tremendous power of the GPU. With iOS 12 and macOS Mojave, MPS adds capabilities to accelerate the computationally intensive task of training a neural network. Learn performance optimizations for inference, and understand the training process for both convolutional and recurrent neural networks (CNNs and RNNs).

## Info
* Developer Tools
* WWDC 2018 - Session 609 - iOS, macOS, tvOS
* https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/

## Text
 [[ Music ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=7) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=21) [&gt;&gt; Good afternoon, everyone.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=28) [Welcome to our talk on Metal for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=31) [Accelerating Machine Learning.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=33) [My name is Anna Tikhonova, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=35) [I'm an Engineer on the GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=37) [Software Team.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=38) [The Metal Performance Shaders](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=42) [Framework is built on top of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=44) [Metal.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=45) [And it provides GPU accelerated](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=46) [primitives that are optimized](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=48) [for both iOS and macOS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=50) [We provide primitives for image](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=52) [processing, linear algebra, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=54) [machine learning.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=56) [We talked extensively about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=58) [We talked extensively about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=58) [inference in our past WWDC](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=60) [sessions, so I just want to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=61) [highlight them here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=63) [And this year, we've also added](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=66) [support for training on both iOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=68) [and macOS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=70) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=72) [Thank you.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=75) [We've also added support for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=78) [accelerated ray tracing on our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=80) [platform, and we had an entire](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=81) [session on this topic earlier](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=83) [this week.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=85) [So, it was titled Metal for Ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=86) [Tracing Acceleration.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=88) [And the video for the session](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=89) [will be available online](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=91) [shortly.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=92) [In this session, I will talk](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=94) [primarily about machine](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=95) [learning, specifically training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=96) [So, I mentioned training and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=99) [inference.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=103) [Deep learning algorithms consist](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=104) [of these two phases.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=106) [The first phase is the training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=107) [phase.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=109) [So, let's use an example where](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=110) [we want to train a model, to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=112) [categorize images into classes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=113) [like cats, dogs, giraffes,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=116) [etcetera.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=118) [So, in order to train a model to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=120) [recognize cats, we need to feed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=122) [it a large number of labeled](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=123) [images of cats.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=125) [And same for the rabbits and all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=127) [of the other animals you want](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=129) [your model to be able to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=130) [recognize.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=131) [Training is a computationally](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=132) [expensive and time-consuming,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=135) [iterative process.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=137) [The result of training are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=139) [trained parameters.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=140) [The trained parameters are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=143) [required for the next phase, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=145) [inference phase.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=147) [This is when your model is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=148) [presented with a new image, that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=150) [is never seen before, and it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=151) [needs to classify it based on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=153) [the trained parameters.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=154) [This is a cat.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=156) [We now provide GPU acceleration](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=158) [for both the training and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=160) [inference phases.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=161) [But before I talk about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=163) [training, let me tell you about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=166) [some enhancements to CNN](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=168) [Inference we've added this year.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=169) [We now have support for FP16](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=171) [accumulation for the convolution](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=173) [and convolution transpose](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=176) [primitives.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=177) [This new feature is available on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=178) [This new feature is available on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=178) [devices with an Apple A11 Bionic](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=180) [GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=182) [We find that using FP16](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=184) [accumulation for inference](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=186) [workloads is more than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=187) [sufficient in terms of precision](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=189) [for many commonly used neural](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=191) [networks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=193) [FP16 accumulation offers better](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=195) [precision and significant power](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=197) [benefits.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=199) [So, please take advantage of it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=200) [in your inference workloads.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=202) [And this is an example of how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=205) [you can enable FP16 accumulation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=206) [for a convolution primitive.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=209) [You just need to set the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=210) [accumulatorPrecisionOption](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=211) [property.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=213) [And now, let's talk in depth](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=216) [about the main topic of this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=218) [session, training neural](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=220) [networks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=221) [And let's start with training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=223) [convolutional neural networks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=224) [So, here we have a simple,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=228) [handwritten, digit recognition](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=230) [network that takes an image of a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=231) [handwritten image as input, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=234) [assigns it to one of 10 classes,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=237) [from 0 to 9.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=239) [from 0 to 9.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=239) [In this example, we are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=240) [correctly classifying this image](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=242) [as an image of a digit 7.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=244) [For inference, we initialize our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=247) [network with trained parameters.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=251) [So, in this example, the trained](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=254) [parameters add the weights for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=255) [the convolution, and fully](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=256) [connected primitives.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=258) [The goal of a training algorithm](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=260) [is to compute these trained](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=261) [parameters, so the network can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=263) [use them to map inputs to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=264) [correct outputs during](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=266) [inference.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=267) [When we start the training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=269) [process, we don't have any](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=271) [weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=272) [We need to compute them.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=273) [So, the first step is to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=274) [initialize the weights with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=277) [small, random numbers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=278) [And now we are ready to train](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=280) [this network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=281) [So, let's take a look at all the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=281) [steps involved in a training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=283) [process.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=284) [Training is an iterative](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=287) [process, and each iteration of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=289) [training can be divided into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=291) [four steps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=292) [The first step is the forward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=293) [pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=295) [This is when we take an input](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=296) [and pass it to our network to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=297) [produce an output.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=299) [produce an output.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=299) [It's very similar to inference.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=301) [And next, we need to compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=304) [loss.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=305) [So, loss intuitively measures](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=306) [the difference between the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=308) [network's output and the ground](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=309) [truth.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=310) [The objective of a training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=313) [algorithm is to minimize loss.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=314) [Our next step is the gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=317) [pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=321) [This is when we propagate this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=321) [difference when the network's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=322) [output and the ground truth,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=324) [back to the network to update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=326) [weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=328) [The idea is that as training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=329) [continues, our network is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=332) [becoming better trained, so it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=334) [better able to map inputs to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=335) [correct outputs, which in turn](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=337) [helps to minimize loss.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=340) [So, this is an overview and now](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=342) [let's take a look at each one of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=345) [these steps in more detail.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=346) [The forward pass involves](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=347) [propagation forward to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=351) [network, to compute an output.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=353) [As you can see, during this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=356) [first situation of training, our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=357) [network is not doing so well.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=359) [network is not doing so well.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=359) [It's outputting a result that's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=361) [clearly wrong.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=363) [So, why is it doing so badly?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=363) [Well, this is expected.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=365) [We just initialized our weights](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=366) [with some random numbers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=368) [We haven't trained the network](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=369) [to do any better yet.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=371) [So, now, we need some weight to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=373) [quantify how well or how badly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=375) [our network is currently doing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=378) [So, we can use this information](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=380) [to improve our weights, so that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=382) [hopefully after more iterations](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=384) [of training, the network can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=385) [produce a better result.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=387) [But in order to know how well](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=388) [we're doing, we need to know](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=391) [what the right answers are.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=393) [So, the ground truth, which I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=394) [will call labels from now on, is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=396) [an input to the network along](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=398) [with the input image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=400) [So, in this case, it's a vector](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=402) [of 10 values, where we have 1](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=403) [for the correct class, Class 7,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=405) [and zeros for all the other](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=407) [classes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=409) [The output of the network is our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=411) [10 probabilities.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=413) [One per class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=414) [So, as you can see in this first](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=416) [situation of training, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=418) [network is producing a very low](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=419) [network is producing a very low](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=419) [result for the correct Class 7,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=421) [and it's assigning the highest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=423) [probability to a Class 9, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=425) [is why the network is returning](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=427) [9 as the answer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=428) [So, now we take all of this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=431) [information and we pass it to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=432) [our loss primitive.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=434) [And as I mentioned previously,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=436) [loss measures the difference](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=441) [between the network's output and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=443) [the ground truth.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=445) [And the objective of a training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=447) [algorithm is to minimize loss.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=448) [And now, we also need the second](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=452) [half of the graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=453) [The second half of the graph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=456) [contains gradient primitives for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=457) [each responding forward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=460) [primitive.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=461) [The gradient primitives compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=463) [gradients that are needed to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=465) [update weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=467) [So, the loss primitive computes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=469) [the first gradient, which is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=472) [derivative of a chosen loss](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=474) [function with respect to its](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=476) [inputs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=477) [And then we take this gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=478) [and back propagate it, backward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=480) [through the network, backward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=482) [through the first gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=484) [primitive in the backward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=487) [direction.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=488) [In this case, it's the SoftMax](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=489) [gradient primitive.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=492) [And we use the Chain Rule to do](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=494) [that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=495) [So, the Chain Rule allows us to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=495) [back propagate gradients,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=496) [backwards through the network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=498) [And we're computing these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=500) [gradients so that we can update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=501) [weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=503) [So, we're computing very small](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=504) [deltas to apply to the weights,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=505) [in each iteration of training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=508) [And then we can use these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=509) [updated weights in the next](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=512) [iteration of training, to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=514) [ideally produce a lower loss](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=516) [value, which is what we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=517) [trying to minimize.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=518) [In practice, any situation of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=523) [training, we're not going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=525) [operate on a single image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=527) [We're going to operate on a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=529) [group or a batch of images.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=530) [For example, a batch of size 32](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=532) [or 64.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=534) [And we need a corresponding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=535) [batch of labels, for loss](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=537) [computation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=539) [computation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=539) [So, in this case, we have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=540) [batch of labels, was 1 for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=542) [correct class and zeroes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=544) [everywhere else.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=545) [And in each situation of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=549) [training, we're going to use a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=550) [different batch of images and a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=552) [responding batch of labels.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=554) [So, let's now run through](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=556) [several iterations of training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=557) [For the first batch of images,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=561) [we're doing a forward pass,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=563) [computing loss, and doing a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=565) [gradient pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=567) [And updating weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=568) [So, what happens with the second](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=570) [batch?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=571) [Exactly the same process.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=572) [The forward pass, then we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=574) [compute loss, to the gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=575) [pass, and update weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=577) [And as we go through iterations](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=580) [of training, we want the loss](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=581) [for our network to decrease and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=584) [the accuracy of the network to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=587) [increase.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=588) [And we continue training until](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=589) [the loss falls below a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=591) [particular threshold and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=592) [accuracy of our network reaches](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=594) [a desired level.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=596) [And then we know that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=598) [network is fully trained and now](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=599) [network is fully trained and now](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=599) [we can use the computed trained](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=601) [parameters for inference.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=602) [And now, let's take a look at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=604) [the steps necessary to train a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=606) [neural network using the Metal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=608) [Performance Shaders Framework.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=610) [Neural networks are often](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=611) [described using graph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=613) [abstraction.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=614) [So, in MPS, we enable you to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=615) [describe your networks as a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=617) [graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=618) [So, the first step is to create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=620) [a training graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=622) [Then we need to prepare our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=624) [inputs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=625) [We need to specify weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=626) [And then we execute the graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=628) [So, we run the forward paths,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=629) [compute loss, do the gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=631) [pass, and update weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=633) [And training is an iterative](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=635) [process.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=637) [It can take many iterations to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=638) [train a network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=640) [So, we'll also need to know when](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=641) [we can stop training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=642) [So, let's now discuss each one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=643) [of these topics in more detail.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=645) [Let's start with creating a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=647) [training graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=651) [So, as I said, in MPS, we enable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=652) [you to describe your networks as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=654) [a graph using a neural network](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=656) [graph API.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=657) [So, here we again have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=658) [So, here we again have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=658) [visualization of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=660) [handwritten, digit recognition](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=662) [network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=663) [But in this visualization, you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=664) [can also see the image notes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=666) [They're the small white notes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=668) [The image notes are for your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=670) [data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=672) [For your input, your outputs,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=673) [and all of the intermediate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=675) [results.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=677) [They describe how data moves](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=678) [between different operations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=680) [And then, operations on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=682) [data, like convolution and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=684) [pooling, are described with your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=685) [filter nodes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=689) [We support all of the nodes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=690) [necessary to create commonly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=692) [used neural networks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=694) [And now, let's take a look at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=696) [how easy it is to use the neural](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=698) [network graph API.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=699) [So, here's an example of how you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=701) [can create an MPSImageNode using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=703) [the neural network graph API.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=707) [And this is how you would create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=708) [a convolution node using the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=709) [graph API.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=711) [And now, for every forward node,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=713) [we support a corresponding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=716) [gradient node for training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=718) [It takes a single line of code](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=719) [It takes a single line of code](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=719) [to create a gradient node from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=721) [the forward node.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=723) [So, here is an example of how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=724) [you can create a gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=725) [convolution node from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=727) [convolution node.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=728) [And now, let's build an entire](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=732) [graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=734) [So, here we have a very small](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=736) [network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=738) [We have a convolution node](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=738) [followed by a pooling node,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=739) [followed by another convolution](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=741) [node.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=742) [So, how do we connect these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=743) [nodes into a graph?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=745) [So, that's easy.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=747) [We take the result node of --](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=749) [the result image of one node and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=752) [pass it as a source image to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=754) [subsequent node.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=756) [And here we have an entire](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=758) [connected graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=760) [And now, let's build a training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=762) [graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=764) [So first, we need to add a loss](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=765) [node to the graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=767) [And now, let's add some gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=770) [nodes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=771) [So, as I said, it takes a single](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=772) [line of code to create a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=773) [gradient node from its](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=774) [corresponding forward node.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=776) [And then we connect them as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=778) [previously, and now you have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=779) [previously, and now you have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=779) [complete training graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=781) [So, as you can see from this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=785) [example, the graph API is very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=786) [simple to use.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=789) [The graph does a lot for you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=791) [automatically.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=792) [It manages all the intermediate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=793) [results, and even the output](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=794) [image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=797) [It minimizes the memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=799) [footprint of your networks, by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=801) [aliasing memory for all your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=803) [intermediate images, using Metal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=805) [heaps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=808) [It can also fuse graph nodes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=808) [For example, it can fuse batch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=810) [normalization and neural nodes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=812) [And it can optimize away nodes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=814) [For example, it optimizes the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=816) [way you can cut nation nodes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=818) [The graph also automatically](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=820) [handles padding and manages](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=821) [state objects for you, which we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=824) [will discuss later in this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=825) [session.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=826) [So, please take advantage of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=827) [graph API.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=829) [So, now that we know how to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=834) [create a training graph, let's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=835) [now take a look at the inputs we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=837) [now take a look at the inputs we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=837) [need to pass to the graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=840) [And for this, let's take a look](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=842) [at the encode call we will use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=843) [to encode the graph to the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=845) [So, as I already mentioned,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=848) [we're not going to send in one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=849) [image at a time for training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=851) [We're going to operate on groups](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=853) [or batches of images.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=854) [So, one of the inputs to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=856) [graph, is a batch of images.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=857) [And as you recall, for every](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=860) [batch of images, we also need a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=862) [corresponding batch of labels](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=864) [for loss computation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=866) [The labels for loss computation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=868) [are passed to the graph as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=871) [states.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=873) [So, the code call also takes a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=874) [batch of states as input.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=876) [And now, let's talk about these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=878) [batches and states.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=880) [What are they?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=881) [Let's start with batches.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=882) [So, batches are just arrays of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=884) [images or states.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=886) [We've added them this year](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=888) [specifically to support](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=889) [training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=890) [There are two new MPS types for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=891) [you to use: MPSImageBatch and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=893) [MPSStateBatch.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=896) [So, here's an example of how you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=898) [So, here's an example of how you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=898) [can create a single image, using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=900) [our API.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=901) [So, here we're creating one from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=904) [an existing Metal texture.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=905) [And this is an example of how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=907) [you can create a batch of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=909) [images, using our API and append](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=911) [a new image to the batch, so you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=913) [can pass it to the graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=915) [And now, what are state objects?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=918) [An MPS state is an opaque data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=920) [container.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=923) [In training, it's frequently](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=924) [used to capture a state of a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=927) [forward node, when it's called.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=929) [And so, it can later be used by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=932) [the gradient node.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=935) [So, the graph manages all of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=937) [state objects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=939) [So, as a developer, you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=939) [generally don't need to worry](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=941) [about states.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=942) [But it's nice to know how they](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=943) [work.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=944) [So, let's use a specific](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=944) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=946) [So, let's go back to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=948) [handwritten digit recognition](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=950) [network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=951) [And take a look specifically at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=952) [the drop-out and drop-out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=955) [gradient nodes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=956) [The forward drop-out node drops,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=960) [or it zeroes out, values in its](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=962) [input, with a certain](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=964) [probability.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=965) [And then, the dropout state](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=966) [object captures information](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=968) [about the forward drop-out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=970) [operation, so it can later be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=971) [used by the drop-out gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=974) [node because it used to zero out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=976) [values in its input gradient at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=979) [the exact same locations as was](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=982) [zeroed out by the forward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=984) [operation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=985) [So, as I said, you don't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=986) [generally need to worry about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=990) [states, because the graph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=991) [manages them.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=992) [But because the labels for loss](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=993) [computation are passed as states](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=995) [to the graph, and because they](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=997) [require user input.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=999) [So, that's your ground truth or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1000) [correct results.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1002) [You need to create a batch of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1004) [labels for loss computation and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1005) [pass this batch as input to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1007) [graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1009) [So, this is an example of how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1010) [you would create a single label](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1011) [for loss computation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1013) [You first need to create a loss](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1015) [data descriptor which describes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1016) [how the label's data is laid out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1018) [how the label's data is laid out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1018) [in memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1020) [And then you need to create an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1021) [MPSCNNLossLabel object, with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1023) [this descriptor.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1025) [And then you create a batch of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1026) [these for training, and when the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1029) [GPU's done running the graph,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1031) [your batch of labels will](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1033) [contain the per image loss](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1035) [values for the batch.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1036) [And you can inspect these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1038) [values, or you can compute a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1040) [single value across the batch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1041) [and inspect that value.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1042) [So, now that we have a training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1047) [graph and we talked about how to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1048) [provide inputs to our graph,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1050) [let's talk about how to provide](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1052) [weights to the graph nodes that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1054) [require weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1055) [The only way to provide weights](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1058) [to convolution fully connected,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1060) [batch normalization and instance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1062) [normalization nodes, is through](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1065) [data source provider protocols.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1067) [This is an example of how to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1070) [create a convolution node, with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1072) [a data source provider.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1074) [You need to implement a class](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1076) [that conforms to the protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1078) [that conforms to the protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1078) [We call it MyWeights in this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1080) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1081) [Data source providers are very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1082) [useful in many ways.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1086) [For example, if you have many](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1088) [convolution nodes in your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1090) [network, the overall size of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1092) [weights for the network can be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1094) [quite considerable.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1095) [And we do not want the weights](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1097) [for all of your convolution](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1098) [nodes to be in memory all at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1099) [same time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1101) [We want to keep the memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1102) [footprints of your networks as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1104) [low as possible.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1105) [And data source providers come](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1107) [into play here because they](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1108) [provide just in time loading and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1110) [purging of weights data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1113) [So, we load the weights for one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1115) [convolution kernel, when we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1117) [process it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1119) [And then we purge them before](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1120) [moving on the next convolution.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1121) [So, here's an implementation of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1123) [MyWeights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1127) [You need to provide an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1129) [initialization method that is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1131) [responsible for pulling in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1132) [memory and making it ready.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1134) [And then the graph will call the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1136) [load function.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1137) [And then when the purge method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1139) [And then when the purge method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1139) [is called, you can release the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1140) [weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1142) [Data source providers are also](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1143) [essential for training, and we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1145) [will discuss this later in this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1146) [session.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1148) [So, now that we have a training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1151) [graph and we've prepared our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1153) [inputs and specified weights,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1154) [we're ready to execute the graph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1156) [on the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1157) [To change the [inaudible] graph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1160) [on the GPU, we first need to do](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1161) [the usual Metal setup.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1163) [We need to initialize our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1165) [training graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1166) [So, we have prepared our inputs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1167) [And now, let's train a network](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1169) [on the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1171) [Training is an iterative](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1175) [process.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1176) [So, we want to set up a training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1178) [loop.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1179) [And we usually want to execute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1180) [our graph over a number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1182) [EPOCHS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1183) [The number of EPOCHS is the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1184) [total number -- is the number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1186) [times we want to iterate over](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1188) [our entire data set.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1189) [And we want there to be multiple](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1191) [iterations in each EPOCH.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1193) [So, the number of iterations is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1195) [the total number of images in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1196) [your data set divided by batch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1197) [size, like 32 or 64.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1199) [size, like 32 or 64.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1199) [And now, let's take a look at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1202) [each training iteration.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1203) [In each training iteration, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1206) [encode a batch of images for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1210) [training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1211) [But we don't want the CPU to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1213) [wait for the GPU to finish](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1214) [running one run of the graph,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1217) [with one batch of images before](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1220) [the CPU can start encoding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1222) [commands to the command buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1224) [for the next run of the graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1225) [We want the CPU and the GPU to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1227) [work concurrently.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1230) [And for this, we're going to use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1231) [double buffering.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1232) [So, in this setup, we're going](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1234) [to create a counting semaphore](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1236) [with an initial value of 2.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1239) [It's because we want only two](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1240) [encodes to be in flight at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1242) [same time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1243) [And then when we enter the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1245) [training iteration function,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1246) [we're going to call weight on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1248) [the semaphore.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1250) [That's decrementing it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1250) [So, if the value of the count](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1252) [has already been decremented to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1254) [zero, we wait.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1255) [Otherwise, we continue.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1257) [And then we encode our graph,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1259) [And then we encode our graph,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1259) [and the encode call returns](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1261) [immediately.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1262) [And a user specified callback is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1264) [called, when the GPU is done](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1266) [running the graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1267) [So, now we know.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1269) [The GPU is done running the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1270) [graph, and the CPU can continue](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1271) [encoding more work to the GPU,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1274) [work that was previously waiting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1277) [on the semaphore.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1279) [So, why are we using double](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1280) [buffering?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1282) [Why not encode more runs of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1282) [graph, to the GPU concurrently?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1284) [Well, it takes a lot less time](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1288) [to encode commands to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1290) [command buffer, than to run the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1291) [graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1293) [So, we don't want to encode too](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1293) [many runs of the graph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1295) [concurrently to minimize memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1296) [footprint.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1297) [Okay, we've talked about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1298) [executing the graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1302) [When we execute the graph, we do](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1303) [the forward pass, we compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1305) [loss, we do the gradient pass,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1307) [and the graph will also update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1309) [weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1310) [So now, let's talk about weight](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1311) [updates.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1313) [As I mentioned, data source](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1314) [providers are essential for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1317) [providers are essential for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1317) [training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1320) [All of your weight updates need](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1321) [to happen through an optional](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1322) [update method on a data source](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1324) [provider.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1325) [The graph will call the update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1327) [method automatically.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1328) [So, what does the weight update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1331) [step actually involve?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1332) [Let's take a look.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1333) [So, recall that we're computing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1336) [gradients during the gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1338) [pass that we can apply small](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1339) [deltas to the weights, in each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1341) [situation of training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1342) [How these deltas are applied to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1345) [the weights, is described by an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1346) [optimizer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1349) [It's just a function that takes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1350) [the old weights, the computed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1352) [gradients as input, and produces](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1354) [updated weights as outputs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1357) [You will use an optimizer in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1360) [update method of your data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1363) [source provider.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1364) [And we support a number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1365) [different variants of the weight](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1367) [update step on the GPU,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1368) [including Adam, Stochastic](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1370) [Gradient Descent, and RMSProp.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1372) [And you can even define your own](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1374) [custom update weight step if you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1377) [prefer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1378) [So now, let's take a look at how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1380) [to use an optimizer in MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1381) [So, recall that your data source](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1385) [provider has an init method.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1387) [This is where you want to create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1389) [your optimizer because you only](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1391) [want to create it once.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1392) [And now, let's take a look at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1394) [the implementation of our update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1396) [method.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1398) [The update method receives the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1399) [source state and gradient state](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1401) [as inputs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1403) [So, the source state contains](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1404) [the old weights, the gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1407) [state contains the computed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1409) [gradients, and now we can encode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1410) [our optimizer with this data,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1412) [and the last step is to return](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1414) [the source state, which now has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1416) [the update weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1418) [So, pretty simple.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1419) [And now we have just one more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1420) [step to discuss.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1424) [So, as I said, training is an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1426) [iterative process.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1427) [It can take many iterations to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1428) [train a network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1430) [And you will need to know when](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1432) [to stop training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1433) [So, let's now discuss how can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1435) [you make this decision in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1437) [context of your training loop?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1438) [context of your training loop?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1438) [So, here we again have our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1442) [training loop, where we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1444) [training a neural network for a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1445) [number of EPOCHS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1446) [To check whether you can stop](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1449) [training, you need to have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1450) [test set of images.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1451) [So, a test set of images](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1453) [contains images that are not](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1455) [used for training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1457) [They're only used to evaluate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1458) [the accuracy of your network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1459) [So, after each EPOCH, you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1462) [optionally wait for the graph to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1464) [-- for the GPU to stop running](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1467) [the graph, and then you can use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1468) [the current trained parameters](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1471) [to initialize an inference](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1473) [network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1475) [And then you can run this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1476) [inference network on your test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1478) [set, and you can optionally stop](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1479) [training when the accuracy of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1481) [your network on this test set,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1483) [reaches a particular level.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1485) [So, now that we've discussed all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1489) [of the steps that are necessary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1491) [to train a neural network in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1493) [MPS, it's time for a demo.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1495) [So, as was already mentioned in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1498) [So, as was already mentioned in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1498) [the platform State of the Union,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1500) [the Metal Performance Shaders](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1502) [Framework powers Core ML, Create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1503) [ML, and Turi Create.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1507) [To Turi Create is an easy to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1509) [use, flexible, high-performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1512) [tool set for creating Core ML](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1515) [models for tasks such as image](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1517) [classification, object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1520) [detection, recommendations, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1522) [more.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1524) [For more information on Turi](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1525) [Create, we want to refer you to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1526) [the A Guide to Turi Create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1528) [Session Video.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1529) [We've prepared a demo where we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1532) [will be using an -- we'll be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1534) [training an object detection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1536) [network in Turi Create powered](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1538) [by MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1540) [As was mentioned in the platform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1541) [State of the Union, this is nine](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1544) [times faster than without MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1547) [An object detection network](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1550) [draws bounding boxes around](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1552) [recognized objects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1554) [So, in this demo, I will be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1560) [using a MacBook Pro, with a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1565) [connected external GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1566) [I will be running Turi Create on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1568) [the MacBook Pro and I will use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1572) [an external GPU to train the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1574) [network with MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1576) [This is a great example of how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1578) [you can use an external GPU to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1580) [enhance the computational power](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1582) [of a MacBook Pro.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1583) [The external GPU we're using is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1584) [an AMD Vega GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1586) [So, in this demo setup, I've](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1589) [already imported Turi Create,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1590) [and preloaded the object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1592) [detection network, and a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1594) [training data set.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1596) [So, now let's train this network](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1597) [for 10 iterations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1601) [And now, the entire object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1603) [detection network, all the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1606) [primitives, the optimizer, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1607) [weight update step, everything](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1609) [is running on the external GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1612) [Okay, so we're already done with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1618) [10 iterations of training, it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1619) [10 iterations of training, it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1619) [would take more than 10](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1621) [iterations to train this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1622) [network, and we're not going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1623) [do this on stage.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1624) [But what I'm going to do right](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1626) [now, is to load a network that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1627) [we pretrained in advance, run it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1629) [on a test set of images and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1631) [visualize some of the results.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1633) [So, let's take a look.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1634) [Okay, so here we have a banana,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1636) [that's correctly classified as a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1640) [banana.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1641) [And we have a bounding box, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1642) [now we have a perfect breakfast](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1645) [of a cup of coffee and a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1646) [croissant, and very,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1647) [mean-looking egg.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1650) [Okay, so that's it for the Turi](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1652) [Create demo.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1655) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1658) [Thank you very much.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1663) [And now, let's switch gears and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1667) [talk about training recurrent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1669) [neural networks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1670) [But first, let's do a recap of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1671) [what are the recurrent neural](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1673) [networks?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1674) [One of the disadvantages of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1677) [convolutional neural networks is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1678) [convolutional neural networks is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1678) [their inability to remember](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1680) [anything that happened](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1682) [previously.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1683) [They can take one input, such as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1685) [an image, and generate a single](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1687) [output, such as a set of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1689) [probabilities of what is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1691) [depicted in the image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1692) [RNNs on the other hand, have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1693) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1699) [And they're good at operating on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1699) [sequences of inputs and outputs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1701) [For example, they can take one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1704) [set of probabilities, so what is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1706) [depicted in an image, which is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1707) [an output of a CNN, and generate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1709) [a sequence of outputs, which is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1712) [a sequence of words that make up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1713) [a caption for this image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1715) [They can also take a sequence of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1717) [inputs, such as a sequence of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1720) [words that make up a sentence](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1722) [and generate a sequence of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1724) [outputs which is a same sentence](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1725) [but translated to a different](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1729) [language.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1730) [For example, to ration or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1731) [finish.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1732) [With support, a number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1733) [different variance of RNNs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1736) [The most commonly used one is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1738) [The most commonly used one is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1738) [the Long Short-Term Memory RNN,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1740) [or LSTM for short.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1742) [In our last year's WWDC Session,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1744) [we talked extensively about the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1746) [gates inside LSTM and walked](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1748) [through a LSTM inference](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1751) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1752) [So, please refer to that session](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1753) [for more information on LSTM](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1755) [inference.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1757) [This year, we've added support](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1759) [for training, for all of these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1761) [variants of RNNs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1763) [And in this session, I'm going](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1765) [to talk about training LSTMs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1767) [So, let's use a specific](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1768) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1773) [So, here we have an activity](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1774) [classifier network which takes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1776) [motion sensory data as input.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1778) [For example, reading some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1780) [sensors like an accelerometer or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1782) [a gyroscope.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1784) [And then the network uses this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1785) [data to identify a physical](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1786) [activity performed by the user.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1789) [So, for example, we want to know](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1791) [if a user is cycling, skiing, or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1792) [walking.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1795) [As you can see, this network is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1796) [As you can see, this network is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1796) [set up in an interesting way.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1800) [So, it contains a series of CNN](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1803) [primitives, followed by LSTM](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1807) [primitive, followed by more CNN](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1809) [primitives.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1811) [So, why is it set up this way?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1812) [Let's take a look.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1813) [So, even though our input is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1816) [sensor data, it's represented by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1818) [a batch of 1D images with six](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1821) [feature channels.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1823) [So, one feature channel for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1824) [access in the accelerometer and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1826) [gyroscope readings.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1828) [And each 1D image has 2,000](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1830) [pixels.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1833) [And you can think of them as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1833) [samples in time because the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1836) [activity we're trying to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1838) [identify, occurs over time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1839) [And then we pass these images](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1843) [through a 1D convolution](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1846) [primitive which compresses these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1847) [2,000 samples, to just 20](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1851) [samples.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1853) [But it expends a number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1854) [feature channels, because -- so,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1857) [we're not losing any features in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1859) [we're not losing any features in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1859) [the data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1861) [And then, this new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1863) [representation of the data, is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1864) [passed to LSTM primitive as a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1866) [sequence of lengths 20.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1868) [And we ran LSTM for 20](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1870) [iterations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1871) [So, our LSTM is operating on a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1872) [sequence of lengths 20 instead](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1874) [of 2,000, so it's operating on a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1876) [higher-level feature](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1878) [representation of the data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1879) [And then we have additional CNN](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1881) [primitives that we find](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1884) [high-level features in the data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1886) [And the last primitive in this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1889) [network is the SoftMax primitive](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1890) [which generates probabilities](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1893) [for the different activity](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1894) [classes, which is the output of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1895) [the network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1897) [And now, let's take a look at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1898) [how to train this network.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1899) [So, we again need a loss](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1902) [primitive, which takes the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1904) [output of the network and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1905) [labels as input.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1906) [And then we need the second half](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1908) [of the graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1909) [So, in the second half of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1910) [graph, we again have gradient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1912) [primitives for the corresponding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1913) [forward primitives, including](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1915) [the LSTM primitive.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1917) [And now, for training, we do the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1919) [And now, for training, we do the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1919) [forward pass through the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1922) [network, then we compute loss,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1923) [and we do the gradient pass to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1927) [compute gradients that will be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1929) [used to update weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1931) [So, this is a very similar setup](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1932) [that we have for a CNN training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1935) [And the last step is of course](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1937) [to update the weights and as you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1938) [know, the LSTM also has weights,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1940) [so they need to be updated as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1942) [well.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1945) [And now, let's take a look at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1946) [how to train this network in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1947) [MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1949) [But first, let's take a look at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1950) [how we can create LSTM layer for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1951) [training using our framework.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1953) [So, first, you need to create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1956) [LSTM layer descriptor.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1958) [And we initialize the descriptor](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1960) [with initial training parameters](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1962) [using data source providers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1964) [So, these initial training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1966) [parameters are, use smaller](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1967) [random number or some checkpoint](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1969) [values.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1970) [The descriptor setup for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1972) [training, is exactly the same as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1973) [it is for inference.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1975) [And we discussed the layer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1978) [And we discussed the layer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1978) [descriptor setup in our last](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1980) [year WWDC session in a lot more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1982) [detail.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1984) [So, I want to refer you to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1985) [session for more information on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1986) [LSTM layer descriptor setup.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1988) [Once you have the descriptor,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1991) [the next step is to create LSTM](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1993) [training layer with this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1995) [descriptor.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1997) [MPS will populate training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=1999) [weights using the data sources](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2002) [specified in the descriptor.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2004) [And we also need to have some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2005) [matrices to hold the computed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2007) [gradients.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2009) [You will use the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2010) [createWeightGradientMatrices API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2011) [on the training layer to create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2014) [these matrices.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2016) [And then, the training weights](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2017) [will be used in a forward and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2019) [gradient passes and will be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2021) [passed to an optimizer along](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2023) [with the computed gradients,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2025) [job, to date, weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2026) [And now we need to prepare some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2027) [inputs and outputs for training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2030) [our LSTM.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2032) [So, here's an example of how you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2033) [can create the matrices to hold](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2035) [the input and output sequences](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2038) [for both the forward and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2039) [for both the forward and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2039) [gradient passes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2041) [You will need 20 matrices for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2042) [each one of those.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2043) [And here is how you would](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2045) [initialize these matrices with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2046) [data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2048) [And now, we are ready to train](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2049) [our activity classifier network](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2053) [in MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2055) [So, in this code example, I will](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2056) [be highlighting only the LSTM](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2057) [filter in the interest of time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2059) [So, in the forward pass, we ran](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2063) [a sequence of 20 matrices](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2064) [forward through the LSTM](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2066) [training layer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2068) [And then in the backward pass,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2069) [we ran a sequence of 20 matrices](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2070) [though the LSTM layer to compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2073) [gradients.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2074) [And now, you have the training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2076) [weights, and you have the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2078) [computed gradients, and you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2079) [pass them to an optimizer to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2081) [update weights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2083) [So, there's just one more thing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2084) [I'd like to mention.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2086) [[Inaudible] neural networks](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2089) [operate on images and LSTMs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2090) [operate on matrices.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2093) [And we'll provide convenience](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2095) [kernels in the framework to make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2097) [it easy to convert between](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2099) [it easy to convert between](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2099) [images and matrices.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2100) [So, in order to copy an image to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2102) [a matrix, you need to use the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2106) [MPI's Image Copy to Matrix](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2107) [Kernel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2109) [So, this is how you can create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2110) [one, and this is how you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2111) [encode one on a batch of images.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2113) [Here, each row in a destination](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2117) [matrix, will contain one source](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2119) [image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2121) [And to copy from a matrix to an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2123) [image, you need to use the MPS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2125) [Matrix Copy to Image Kernel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2127) [This is how you can create one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2129) [and this is how you encode one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2130) [to the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2132) [So, we just showed you how to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2134) [train CNNs and RNNs using MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2137) [We also showed you a demo of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2141) [Turi Create which is now powered](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2143) [by MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2145) [And now it's time for one more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2145) [demo.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2147) [We have been working with Google](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2149) [to add support to the Metal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2151) [Performance Shaders Framework to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2152) [TensorFlow to accelerate machine](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2154) [learning on macOS, and we would](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2158) [love to show you a demo of that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2159) [love to show you a demo of that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2159) [in action.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2160) [Specifically, we want to show](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2161) [you a demo of training the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2163) [InceptionV3 Object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2164) [Classification Network, using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2166) [TensorFlow, powered by MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2168) [So, for this demo, I will again](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2171) [be using a MacBook Pro with an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2175) [attached external GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2177) [So, I will be running TensorFlow](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2179) [on this MacBook Pro, and I will](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2181) [use an external GPU to train a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2184) [network using MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2185) [So, in this demo setup, I've](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2187) [already imported TensorFlow and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2189) [preloaded the InceptionV3](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2192) [Network and a training data set.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2194) [So, now, let's train this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2196) [network for 30 iterations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2197) [So, you can see how fast this is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2199) [going.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2202) [Again, the entire network, all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2203) [of the primitives, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2205) [optimizer, and the weight update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2206) [step, everything is running on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2207) [the external GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2209) [And we're already done.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2210) [And as you can see, the training](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2212) [rate is approximately 100 images](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2214) [per second.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2216) [So, as was stated in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2217) [platform State of the Union,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2219) [platform State of the Union,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2219) [training the InceptionV3](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2221) [Network, in TensorFlow powered](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2223) [by MPS, is up to 20 times faster](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2225) [than without MPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2229) [So, this is it for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2230) [TensorFlow demo.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2232) [Thank you very much.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2233) [And now, let's summarize this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2241) [session.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2243) [This year, we've added a FP16](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2244) [accumulation for the convolution](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2246) [and convolution transpose](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2249) [primitives to improve the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2250) [performance of CNN inference.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2253) [We've also added GPU accelerate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2255) [primitives for training neural](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2257) [networks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2258) [These primitives are optimized](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2259) [for both iOS and macOS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2261) [We've also added the neural](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2264) [network graph API for training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2265) [It makes it very easy to train](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2268) [neural networks on the GPU and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2270) [enables us to provide the best](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2272) [performance across different](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2274) [GPUs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2276) [For more information on this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2278) [For more information on this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2278) [session and links to related](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2280) [resources, please go to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2281) [developer website.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2282) [We have the Metal for Machine](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2285) [Learning Lab tomorrow at 9 a.m.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2287) [So, we would love to talk to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2289) [you.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2290) [So, please come talk to us.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2290) [And thank you for coming and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2292) [have a great WWDC.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/609/?time=2296)