# Testing Tips & Tricks

## Summary
Testing is an essential tool to consistently verify your code works correctly, but often your code has dependencies that are out of your control. Discover techniques for making hard-to-test code testable on Apple platforms using XCTest. Learn a variety of tips for writing higher-quality tests that run fast and require less maintenance.

## Info
* Developer Tools
* WWDC 2018 - Session 417 - iOS, macOS, tvOS
* https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/

## Text
 [[ Music ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=7) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=24) [&gt;&gt; Hello.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=32) [Welcome to Testing Tips &amp;](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=33) [Tricks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=34) [My name is Brian Croom.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=36) [My colleague, Stuart, and I are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=38) [really excited to share some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=40) [great testing techniques with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=41) [you that we have been learning](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=42) [recently.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=43) [As the conference was](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=44) [approaching, we thought it would](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=48) [be really cool to have an app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=50) [that we could use to find cool](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=51) [things to see and do around the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=53) [area of the convention center.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=54) [We've been building this app,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=56) [giving it views for finding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=59) [giving it views for finding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=59) [various point of interest around](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=60) [San Jose and listing how far](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=62) [they are away from you.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=64) [Now, of course, we wanted to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=65) [make sure we had a really great](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=68) [test suite for this app that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=70) [could run to give us confidence](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=72) [that our code was working](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=74) [properly and would keep working](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=75) [as we continue development.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=77) [Today, we want to share four](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=79) [simple techniques with you that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=84) [we found really helpful while](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=85) [writing tests for our app.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=87) [Some strategies for testing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=89) [networking code in your app,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=92) [some tips for tests dealing with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=94) [foundation notification objects,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=96) [ways to take advantage of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=98) [protocols when making mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=101) [objects in your tests, and a few](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=103) [techniques for keeping your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=106) [tests running really fast.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=107) [Let's start talking about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=109) [networking.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=113) [To allow for dynamic content](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=115) [updates, we've been building our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=117) [app to load its data from a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=118) [app to load its data from a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=118) [remote web server.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=120) [Here are some things that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=122) [found useful when writing tests](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=123) [for networking code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=125) [But first, quick, a recap from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=126) [last year.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=130) [At WWDC 2017's Engineering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=132) [Testability session, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=135) [discussed the pyramid model as a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=137) [guide to how to structure a test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=139) [suite, balancing thoroughness,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=140) [understandability, and execution](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=143) [speed.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=145) [In summary, an ideal test suite](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=148) [tends to be composed of a large](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=151) [percentage of focused unit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=152) [tests, exercising individual](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=154) [classes and methods in your app.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=156) [These are characterized by being](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=159) [simple to read, producing clear](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=161) [failure messages when we detect](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=163) [a problem, and by running very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=165) [quickly, often in the order of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=167) [hundreds or thousands of tests](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=169) [per minute.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=171) [These are complemented by a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=174) [smaller number of medium-sized](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=175) [integration tests that targeted](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=178) [integration tests that targeted](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=178) [discreet subsystem or cluster of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=180) [classes in your app, checking](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=182) [that they worked together](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=185) [properly, each taking no more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=185) [than a few seconds to run.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=187) [And the suite is topped off by a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=191) [handful of end-to-end system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=193) [tests, most often taking the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=194) [form of UI tests that exercise](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=196) [the app in a way very similar to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=199) [how the end-user will do so on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=200) [their devices, checking that all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=202) [the pieces are hooked up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=205) [properly and interact well with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=206) [the underlying operating system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=208) [and external resources.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=210) [A test suite following this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=212) [model can provide a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=214) [comprehensive picture of how an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=216) [app code's base is functioning.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=218) [For testing the networking stack](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=223) [in this app, we really wanted to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=225) [take the pyramid model to heart](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=226) [and use it as a guide for how to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=228) [structure our test suite.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=230) [Here, we see the high-level data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=233) [flow involved in making a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=234) [network request in the app and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=236) [feeding the data into the UI.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=238) [In an early prototype of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=242) [app, we had a method in our view](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=243) [controller that was doing all of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=245) [this in a single place, and it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=246) [looked like this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=249) [The method takes a parameter](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=252) [with the user's location and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=253) [uses that to construct a URL for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=257) [a service API endpoint with a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=259) [location as query parameters.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=261) [Then it uses Foundation's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=265) [URLSession APIs to make a data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=267) [task for a get request to that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=269) [URL.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=272) [Then the server responds, it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=274) [would unwrap the data, decode it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=277) [using foundation's JSONDecoder](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=280) [API, into an array of point of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=281) [interest values, which is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=284) [struct that I declared elsewhere](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=285) [and conforms the decodable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=287) [protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=289) [And it stores that into a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=289) [property to drive a table view](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=292) [[inaudible] implementation,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=294) [putting it onto the screen.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=296) [Now, it's pretty remarkable that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=300) [I was able to do all of this in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=301) [just about 15 lines of code,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=303) [leveraging the power of Swift](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=305) [and Foundation, but, by putting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=307) [this together in the one method,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=310) [I [inaudible] the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=312) [maintainability and especially](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=312) [the testability of this code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=314) [Looking at the base of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=320) [testing pyramid, what we really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=322) [want to be able to do here is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=323) [write focus unit tests for each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=325) [of these pieces of the flow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=327) [Let's first consider the request](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=329) [preparation and response parsing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=332) [steps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=334) [In order to make this code more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=338) [testable, we started by pulling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=340) [it out of the view controller](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=342) [and made two methods on this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=344) [dedicated](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=346) [PointsOfInterestRequest type,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=347) [giving us two nicely decoupled](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=350) [methods that each take some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=352) [values as input and transform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=354) [them into some output values](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=357) [without any side effects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=358) [without any side effects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=358) [This makes it very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=363) [straightforward for us to write](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=364) [a focused unit test for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=366) [code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=369) [Here we're testing the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=369) [makeRequest method just by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=370) [making a sample and put](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=372) [location, passing it into the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=373) [method, and making some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=374) [assertions about its return](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=376) [value.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=378) [Similarly, we can test the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=382) [response parsing by passing in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=383) [some mock JSON and making](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=385) [assertions about the parsed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=386) [result.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=387) [One other thing to note about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=391) [this test is that I'm taking](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=393) [advantage of XCTest support for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=394) [test methods marked as throws,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=397) [allowing me to use try in my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=399) [test code without needing an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=401) [explicit do catch block around](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=403) [it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=404) [Now, let's see the code for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=409) [interacting with URL session.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=410) [Here, again, we pull it out the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=414) [view controller, made a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=415) [APIRequest protocol with methods](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=418) [APIRequest protocol with methods](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=418) [matching the signature of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=421) [methods from the request type](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=422) [that we just saw.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=423) [And this is used by an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=424) [APIRequestLoader class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=426) [That's initialized with a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=429) [request type and a urlSession](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=430) [instance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=436) [This class has a loadAPIRequest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=437) [method which uses that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=439) [apiRequest value to generate a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=441) [URL request.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=443) [Feed that into the urlSession,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=445) [and then use the apiRequest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=447) [again to parse in your response.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=449) [Now, we can continue write unit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=450) [test for this method, but right](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=456) [now I actually want to move up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=458) [the pyramid and look at a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=459) [midlevel integration test that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=461) [covers several pieces of this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=462) [data flow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=464) [Another thing that I really want](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=466) [to also be able to test at this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=468) [layer of my suite is that my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=470) [interaction with the URLSession](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=472) [APIs is correct.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=474) [It turns out that the foundation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=476) [URL loading system provides a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=478) [URL loading system provides a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=478) [great hook for doing this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=480) [URLSession provides a high level](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=484) [API for apps to use to perform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=486) [network requests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=487) [[Inaudible] objects like](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=490) [URLSession data tests that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=491) [represent an inflight request.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=492) [Behind the scenes though,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=494) [there's another lower-level API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=497) [URLProtocol which performs the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=499) [underlying work of opening](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=502) [network connection, writing the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=503) [request, and reading back a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=505) [response.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=506) [URLProtocol is designed to be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=509) [subclassed giving an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=511) [extensibility point for the URL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=512) [loading system.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=514) [Foundation provides built-in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=518) [protocols subclasses for common](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=520) [protocols like HTTPS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=523) [But we can override these in our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=524) [tests by providing a mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=527) [protocol that lets us make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=528) [assertions about requests that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=530) [are coming out and provide mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=532) [responses.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=534) [URLProtocol communicates](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=539) [URLProtocol communicates](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=539) [progress back to the system via](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=540) [the URLProtocolClient protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=542) [We can use this in this way.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=548) [We make a MockURLProtocol class](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=550) [in our test bundle, overriding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=552) [canInit request to indicate to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=555) [the system that we're interested](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=558) [in any request that it offers](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=559) [us.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=561) [Implement canonicalRequest for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=563) [request, but the start loading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=565) [and stop loading method's where](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=567) [most of the action happens.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=568) [To give our tests a way to hook](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=574) [into this URLProtocol, we'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=576) [provide a closure property](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=578) [requestHandler for the test to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=579) [set.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=581) [When a URLSession task begins,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=584) [the system will instantiate our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=587) [URLProtocol subclass, giving it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=588) [the URLRequest value and a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=591) [URLProtocol client instance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=593) [Then it'll call our startLoading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=596) [method, where we'll take our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=598) [method, where we'll take our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=598) [requestHandler to the test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=600) [subsets and call it with a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=602) [URLRequest as a parameter.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=604) [We'll take what it returns and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=607) [pass it back to the system,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=608) [either as a URL response plus](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=610) [data, or as an error.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=612) [If you want to do test request](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=615) [cancellation, we could do](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=619) [something similar in a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=621) [stopLoading method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=622) [implementation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=623) [With the stub protocol in hand,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=628) [we can write our test.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=630) [We set up by making an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=633) [APIRequestLoader instance,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=634) [configure it with a request type](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=636) [and a URLSession that's been](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=639) [configured to use our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=640) [URLProtocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=641) [In the test body, we set a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=646) [requestHandler on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=648) [MockURLProtocol, making](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=649) [assertions about the request](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=652) [that's going out, then providing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=653) [a stub response.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=656) [Then we can call loadAPIRequest,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=657) [Then we can call loadAPIRequest,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=657) [waiting for the completion block](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=663) [to be called, making assertions](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=664) [about the parsed response.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=666) [Couple of tests at this layer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=670) [can give us a lot of confidence](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=672) [that our code is working](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=674) [together well and, also, that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=675) [we're integrating properly with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=677) [the system.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=678) [For example, this test that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=679) [just saw would have failed if I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=681) [had forgotten to call a resume](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=683) [on my data task.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=684) [I'm sure I'm not the only one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=686) [who's made that mistake.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=687) [Finally, it can also be really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=693) [valuable to include some system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=694) [level end-to-end tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=696) [Actually test a UI testing can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=699) [be a great tool for this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=701) [To learn more about UI testing,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=704) [refer to the UI testing in Xcode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=706) [session from WWDC 2015.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=707) [Now, a significant challenge](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=711) [that you encounter when you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=716) [start to write true end-to-end](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=717) [tests is that when something](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=719) [tests is that when something](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=719) [goes wrong when you get a test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=721) [failure, it can be really hard](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=721) [to know where to start looking](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=723) [for the source of the problem.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=724) [One thing that we were doing in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=726) [our test recently to help](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=728) [mitigate this was to set up a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=729) [local instance of a mock server,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=732) [interrupting our UI tests to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=734) [make requests against that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=735) [instead of the real server.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=737) [This allowed our UI test to be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=739) [much more reliable, because we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=741) [had control over the data being](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=742) [fed back into the app.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=744) [Now, while using a mock server](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=748) [can be really useful in this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=750) [context, it is also good to have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=751) [some tests making requests](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=753) [against the real server.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=754) [One cool technique for doing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=756) [this can be to have some tests](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=760) [in the unit testing bundle that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=761) [call directly into your apps in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=763) [that work in Stack and use that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=765) [to direct requests against the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=767) [real server.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=768) [This provides a way of verifying](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=771) [that the server is accepting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=772) [requests the way that your app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=774) [is making them and that you're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=775) [able to parse the server's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=777) [responses without having to deal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=778) [responses without having to deal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=778) [with the complications of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=781) [testing your UI at the same](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=782) [time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=784) [So, to wrap up, we've seen an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=790) [example of breaking code into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=792) [smaller, independent pieces to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=794) [facilitate unit testing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=796) [We've seen how URLProtocol can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=798) [be used as a tool for mocking](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=801) [network requests,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=803) [and we've discussed how the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=804) [power of the pyramid can be used](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=807) [to help us structure a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=809) [well-balanced test suite that'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=810) [give us good confidence in our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=812) [code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=813) [Now, I want to call Stuart to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=815) [the stage to talk about some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=816) [more techniques.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=818) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=820) [&gt;&gt; Thanks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=823) [Thanks, Brian.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=826) [So, the first area I'd like to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=828) [talk about is some best](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=829) [practices for testing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=831) [notifications.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=832) [And to clarify, by notification](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=834) [here, I'm talking about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=837) [foundation-level notifications](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=838) [known as NSNotification and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=840) [Objective-C.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=841) [So, sometimes we need to test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=843) [that a subject observes a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=844) [notification, while other times](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=846) [we need to test that a subject](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=848) [posts a notification.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=849) [Notifications are a one-to-many](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=851) [communication mechanism, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=853) [that means that when a single](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=854) [notification is posted, it may](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=856) [be sent to multiple recipients](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=858) [throughout your app or even in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=859) [the framework code running in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=861) [your app's process.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=862) [So, because of this, it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=864) [important that we always test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=865) [notifications in an isolated](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=867) [fashion to avoid unintended side](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=868) [effects, since that can lead to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=872) [flaky, unreliable tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=875) [So, let's look at an example of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=877) [some code that has this problem.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=878) [Here, I have the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=881) [PointsOfInterest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=882) [TableViewController from the app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=882) [Brian and I are building.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=884) [It shows a list of nearby places](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=886) [of interest in a table view, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=888) [whenever the app's location](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=890) [authorization changes, it may](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=891) [need to reload its data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=892) [So, it observes a notification](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=894) [called authChanged from our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=896) [app's CurrentLocationProvider](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=897) [class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=899) [When it observes this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=900) [notification, it reloads its](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=901) [data if necessary, and, then,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=903) [for the purpose of this example,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=905) [it sets a flag.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=906) [This way, our test code can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=908) [check that the flag to see if](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=910) [the notification was actually](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=911) [received.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=912) [We can see here that it's using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=913) [the default notification center](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=915) [to add the observer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=917) [Let's take a look at what a unit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=919) [test for this code might look](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=921) [like.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=922) [Here in our test for this class,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=923) [we post the authChanged method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=925) [notification to simulate it, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=927) [we post it to the default](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=929) [NotificationCenter, the same one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=930) [that our view controller uses.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=932) [Now, this test works, but it may](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=934) [have unknown side effects](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=936) [elsewhere in our app's code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=937) [It's common for some system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=939) [notifications like UI](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=940) [applications](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=942) [appDidFinishLaunching](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=943) [notification to be observed by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=944) [many layers and to have unknown](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=946) [side effects, or it could simply](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=947) [slow down our tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=949) [So, we'd like to isolate this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=951) [code better to test this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=953) [There's a technique we can use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=955) [to better isolate these tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=957) [To use it, we first have to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=960) [recognize that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=961) [NotificationCenter can have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=962) [multiple instances.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=963) [As you may note, it has a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=965) [default instance as a class](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=968) [property, but it supports](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=969) [creating additional instances](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=970) [whenever necessary, and this is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=972) [going to be key to isolating our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=973) [tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=974) [So, to apply this technique, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=976) [first have to create a new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=978) [NotificationCenter, pass it to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=979) [our subject and use it instead](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=981) [of the default instance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=983) [This is often referred to as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=985) [dependency injection.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=986) [So, let's take a look at using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=988) [this in our view controller.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=989) [Here, I have the original code](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=991) [that uses the default](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=993) [NotificationCenter, and I'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=994) [modify it to use a separate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=996) [instance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=997) [I've added a new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=998) [NotificationCenter property and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1000) [a parameter in the initializer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1002) [that sets it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1003) [And, instead of adding an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1004) [observer to the default center,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1005) [it uses this new property.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1007) [I'll also add a default](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1011) [parameter value of .default to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1013) [the initializer, and this avoids](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1015) [breaking any existing code in my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1017) [app, since existing clients](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1018) [app, since existing clients](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1018) [won't need to pass the new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1020) [parameter, only our unit tests](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1021) [will.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1023) [Now let's go back and update our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1025) [tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1027) [Here's the original test code,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1028) [and now I've modified it to use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1030) [a separate NotificationCenter.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1032) [So, this shows how we can test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1037) [that our subject observes a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1039) [notification, but how do we test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1040) [that our subject posts a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1042) [notification?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1043) [We'll use the same separate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1045) [NotificationCenter trick again,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1047) [but I'll also show how to make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1049) [use of built-in expectation APIs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1050) [to add a notification observer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1052) [So, here's another section of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1055) [code from our app, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1056) [CurrentLocationProvider class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1058) [I'll talk more about this class](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1060) [later, but notice that it has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1061) [this method for signaling to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1064) [other classes in my app that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1065) [app's location authorization has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1067) [changed by posting a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1068) [notification.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1069) [As with our view controller,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1071) [it's currently hardcoding the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1073) [default NotificationCenter.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1074) [And here's a unit test I wrote](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1076) [for this class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1079) [for this class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1079) [It verifies that it posts a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1081) [notification whenever the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1082) [NotifyAuthChanged method is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1083) [called, and we can see in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1085) [middle section here that this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1087) [test uses the addObserver method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1088) [to create a block-based](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1090) [observer, and then it removes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1092) [that observer inside of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1093) [block.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1094) [Now, one improvement that I can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1096) [make to this test is to use the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1097) [built-in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1098) [XCTNSNotificationExpectation API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1099) [to handle creating this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1102) [NotificationCenter observer for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1104) [us.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1105) [And this is a nice improvement,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1106) [and it allows us to delete](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1108) [several lines of code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1110) [But it still has the problem we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1112) [saw before of using the default](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1113) [NotificationCenter implicitly,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1115) [so let's go fix that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1117) [Here's our original code, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1120) [I'll apply the same technique we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1122) [saw earlier of taking a separate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1123) [NotificationCenter in our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1125) [initializer, storing it, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1126) [using it instead of the default.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1129) [Going back to our test code now,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1130) [I'll modify it to pass a new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1136) [NotificationCenter to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1137) [subject, but take a look at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1138) [subject, but take a look at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1138) [expectation now.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1141) [When our tests are expecting to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1143) [receive a notification to a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1144) [specific center, we can pass the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1146) [NotificationCenter parameter to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1148) [the initializer of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1150) [expectation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1150) [I'd also like to point out that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1153) [the timeout of this expectation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1155) [is 0, and that's because we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1158) [actually expect it to already](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1159) [have been fulfilled by the time](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1161) [we wait on it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1162) [That's because the notification](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1163) [should have already been posted](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1165) [by the time the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1166) [NotifyAuthChanged method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1167) [returns.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1168) [So, using this pair of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1170) [techniques for testing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1171) [notifications we can ensure that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1172) [our tests remained fully](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1174) [isolated, and we've made the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1175) [change without needing to modify](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1177) [an existing code in our app,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1179) [since we specified that default](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1180) [parameter value.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1182) [So, next, I'd like to talk about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1187) [a frequent challenge when](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1189) [writing unit tests, interacting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1190) [with external classes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1192) [So, while developing your app,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1195) [you've probably run into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1197) [situations where your class is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1198) [situations where your class is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1198) [talking to another class, either](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1200) [elsewhere in your app or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1202) [provided by the SDK.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1203) [And you found it difficult to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1205) [write a test, because it's hard](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1207) [or even impossible to create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1209) [that external class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1210) [This happens a lot, especially](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1212) [with APIs that aren't designed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1214) [to be created directly, and it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1216) [even harder when those APIs have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1217) [delegate methods that you need](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1219) [to test.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1221) [I'd like to show how we can use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1222) [protocols to solve this problem](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1224) [by mocking interaction with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1226) [external classes but do so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1227) [without making our tests less](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1229) [reliable.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1231) [In our app, we have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1233) [CurrentLocationProvider class](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1235) [that uses CoreLocation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1237) [It creates a CLLocationManager](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1239) [and configures it in its](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1241) [initializer, setting its desired](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1242) [accuracy property and setting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1244) [itself as the delegate.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1246) [Here's the meat of this class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1247) [It's a method called](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1251) [checkCurrentLocation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1252) [It requests the current location](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1254) [and takes a completion block](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1255) [that returns whether that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1256) [location is a point of interest.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1258) [So, notice that we're calling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1260) [the request location method on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1261) [CLLocationManager, here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1263) [When we call this, it'll attempt](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1264) [to get the current location and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1267) [eventually call a delegate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1269) [method on our class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1270) [So, let's go look at that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1272) [delegate method.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1274) [We use an extension to conform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1275) [to the CLLocationManagerDelegate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1276) [protocol here, and we call a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1278) [stored completion block.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1280) [Okay, so let's try writing a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1282) [unit test for this class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1283) [Here's one that I tried to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1286) [write, and, if we read through](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1287) [it, we can see that it starts by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1289) [creating a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1290) [CurrentLocationProvider and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1291) [checks that the desired accuracy](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1293) [and whether the delegate is set.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1295) [So far, so good.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1297) [But then things get tricky.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1299) [We want to check the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1301) [checkCurrentLocation method,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1302) [since that's where our main](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1304) [logic lives, but we have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1305) [problem.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1307) [We don't have a way to know when](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1308) [the request location method is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1309) [called, since that's a method on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1311) [CLLocationManager and not part](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1313) [our code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1316) [Another problem that we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1317) [likely to encounter in this test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1318) [is that CoreLocation requires](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1320) [user authorization, and that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1322) [shows a permission dialog on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1324) [device if it hasn't been granted](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1325) [before.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1326) [This causes our tests to rely on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1328) [device state.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1330) [It makes them harder to maintain](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1330) [and, ultimately, more likely to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1332) [fail.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1333) [So, if you've had this problem](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1333) [in the past, you may have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1336) [considered subclassing the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1339) [external class and overriding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1340) [any methods that you call on it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1342) [For example, we could try](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1344) [subclassing CLLocationManager](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1346) [here and overriding the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1348) [RequestLocation method.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1349) [And that may work at first, but](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1352) [it's risky.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1354) [Some classes from the SDK aren't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1355) [designed to be subclassed and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1357) [may behave differently.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1358) [Plus, we still have to call the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1360) [superclass' initializer, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1362) [that's not code that we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1363) [override.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1364) [But the main problem is that, if](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1366) [I ever modify my code to call](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1367) [another method on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1369) [CLLocationManager, I'll have to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1370) [remember to override that method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1372) [on my testing subclass as well.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1374) [If I rely on subclassing, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1377) [compiler won't notify me that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1378) [compiler won't notify me that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1378) [I've started calling another](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1380) [method, and it's easy to forget](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1381) [and break my tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1383) [So, I don't recommend this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1385) [method, and instead to mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1386) [external types using protocols.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1389) [So, let's walk through how to do](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1391) [that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1394) [Here's the original code, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1394) [the first step is to define a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1396) [new protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1398) [I've named my new protocol](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1399) [LocationFetcher, and it includes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1401) [the exact set of methods and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1403) [properties that my code uses](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1405) [from CLLocationManager.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1406) [The member names and types match](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1409) [exactly, and that allows me to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1411) [create an empty extension on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1412) [CLLocationManager that conforms](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1414) [to the protocol, since it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1416) [already meets all the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1417) [requirements.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1418) [I'll then rename the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1421) [LocationManager property to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1422) [LocationFetcher, and I'll change](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1423) [its type to the LocationFetcher](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1425) [protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1427) [I'll also add a default](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1429) [parameter value to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1431) [initializer, just like I did](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1431) [earlier, to avoid breaking any](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1433) [existing app code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1434) [I need to make one small change](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1438) [to the checkCurrentLocation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1439) [to the checkCurrentLocation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1439) [method to use the renamed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1441) [property.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1442) [And, finally, let's look at that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1443) [delegate method.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1446) [This part is a little trickier](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1448) [to handle, because the delegate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1449) [expects the manager parameter to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1451) [be a real CLLocationManager, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1452) [not my new protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1455) [So, things get a little more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1456) [complicated when delegates are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1458) [involved, but we can still apply](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1459) [protocols here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1461) [Let's take a look at how.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1463) [I'll go back to LocationFetcher](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1466) [protocol that I defined earlier,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1468) [and I'll rename that delegate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1470) [property to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1471) [LocationFetcherDelegate.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1472) [And I'll change its type to a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1474) [new protocol whose interface is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1475) [nearly identical to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1477) [CLLocationManagerDelegate, but I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1478) [tweaked the method name, and I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1481) [changed the type of the first](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1482) [parameter to LocationFetcher.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1484) [Now I need to implement the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1489) [LocationFetcherDelegate property](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1490) [in my extension now, since it no](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1492) [longer satisfies that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1494) [requirement.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1495) [And I'll implement the getter](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1496) [and the setter to use force](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1498) [casting to convert back and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1499) [casting to convert back and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1499) [forth to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1500) [CLLocationManagerDelegate, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1501) [I'll explain why I'm using force](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1503) [casting here in just a second.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1504) [Then in my class' initializer, I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1508) [need to replace the delegate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1509) [property with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1510) [locationFetcherDelegate.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1511) [And the last step is to change](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1513) [the original extension to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1516) [conform to the new mock delegate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1518) [protocol, and that part's easy--](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1519) [all I need to do is replace the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1521) [protocol and the method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1523) [signature.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1524) [But I actually still need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1526) [conform to the old](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1528) [CLLocationManagerDelegate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1529) [protocol too, and that's because](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1530) [the real CLLocationManager](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1533) [doesn't know about my mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1534) [delegate protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1535) [So, the trick here is to add](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1538) [back the extension which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1539) [conforms to the real delegate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1541) [protocol but have it call the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1542) [equivalent locationFetcher](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1543) [delegate method above.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1545) [And earlier, I mentioned that I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1547) [used force casting in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1549) [delegate getter and setter, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1550) [that's to ensure that my class](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1552) [conforms to both of these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1553) [protocols and that I haven't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1554) [forgotten one or the other.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1556) [forgotten one or the other.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1556) [So, over in my unit tests, I'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1561) [define a struct nested in my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1563) [test class for mocking, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1565) [conforms to the locationFetcher](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1566) [protocol and fill out its](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1568) [requirements.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1569) [Notice, in its RequestLocation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1571) [method, it calls a block to get](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1572) [a fake location that I can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1574) [customize in my tests, and then](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1576) [it invokes the delegate method,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1578) [passing it that fake location.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1580) [Now that I have all the pieces I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1582) [need, I can write my test.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1585) [I create a MockLocationFetcher](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1588) [struct and configure its](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1589) [handleRequestLocation block to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1591) [provide a fake location.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1592) [Then I create my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1595) [CurrentLocationProvider, passing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1596) [it the MockLocationFetcher.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1598) [And, finally, I call](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1600) [checkCurrentLocation with a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1601) [completion block.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1602) [Inside the completion block,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1604) [there's an assertion that checks](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1605) [that the location actually is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1606) [point of interest.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1608) [So, it works.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1611) [I can now mock my classes' usage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1611) [of CLLocationManager without](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1613) [needing to create a real one.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1615) [So, here, I've shown how to use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1617) [protocols to mock interaction](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1619) [protocols to mock interaction](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1619) [with an external class and its](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1621) [delegate.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1623) [Now, that was a lot of steps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1623) [So, let's recap what we did.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1625) [First, we defined a new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1628) [protocol, representing the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1630) [interface of the external class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1631) [This protocol needs to include](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1634) [all the methods and properties](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1635) [that we use on the external](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1637) [class, and, often, their](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1638) [declarations can match exactly.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1640) [Next, we created an extension on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1642) [the original external class,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1645) [which declares conformance to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1647) [the protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1648) [Then we replaced all our usage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1650) [of the external class with our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1651) [new protocol, and we added an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1653) [initializer parameter so that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1655) [could set this type in our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1656) [tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1660) [We also talked about how to mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1661) [a delegate protocol, which is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1662) [common pattern in the SDKs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1664) [There were a few more steps](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1666) [involved here, but here's what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1667) [we did.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1669) [First, we defined a mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1670) [delegate protocol with similar](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1672) [method signatures as the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1674) [protocol that we're mocking.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1675) [But we replaced the real type](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1677) [with our mock protocol type.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1679) [with our mock protocol type.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1679) [Then, in our original mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1681) [protocol, we renamed the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1683) [delegate property, and we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1684) [implemented that renamed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1686) [property on our extension.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1687) [So, although this approach may](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1689) [require more code than an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1692) [alternative like subclassing,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1693) [it'll be more reliable and less](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1695) [likely to break as I expand my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1697) [code over time, since this way](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1698) [the compiler will enforce that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1701) [any new methods I call for my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1702) [code must be included in these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1704) [new protocols.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1706) [So, finally, I'd like to talk](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1712) [about test execution speed.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1713) [When your tests take a long time](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1715) [to run, you're less likely to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1719) [run them during development, or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1721) [you might be tempted to skip the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1722) [longest running ones.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1724) [Our test suite helps us catch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1725) [issues early, when fixing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1727) [regression is easiest.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1729) [So, we want to make sure our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1730) [tests always run as fast as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1731) [possible.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1733) [Now, you might have encountered](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1734) [times in the past when you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1735) [needed to artificially wait or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1737) [sleep in your tests, because the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1738) [sleep in your tests, because the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1738) [code your testing is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1740) [asynchronous or uses a timer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1741) [Delayed actions can be tricky,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1744) [so we want to be sure to include](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1745) [them in our tests, but they can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1746) [also slow things down a lot if](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1748) [we're not careful.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1750) [So, I'd like to talk about some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1751) [ways that we can avoid](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1753) [artificial delays in our tests,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1753) [since they should never be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1755) [necessary.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1756) [Here's an example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1757) [In the points of interest app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1759) [Brian and I are building, in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1761) [main UI, we have a strip at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1763) [bottom that shows the featured](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1765) [place.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1766) [It basically loops through the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1767) [top places nearby, rotating to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1768) [show a new location every 10](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1770) [seconds.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1772) [Now, there are several ways I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1773) [might implement this, but, here,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1774) [I'm using the timer API for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1776) [foundation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1777) [Let's look at a unit test that I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1778) [might write for this class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1782) [It creates a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1784) [FeaturedPlaceManager and stores](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1784) [its current place before calling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1786) [the scheduleNextPlace method.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1789) [Then it runs the run loop for 11](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1791) [seconds.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1793) [I added an extra second as a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1793) [grace period.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1795) [And, finally, it checks that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1797) [currentPlace changed at the end.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1798) [Now, this isn't great, and it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1801) [takes a really long time to run.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1802) [To mitigate this, we could](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1805) [expose a property in our code to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1806) [allow us to customize that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1808) [timeout to something shorter,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1809) [like 1 second.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1810) [And here's what that kind of a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1812) [code change might look like.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1814) [Now, with this approach, we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1820) [reduce the delay in our tests](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1822) [down to one second.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1823) [Now, this solution is better](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1825) [than the one we had before.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1826) [Our tests will definitely run](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1827) [faster, but it still isn't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1829) [ideal.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1831) [Our code still has a delay, it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1832) [just shorter.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1834) [And the real problem is that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1835) [code we're testing is still](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1836) [timing dependent, which means](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1838) [that, as we make the expected](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1840) [delay shorter and shorter, our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1841) [tests may become less reliable,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1843) [since they'll be more dependent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1845) [on the CPU to schedule things](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1846) [predictably.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1847) [And that's not always going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1848) [be true, especially for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1850) [asynchronous code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1850) [So, let's take a look at a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1852) [better approach.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1853) [I recommend first identifying](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1856) [the delay mechanism.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1858) [In my example, it was a timer,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1860) [but you could also be using the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1861) [asyncAfter API from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1863) [DispatchQueue.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1864) [We want to mock this mechanism](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1866) [in our tests so that we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1868) [invoke the delayed action](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1869) [immediately and bypass the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1870) [delay.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1872) [Here's our original code again,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1875) [and let's start by looking at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1877) [what this scheduledTimer method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1878) [actually does.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1880) [The scheduledTimer method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1882) [actually does two things for us.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1883) [It creates a timer, and then it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1886) [adds that timer to the current](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1888) [run loop.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1889) [Now, this API can be really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1891) [convenient for creating a timer,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1892) [but it would help us to make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1894) [this code more testable if I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1895) [actually break these two steps](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1896) [apart.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1898) [Here, I've transformed the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1900) [previous code from using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1901) [scheduledTimer to instead create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1903) [the timer first and then add it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1905) [to the current runLoop second,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1906) [which I have stored in a new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1908) [property.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1909) [Now, this code is equivalent to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1910) [what we had before, but, once we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1912) [break these two steps apart, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1914) [can see that runLoop is just](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1916) [another external class that this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1918) [class interacts with.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1919) [class interacts with.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1919) [So, we can apply the mocking](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1921) [with protocols technique we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1922) [discussed earlier here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1923) [To do that, we'll create a small](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1926) [protocol, containing this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1928) [addTimer method.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1929) [I've called this new protocol](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1930) [TimerScheduler, and it just has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1933) [that one addTimer method, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1935) [matches the signature of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1937) [runLoop API.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1938) [Now, back in my code, I need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1942) [replace the runLoop with the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1943) [protocol that I just created.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1945) [And in my tests, I don't want to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1947) [use a real runLoop as my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1951) [TimerScheduler.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1952) [Instead, I want to create a mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1953) [scheduler that passes the timer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1955) [to my tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1957) [I'll do this by creating a new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1959) [struct nested in my unit test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1960) [class called MockTimerScheduler,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1962) [conforming to the TimerScheduler](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1964) [protocol.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1966) [It stores a block that will be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1967) [called whenever it's told to add](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1969) [a timer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1971) [And with all the pieces in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1973) [place, I can write my final unit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1974) [test.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1976) [First, I create a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1977) [MockTimerScheduler and configure](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1978) [MockTimerScheduler and configure](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1978) [its handleAddTimer block.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1981) [This block receives the timer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1983) [Once it's added to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1984) [scheduler, it records the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1985) [timer's delay, and then it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1987) [invokes the block by firing the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1989) [timer to bypass the delay.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1991) [Then, we create a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1994) [FeaturedPlaceManager and give it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1995) [our MockTimerScheduler.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1997) [And, finally, we call](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=1999) [scheduleNextPlace to start the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2000) [test, and, voila, our tests no](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2002) [longer have any delay.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2005) [They execute super fast, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2007) [they aren't timer dependent, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2008) [it'll be more reliable.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2009) [And, as a bonus, I can now](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2012) [verify the amount of timer delay](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2014) [using this assertion at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2016) [bottom.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2017) [And that's not something I was](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2018) [able to do in the previous test.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2019) [So, like I said, the delay in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2022) [our code is fully eliminated](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2024) [using this technique.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2026) [We think this was a great way to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2028) [test code that involves delayed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2029) [actions, but, for the fastest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2030) [overall execution speed in your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2032) [tests, it's still preferable to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2034) [structure the bulk of your tests](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2036) [to be direct and not need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2037) [mock delayed actions at all.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2039) [mock delayed actions at all.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2039) [For example, in our app, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2041) [action being delayed was](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2044) [changing to the next featured](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2045) [place.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2046) [I probably only need one or two](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2047) [tests that show that the timer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2050) [delay works properly.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2051) [And, for the rest of the class,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2053) [I can call the show next place](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2054) [method directly and not need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2056) [mock a timer scheduler at all.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2057) [While we're on the topic of text](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2062) [execution speed, we had a couple](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2063) [of other tips to share.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2065) [One area we've seen concerns the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2067) [use of NSPredicateExpectations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2069) [We wanted to mention that these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2071) [are not nearly as performant as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2073) [other expectation classes, since](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2074) [they rely on polar rather than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2076) [more direct callback mechanisms.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2077) [They're mainly used in UI tests,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2080) [where the conditions being](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2082) [evaluated are happening in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2083) [another process.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2085) [So, in your unit tests, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2086) [recommend more direct](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2087) [mechanisms, such as regular](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2088) [XCTestExpectations,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2090) [NSNotification, or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2092) [KVOExpectations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2094) [Another testing speed tip is to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2097) [ensure that your app launches as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2099) [ensure that your app launches as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2099) [quickly as possible.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2101) [Now, most apps have to do some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2103) [amount of setup work at launch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2104) [time, and, although that work is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2106) [necessary for regular app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2107) [launches, when your app is being](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2109) [launched as a test runner, a lot](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2111) [of that work may be unnecessary.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2113) [Things like loading view](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2115) [controllers, kicking off network](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2116) [requests, or configuring](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2118) [analytics packages-- these are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2120) [all examples of things that are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2121) [commonly unnecessary in unit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2123) [testing scenarios.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2124) [XCTest waits until your app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2126) [delegates did finish launching](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2128) [method returns before beginning](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2130) [to run tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2131) [So, if you profile and notice](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2133) [that app launch is taking a long](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2134) [time in your tests, then one tip](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2136) [is to detect when your app is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2138) [launched as a test runner and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2139) [avoid this work.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2141) [One way to do this is to specify](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2142) [a custom environment variable or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2146) [launch argument.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2148) [Open the scheme editor, go to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2149) [the test action on the left](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2151) [side, then to the arguments tab,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2152) [and add either an environment](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2155) [variable or a launch argument.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2156) [In this screenshot, I've added](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2159) [In this screenshot, I've added](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2159) [an environment variable named](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2160) [IS-UNIT-TESTING set to 1.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2162) [Then, modify your app delegate's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2166) [appDidFinishLaunching code to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2168) [check for this condition, using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2169) [code similar to this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2171) [Now, if you do this, be sure](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2173) [that the code you skip truly is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2175) [nonessential for your unit test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2176) [to function.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2178) [So, to wrap up, Brian started by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2183) [reminding us about the testing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2187) [pyramid and how to have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2188) [balanced testing strategy in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2189) [your app, showing several](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2191) [practical techniques for testing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2192) [network operations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2194) [Then, I talked about isolating](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2196) [foundation notifications and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2198) [using dependency injection.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2200) [We offered a solution to one of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2203) [the most common challenges when](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2204) [writing tests, interacting with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2206) [external classes, even if they](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2208) [have a delegate.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2210) [And we shared some tips for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2212) [keeping your tests running fast](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2213) [and avoiding artificial delays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2215) [We really hope you'll find these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2217) [tests useful and look for ways](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2218) [tests useful and look for ways](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2218) [to apply them the next time](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2220) [you're writing tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2221) [For more information, check out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2224) [our session webpage at this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2225) [link, and, in case you missed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2227) [it, we hope you'll check out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2228) [Wednesday's What's New in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2230) [Testing session on video.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2231) [Thanks so much, and I hope you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2233) [had a great WWDC.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2234) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/417/?time=2236)