# Metal for Game Developers

## Summary
Metal 2 is Apple-designed graphics software that lets developers build consoleâ€‘style games. Learn key aspects of the Metal architecture that support the techniques for modern high-performance game rendering. See how Metal now enables the GPU to schedule work for itself, allowing complete scenes and compute workloads to be built and executed with little to no CPU interaction. Understand how the seamless integration of Metal 2 with the A11 Bionic chip lets your apps and games realize entirely new levels of performance and capability.

## Info
* Graphics and Games
* WWDC 2018 - Session 607 - iOS, macOS, tvOS
* https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/

## Text
 [[ Music ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=7) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=21) [&gt;&gt; Welcome.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=26) [Last year, we introduced Metal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=28) [2, which includes new ways for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=30) [the GPU to drive the rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=32) [pipeline.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=34) [This year, we're introducing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=36) [even more new and exciting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=37) [features to solve common game](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=39) [development challenges.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=41) [My name is Brian Ross, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=43) [together with my colleague,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=44) [Michael Imbrogno, we'll explore](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=46) [new ways to make your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=48) [applications better, faster, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=49) [more efficient.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=52) [But first, I want to talk about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=54) [some of the challenges that I'm](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=57) [trying to help you solve.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=58) [Your games are using an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=60) [ever-increasing number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=62) [objects, materials, and lights.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=63) [Games like Inside, for example,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=67) [use a great deal of special](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=69) [effects to capture and support](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=70) [the mood of the game.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=73) [Making games like this that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=76) [truly draw you in is challenging](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=77) [because it can require efficient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=79) [GPU utilization.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=82) [At the same time, games are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=83) [requiring more and more CPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=87) [cycles for exciting gameplay.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=88) [For example, games like Tomb](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=91) [Raider that features](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=93) [breathtaking vistas and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=94) [highly-detailed terrain, but, at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=96) [the same time, they're also](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=98) [managing complex physics](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=100) [simulations in AI.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=101) [This is challenging because it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=104) [leaves less CPU time for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=105) [rendering.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=107) [And finally, developers are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=109) [taking AAA titles like Fortnite](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=112) [from Epic Games, importing them](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=115) [to iOS so you can run a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=117) [console-level game in the palm](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=119) [console-level game in the palm](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=119) [of your hand.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=121) [This is a truly amazing feat,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=122) [but this also leaves us with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=125) [even more challenges, like how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=126) [to balance battery life with a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=129) [great frame rate.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=131) [So now, let's look at how Metal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=132) [can help you solve these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=134) [challenges.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=136) [Today, I'm going to show you how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=138) [to harness parallelism on both](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=141) [the CPU and the GPU to draw more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=142) [complex scenes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=145) [We'll also talk about ways to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=149) [maximize performance using more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=151) [explicit control with heaps,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=153) [fences, and events.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=155) [And then, I'm going to show you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=157) [how to build GPU-driven](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=161) [pipelines using our latest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=163) [features, argument buffers and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=164) [indirect command buffers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=166) [Now, while all these API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=168) [improvements are key, it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=169) [equally important to understand](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=171) [the underlying hardware they run](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=173) [on.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=174) [So the next section, my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=175) [colleague Michael is going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=177) [show you how to optimize for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=179) [show you how to optimize for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=179) [A11 to improve performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=181) [extend playtime.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=183) [And finally, I'm really excited](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=185) [that we're going to be joined by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=188) [Nick Penwarden from Epic Games.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=189) [He is going to show us how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=192) [they've used Metal to bring](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=194) [console-level games to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=195) [devices.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=197) [So let's get started.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=199) [Harnessing both CPU and GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=203) [parallelism is probably the most](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=205) [important and easiest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=207) [optimization you can make.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=208) [Building a command stream on a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=212) [single thread is not sufficient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=213) [anymore.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=214) [The latest iPhone has 6 cores,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=216) [and the iMac Pro can have up to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=218) [18.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=219) [So scalable, multithreaded](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=221) [architecture is key to great](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=222) [performance on all of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=225) [devices.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=229) [Metal is designed for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=229) [multithreading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=231) [I'm going to show you 2 ways how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=231) [to parallelize on the CPU, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=233) [then I'm going to close this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=235) [section by showing you how Metal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=236) [could automatically parallelize](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=238) [could automatically parallelize](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=238) [for you on the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=240) [So let's set up an example of a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=242) [typical game frame.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=244) [With a classic, single-threaded](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=246) [rendering, you'd [inaudible]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=248) [build GPU commands and GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=250) [execution order into a single](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=253) [command buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=254) [Typically, you're then having to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=256) [fit this into some small](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=257) [fraction of your frame time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=258) [And, of course, you're going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=261) [have maximum latency because the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=262) [entire command buffer must be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=264) [encoded before the GPU can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=266) [consume it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=268) [Obviously, there's a better way](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=269) [to do this, so what we're going](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=270) [to do is we're going to start by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=272) [building in parallelism with the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=274) [CPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=276) [Render and compute passes are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=277) [the basic granularity of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=281) [multithread in Metal.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=283) [All you need to do is create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=285) [multiple command buffers and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=286) [start encoding each into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=288) [separate passes on a separate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=290) [thread.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=291) [You can encode them in any order](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=292) [you wish.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=295) [The final order of execution is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=296) [determined by the order they're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=297) [added to the command queue.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=299) [added to the command queue.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=299) [So now, let's take a look at how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=301) [easy this is to do in your code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=302) [So you can see this is not a lot](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=304) [of code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=309) [The first thing that you're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=310) [going to do is create any number](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=311) [of command buffers from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=313) [queue.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=314) [Next, we're going to define the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=316) [GPU execution order upfront by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=319) [using the enqueue interface.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=321) [This is great because you can do](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=323) [all this without waiting for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=325) [command buffer to be encoded](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=327) [first.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=328) [And finally, we're going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=329) [create separate threads and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=331) [caller encoding functions for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=333) [each.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=335) [And that's it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=335) [That's all you have to do.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=336) [It's really fast, it's really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=338) [efficient, and it's really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=340) [simple.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=341) [So now, let's go back to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=342) [previous diagram and look at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=343) [another example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=345) [So as you can see, we did a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=346) [pretty good job parallelizing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=349) [these on the CPU, but what if](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=351) [you have 1 really long rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=354) [pass?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=358) [So in cases like this, Metal has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=358) [So in cases like this, Metal has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=358) [a dedicated parallel encoder](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=361) [that allows you to encode on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=362) [multiple threads without](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=364) [explicitly dividing up the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=366) [render pass or the command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=368) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=369) [So now, let's look at how simple](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=370) [this is in your code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=372) [It looks a lot like the previous](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=374) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=376) [The first thing you're going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=377) [do is create a parallel encoder.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=378) [And from that, you create any](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=381) [number of subordinate encoders.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=383) [And it's important to realize](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=385) [that this is actually where you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=387) [define the GPU execution order.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=388) [Next, we're going to create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=392) [separate threads and encode each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=395) [of our G-buffer functions](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=397) [separately.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=399) [And finally, we set up a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=400) [notification so that when the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=404) [threads are complete, we call](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=406) [end encoding on the parallel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=408) [encoder.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=409) [And that is it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=410) [That's all you have to do to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=411) [parallelize a render pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=412) [It's really fast, and it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=414) [really easy.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=415) [So now that I've shown you 2](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=416) [ways to parallelize on the CPU,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=418) [now let's see how Metal can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=420) [parallelize for you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=421) [automatically on the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=422) [So let's look at the frame](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=424) [example from the beginning and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=427) [see how the GPU executes the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=430) [frame.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=431) [Based on the capabilities of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=433) [your platform, Metal can extract](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=434) [parallelism automatically by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=437) [analyzing your data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=439) [dependencies.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=440) [Let's look at just 2 of these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=441) [dependencies.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=442) [So in this example, the particle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=444) [simulation writes data, which is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=446) [later used by the effects pass](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=448) [to render the particles.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=450) [Similarly, the G-buffer pass](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=452) [generates geometry, which is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=456) [later used by the deferred](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=457) [shading pass to compute material](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=458) [lighting.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=463) [All this information allows](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=463) [Metal to automatically and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=465) [cheaply identify entire passes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=466) [that can run in parallel, such](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=469) [as using async compute.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=471) [So you can achieve parallelism](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=475) [and async compute for free on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=477) [and async compute for free on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=477) [the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=480) [It's free because Metal doesn't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=481) [require you to do anything](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=482) [special on your part.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=483) [So I think we all love getting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=484) [free optimizations on the GPU,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=487) [but sometimes you as a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=489) [developer, you may need to dive](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=490) [a little bit deeper.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=493) [For the most critical parts of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=494) [your code, Metal allows you to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=496) [incrementally dive deeper with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=498) [more control.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=500) [For example, you could disable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=501) [automatic reference counting and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=503) [do it yourself to save on CPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=505) [time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=507) [You could also use Metal heaps](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=508) [to tightly control allocations](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=510) [really cheaply.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=512) [And Metal heaps are complemented](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=513) [by fences and events, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=516) [allow you to explicitly control](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=519) [the GPU parallelism.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=521) [Many of your games are using a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=524) [lot of resources, which can be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=526) [costly.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=528) [Allocations require a round trip](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=529) [to the OS, which has to map and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=531) [initialize memory on each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=534) [request.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=535) [If your game uses temporary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=536) [render targets, these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=538) [allocations can happen in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=539) [allocations can happen in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=539) [middle of your frame, causing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=540) [stutters.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=542) [Resource heaps are a great](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=543) [solution to this problem.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=545) [Heaps also let you allocate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=547) [large slabs of memory from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=549) [system upfront.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=551) [And from those, you can later](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=552) [add or remove textures and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=553) [buffers from those slabs without](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=554) [any costly round trip.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=556) [So starting from a case where](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=558) [you allocate 3 normal textures,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=560) [Metal typically places these in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=563) [3 separate allocations, but](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=565) [putting these all instead into a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=567) [single heap lets you perform all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=569) [memory allocation upfront at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=571) [heap creation time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=574) [So then, the act of creating](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=575) [textures becomes extremely](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=577) [cheap.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=578) [Also, heaps can sometimes let us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=580) [use the space more efficiently](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=582) [by packing allocations closer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=585) [together.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=586) [So with a traditional model, you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=588) [would deallocate textures,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=590) [releasing pages back to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=592) [system, and then reallocate,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=593) [which will allocate a new set of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=596) [textures all over again.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=597) [With heaps, you deallocate and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=599) [With heaps, you deallocate and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=599) [reallocate without any costly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=602) [round trip to the OS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=604) [Finally, heaps also let you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=608) [alias different memory resources](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=609) [with each other.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=611) [This is really helpful if your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=614) [game frame has a lot of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=615) [temporary render targets.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=616) [There's no reason for these to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=618) [occupy a different memory all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=619) [the time, so you could alias and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=621) [save hundreds of megabytes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=623) [Now, the faster allocations in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=626) [aliasing are great, but it's not](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=628) [entirely free when it comes to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=630) [dependency tracking.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=631) [Let's return to our frame](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=633) [example for a better](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=634) [explanation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=635) [With heaps, Metal no longer sees](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=638) [individual resources, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=640) [therefore, it can't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=642) [automatically identify the read](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=643) [and write dependencies between](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=644) [passes, such as the G-buffer and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=646) [deferred shading pass in our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=648) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=649) [So you have to use fences to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=651) [explicitly signal which pass](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=653) [produces data and which pass](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=655) [consumes the data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=657) [So in this example, the G-buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=658) [So in this example, the G-buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=658) [updates the fence, and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=660) [deferred shading waits for it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=662) [So now, let's take a look at how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=664) [we could apply these basic](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=668) [concepts in your code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=669) [So the first thing that we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=672) [going to do is we're going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=675) [apply this to our G-buffer and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=676) [deferred shading example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=677) [First, we're going to allocate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=679) [our temporary render target from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=681) [the heap.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=683) [This looks just like what you're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=683) [probably already doing today](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=684) [when you allocate a texture.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=686) [Next, we're going to render into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=688) [that temporary render target.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=691) [And finally, update the fence](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=693) [after the fragment stage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=696) [completes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=697) [This will ensure that all the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=698) [data is produced before the next](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=699) [pass consumes it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=701) [So now, let's switch gears over](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=703) [to the deferred shading pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=705) [Now, we're going to use this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=708) [temporary render target to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=709) [compute material lighting.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=711) [Then, we're going to wait for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=714) [the fence to make sure that it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=716) [been produced before we consume](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=718) [it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=719) [And finally, market is aliasable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=720) [so that we can reuse this for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=723) [other operations, saving](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=725) [hundreds of megabytes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=726) [So now that we've talked about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=728) [how to parallelize and optimize](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=729) [performance with explicit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=731) [control, this is great, but what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=733) [if you want to put the GPU more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=736) [into the driving seat?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=738) [So let's talk about GPU-driven](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=740) [pipelines.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=745) [Your games are moving more and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=745) [more of the decision logic onto](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=747) [the GPU, especially when it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=750) [comes to processing extremely](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=752) [large data sets or scene graphs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=754) [with thousands of objects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=756) [With Metal 2, we've made another](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=758) [really important step forward in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=761) [our focus on GPU-driven](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=763) [pipelines.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=764) [Last year, we introduced](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=766) [indirect argument buffers,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=767) [allowing you to further decrease](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=769) [CPU usage and move a large](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=771) [portion of the workload to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=773) [GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=774) [This year, we're also](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=776) [introducing indirect command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=777) [buffers, and this will allow you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=779) [buffers, and this will allow you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=779) [to move entire rendering loops](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=782) [onto the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=784) [So first, let's briefly recap](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=786) [the argument buffer feature.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=789) [An argument buffer is simply a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=791) [structure represented like this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=792) [Previously, these would have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=797) [only constants, but with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=798) [argument buffers, we can have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=800) [textures and samplers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=801) [Before, these would have to have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=803) [separate shader bind points.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=804) [So since this structure, you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=807) [have all the features of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=810) [Metal shading language at your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=811) [disposal, so it's really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=812) [flexible and really easy.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=814) [You could do things like add](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=816) [substructures, or arrays, or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=817) [even pointers to other argument](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=819) [buffers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=820) [You could modify textures and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=823) [samplers, creating new materials](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=824) [on a GPU without any CPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=826) [involvement.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=829) [Or you can make giant arrays of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=830) [materials and use a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=832) [single-instance draw call to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=834) [render many objects with unique](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=836) [properties.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=838) [So argument buffers allow you to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=840) [offload the material management](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=842) [onto the GPU and save valuable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=845) [CPU resources.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=847) [But this year, we're putting it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=848) [a little bit, extending it a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=850) [little bit more.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=851) [We started by adding 2 new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=853) [argument types.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=855) [This includes pipeline states](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=857) [and command buffers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=859) [Now, these are used to support](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=861) [our brand-new indirect command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=862) [buffer feature.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=864) [With indirect command buffers,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=866) [you could encode entire scenes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=867) [on the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=870) [On the CPU, you only have a few](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=871) [threads available for rendering,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=873) [but on the GPU, you have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=874) [hundreds or even thousands of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=875) [threads all running at the same](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=877) [time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=880) [With indirect command buffers,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=881) [you can fully utilize this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=882) [massively parallel nature.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=884) [Also, indirect command buffers](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=887) [are completely reusable, so you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=889) [could spend the encoding cost](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=891) [once and reuse it again and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=892) [again.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=894) [And since an ICB is a directly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=895) [accessible buffer, you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=897) [accessible buffer, you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=897) [modify its contents at any time,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=900) [like change the shader type, or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=902) [the camera matrix, or anything](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=903) [else that you might need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=905) [change.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=906) [And of course, by moving your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=907) [rendering to the GPU, you remove](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=909) [expensive CPU and GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=911) [synchronization points that are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=913) [normally required to hand over](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=915) [the data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=916) [So let's take a look at an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=918) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=919) [Here is a typical game frame.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=920) [The usual rendering loop has a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=923) [few common stages.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=924) [First, you walk your scene graph](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=927) [to determine which objects you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=929) [need to render.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=930) [You probably use frustum culling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=932) [to determine what objects are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=934) [within the view frustum.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=936) [Some of you might use a more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=938) [complex solution that accounts](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=939) [for occlusion.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=941) [Also, level of detail selection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=942) [naturally occurs at this stage.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=945) [Only once you encode and submit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=947) [your command buffer will the GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=949) [start to consume it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=951) [More and more games are moving](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=955) [the process of determining](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=957) [visible objects onto the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=958) [visible objects onto the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=958) [GPUs are just better at handling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=961) [the growing scene complexity of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=963) [the latest games.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=964) [Unfortunately, this creates a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=966) [sync point in your frame.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=969) [And the, it makes it so that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=972) [CPU cannot encode draw calls](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=974) [until the GPU produces the data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=976) [It's extremely difficult to get](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=978) [this right without wasting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=979) [valuable CPU and GPU time on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=981) [synchronization.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=983) [With ICBs, the benefits are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=985) [immense.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=987) [Not only can you move the final](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=988) [bits of processing to the GPU,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=990) [you naturally remove any sync](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=992) [points required to hand over the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=994) [data and you improve your CPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=995) [and GPU utilization.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=997) [At the same time, you reduce](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=999) [your CPU overhead to a constant.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1002) [So let's look at the encoding in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1004) [a little bit more detail.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1007) [I'm going to start by expanding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1009) [on our previous example and look](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1011) [at the massively parallel nature](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1013) [that only the GPU can provide.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1015) [We could begin with the list of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1017) [visible objects and LODs coming](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1019) [visible objects and LODs coming](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1019) [from our culling dispatch.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1021) [Also, keep in mind that we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1023) [utilizing the power of argument](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1025) [buffers here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1026) [So in this case, each element](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1027) [has a pointer to the actual](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1030) [properties, so we don't need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1032) [store everything in the same](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1034) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1035) [This solution saves us a lot of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1037) [memory and performance, and it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1040) [because we only build a very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1042) [small list of information.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1043) [The actual argument buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1045) [contains several levels of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1047) [detail for geometry.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1048) [This includes position, vertex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1050) [buffer, index buffer, and a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1053) [material argument buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1055) [For rendering, we only select 1](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1057) [of these LODs per object.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1059) [The actual encoding happens in a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1061) [compute kernel, and we encode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1065) [into an indirect command buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1067) [Each thread of the compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1069) [kernel encodes a single draw](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1071) [call.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1073) [So we read the object with all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1074) [of its properties, and we encode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1075) [these into the ICB.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1078) [these into the ICB.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1078) [There's a couple of details](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1081) [worth noting.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1083) [You can think of an ICB as an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1084) [array of render commands.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1086) [A render command consists of a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1087) [pipeline object with shaders,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1089) [any number of buffers, and a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1091) [draw call.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1092) [Next, an ICB is built for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1094) [parallelism, so you could encode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1096) [concurrently and out of order.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1098) [And lastly, we kept the API very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1100) [simple, so it's just like what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1103) [you might be doing today on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1105) [CPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1106) [Another thing -- each command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1108) [could have different properties](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1109) [and even draw types.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1111) [So this is a really, really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1112) [significant step forward from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1115) [all the flavors of indirect](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1116) [rendering that many of you may](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1117) [have seen elsewhere.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1118) [Now, let's take a look at how we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1120) [can do this in your code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1122) [So this is how easy it is to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1124) [encode a draw call.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1126) [The first thing you're going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1128) [do is select the render command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1129) [by index using your thread ID.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1131) [Then, we're going to set the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1134) [properties.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1136) [So in this example, we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1137) [setting a shader with a pipeline](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1138) [setting a shader with a pipeline](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1138) [state and then a separate buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1140) [for the geometry and material.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1143) [And finally, this is how you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1145) [encode a draw call.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1147) [Thanks to the Metal shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1149) [language, encoding on the GPU is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1150) [really, really simple.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1151) [Even though this is in a compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1153) [shader, this looks just like](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1155) [what you're already doing on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1157) [CPU today.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1158) [Now, let's look at 1 more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1158) [sample.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1161) [Here are some of the basic](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1163) [things you need to do to create,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1164) [encode, and execute an ICB.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1166) [To create it, you first fill out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1169) [a descriptor.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1171) [The descriptor contains things](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1173) [like draw types, and inheritance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1174) [properties, and per-stage bind](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1178) [counts.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1179) [This describes the way that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1180) [indirect buffer will behave.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1182) [When it's time to encode the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1184) [ICB, you simply create compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1187) [encoder and call dispatch just](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1189) [like what you've been doing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1190) [already.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1191) [Once the ICB is encoded, you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1194) [optionally decide if you want to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1195) [optimize it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1197) [When you optimize it, you remove](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1198) [all the redundant state, and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1199) [all the redundant state, and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1199) [end result is a lean and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1201) [highly-efficient set of GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1203) [commands.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1204) [Now, once the ICB is encoded and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1206) [optimized, it's time to schedule](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1208) [it for execution.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1210) [You notice here that you could](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1211) [actually specify the exact range](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1212) [of commands that you execute.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1214) [Also in this example, we use an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1217) [indirect buffer, which itself](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1218) [can be encoded with a GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1221) [So once the ICB is encoded, it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1225) [could be reused again and again,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1228) [and the overhead is completely](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1229) [negligible.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1231) [So I'm really excited, but we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1232) [actually went ahead and we put](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1233) [together a sample so you could](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1235) [take a look.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1236) [So here you could see a number](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1239) [of school buses in the middle of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1241) [a city.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1242) [Each bus is composed of 500,000](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1243) [polygons and 2000 individual](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1246) [parts.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1249) [Each part requires a separate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1250) [draw call, its own material](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1253) [argument buffer, index buffer,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1255) [and vertex buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1256) [As you could imagine, this would](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1258) [As you could imagine, this would](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1258) [be a lot of API calls on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1260) [CPU, but we are using indirect](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1262) [command buffers here, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1264) [everything is being encoded on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1265) [the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1266) [We're also selecting the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1269) [appropriate level of detail, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1270) [therefore, we're able to render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1272) [multiple objects without](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1273) [increasing the CPU or GPU cost.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1276) [So on the left, you could see a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1279) [view of the regular camera.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1280) [And on the right, we've zoomed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1282) [in to a single bus, so you could](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1283) [see the level of detail actually](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1285) [changing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1287) [ICBs enabled us to introduce](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1289) [another really incredible](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1291) [optimization.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1292) [We're able to split the geometry](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1295) [into chunks of a few hundred](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1297) [triangles and analyze those](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1299) [chunks in a separate compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1300) [kernel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1301) [You could see the chunks in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1303) [different colors on the screen.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1304) [Each thread of the kernel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1307) [determines whether triangles are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1308) [facing away from the camera or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1309) [if they're obscured by other](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1311) [objects or geometry in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1312) [scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1314) [This is all really, really fast](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1315) [because we've performed the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1317) [calculation for a chunk only and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1318) [calculation for a chunk only and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1318) [not on each individual triangle.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1320) [We then tell the GPU to only](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1323) [render the chunks that are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1325) [actually visible.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1326) [And again, let's see the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1327) [side-by-side view.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1331) [The left side is your camera](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1333) [view, and the right side is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1334) [another view of the bus.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1336) [You could see the red and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1338) [pinkish tint there.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1340) [That is what our compute shaders](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1341) [determined is invisible.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1342) [We never actually send this work](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1345) [to the GPU, so it saves us 50%](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1347) [or more of the geometry](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1350) [rendering cost.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1351) [Here's 1 last view showing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1355) [which, how much this technique](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1358) [could save you.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1360) [So notice on the right, many of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1361) [the buses and ambulances are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1363) [actually invisible.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1364) [This is really amazing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1370) [I love this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1372) [So please take a chance to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1373) [explore the code, and I hope](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1375) [I'll see this technology in some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1377) [of your games in the future.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1378) [I think if utilized, ICBs can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1380) [really push your games to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1382) [next level.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1383) [So now, I'm pleased to introduce](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1385) [Michael, who will show you how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1387) [to optimize for the A11, improve](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1389) [performance, and extend](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1391) [playtime.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1392) [Thank you very much.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1393) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1395) [&gt;&gt; Thanks, Brian.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1400) [So everything Brian's just](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1402) [showed you is available for iOS,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1403) [tvOS, and macOS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1405) [Next, I'm going to dive into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1407) [some of the new Metal 2 features](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1409) [for Apple's latest GPU, the A11](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1410) [Bionic, designed to help you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1412) [maximize your game's performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1414) [and extend your playtime by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1415) [reducing system memory bandwidth](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1417) [and reducing power consumption.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1419) [So Apple-designed GPUs have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1425) [tile-based deferred rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1426) [architecture designed for both](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1427) [high performance and low power.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1429) [This architecture takes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1432) [advantage of a high bandwidth,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1433) [low-latency tile memory that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1434) [eliminates overdraw and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1437) [unnecessary memory traffic.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1438) [Now, Metal is designed to take](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1442) [advantage of the TBDR](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1443) [architecture automatically](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1445) [within each render pass, load](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1446) [and store actions, make explicit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1448) [how render pass attachments move](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1450) [in and out of tile memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1451) [But the A11 GPU takes the TBDR](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1456) [architecture even further.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1458) [We added new capabilities to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1460) [tile memory and added an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1461) [entirely new programmable stage.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1463) [This opens up new optimization](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1465) [opportunities critical to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1467) [advanced rendering techniques,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1468) [such as deferred shading,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1470) [order-independent transparency,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1472) [tiled forward shading, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1474) [particle rendering.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1475) [So let's start by taking a look](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1477) [at the architecture of the A11](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1479) [GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1480) [All right.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1484) [So on the left, we have a block](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1484) [representation of the A11 GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1486) [And on the right, we have system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1487) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1489) [Now, the A11 GPU first processes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1491) [all the geometry of a render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1493) [pass in the vertex stage.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1494) [It transforms and bends your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1497) [geometry into screen-aligned,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1498) [geometry into screen-aligned,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1498) [tiled vertex buffers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1500) [These tiled vertex buffers are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1502) [then stored in the system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1503) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1504) [Now, each tiled vertex buffer is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1507) [then processed entirely on ship](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1508) [as part of the fragment stage.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1510) [This tiled architecture enables](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1513) [2 major optimizations that your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1515) [games get for free.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1516) [First, the GPU rasterizes all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1519) [primitives in a tile before](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1522) [shading any pixels using fast,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1523) [on-ship memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1525) [This eliminates overdraw, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1526) [improves performance and reduces](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1528) [power.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1530) [Second, a larger, more flexible](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1532) [tile memory is used to store the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1535) [shaded fragments.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1536) [Blending operations are fast](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1538) [because all the data is stored](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1539) [on ship next to the shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1540) [cores.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1542) [Now, tile memory is written to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1543) [system memory only once for each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1546) [tile after all fragments have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1548) [been shaded.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1549) [This reduces bandwidth, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1551) [also improves your performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1552) [and reduces your power.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1554) [Now, these optimizations happen](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1556) [underneath the hood.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1559) [You get them just by using Metal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1560) [on iOS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1561) [But Metal also lets you optimize](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1563) [rendering techniques by taking](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1564) [explicit control of the A11's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1566) [tile memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1567) [Now, during the development of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1569) [the A11 GPU, the hardware and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1572) [software teams at Apple analyzed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1573) [a number of important modern](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1575) [rendering techniques.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1576) [We accelerated, we noticed many](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1578) [common themes, and we found that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1580) [explicit control of our tile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1582) [memory accelerated all of them.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1583) [We then developed the hardware](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1587) [and software features together](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1588) [around this idea of explicit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1589) [control.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1590) [So let's talk about these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1592) [features.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1594) [So programmable blending lets](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1601) [you write custom blend](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1602) [operations in your shaders.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1603) [It's also a powerful tool you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1605) [can use to merge render passes,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1606) [and it's actually made available](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1608) [across all iOS GPUs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1609) [Imageblocks are new for A11.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1612) [They let you maximize your use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1613) [of tile memory by controlling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1615) [pixel layouts directly in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1616) [shading language.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1618) [And tile shading is our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1619) [And tile shading is our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1619) [brand-new programmable stage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1622) [designed for techniques that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1623) [require mixing graphics and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1624) [compute processing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1625) [Persistent threadgroup memory is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1628) [an important tool for combining](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1629) [render and compute that allows](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1631) [you to communicate across both](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1632) [draws and dispatches.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1633) [And multi-sample color coverage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1635) [control lets you perform resolve](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1638) [operations directly in tile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1640) [memory using tile shaders.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1641) [So I'm going to talk to you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1645) [about all these features, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1646) [let's start with programmable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1647) [blending.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1647) [With programmable blending, your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1648) [fragment shader has read and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1653) [write access to pixels and tile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1654) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1655) [This lets you write custom](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1656) [blending operations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1657) [But programmable blending also](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1660) [lets you eliminate system memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1662) [bandwidth by combining multiple](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1663) [render passes that read and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1665) [write the same attachments.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1666) [Now, deferred shading is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1669) [particularly good fit for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1670) [programmable blending, so let's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1672) [take a closer look at that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1673) [So deferred shading is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1678) [many-light technique](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1679) [many-light technique](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1679) [traditionally implemented using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1680) [2 passes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1681) [In the first pass, multiple](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1683) [attachments are filled with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1684) [geometry attributes visible at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1685) [each pixel, such as normal,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1687) [albedo, and roughness.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1689) [And in the second pass,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1692) [fragments are shaded by sampling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1693) [those G-buffer attachments.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1694) [Now, the G-buffers are stored in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1696) [the system memory before being](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1700) [read again in the lighting pass,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1701) [and this round trip from tile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1703) [memory to system memory and back](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1704) [again can really bottleneck your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1706) [game because the G-buffer track](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1708) [consumes a large amount of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1709) [bandwidth.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1710) [Now, programmable blending](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1711) [instead lets you skip that round](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1713) [trip to memory by reading the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1715) [current pixel's data directly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1716) [from tile memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1718) [This also means that we no](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1722) [longer need 2 passes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1723) [Our G-buffer fill and lighting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1724) [steps are now encoded and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1726) [executed in a single render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1728) [pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1729) [It also means that we no longer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1731) [need a copy of the G-buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1732) [attachments in system memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1734) [And with memory, Metal's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1736) [memoryless render target](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1739) [memoryless render target](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1739) [feature, saving that memory is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1740) [really, really simple.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1742) [You just create a texture with a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1743) [memoryless flag set, and Metal's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1744) [only going to let you use it as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1746) [an attachment without load or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1748) [store actions.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1749) [So now, let's take a look at how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1750) [easy it is to adopt programmable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1753) [blending in your shaders.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1754) [Okay, so here's what the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1756) [fragment shader of your lighting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1760) [pass would look like with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1761) [programmable blending.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1762) [Programmable blending is enabled](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1764) [when you both read and write](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1765) [your attachments.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1766) [And in this example, we see that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1767) [the G-buffer attachments are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1769) [both inputs and outputs to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1770) [functions.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1772) [We first calculate our lighting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1772) [using our G-buffer properties.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1776) [As you can see here, we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1778) [reading our attachments and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1779) [we're not sampling them as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1781) [textures.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1781) [We then accumulate our lighting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1782) [result back into the G-buffer,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1785) [and, in this step, we're both](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1787) [reading and writing our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1788) [accumulation attachments.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1789) [So that's it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1790) [Programmable blending is really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1792) [that easy, and you should it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1793) [where, whenever you have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1795) [multiple render passes that read](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1796) [and write the same attachments.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1798) [So now, let's talk about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1800) [imageblocks, which allow you to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1802) [merge render passes in even more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1804) [circumstances.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1805) [Imageblocks give you full](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1812) [control of your data in tile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1813) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1814) [Instead of describing pixels as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1815) [arrays of render pass](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1817) [attachments in the Metal API,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1818) [imageblocks let you declare your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1821) [pixel layouts directly in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1822) [shading language as structs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1824) [It adds new pack data types to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1828) [the shading language that match](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1829) [the texture formats you already](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1830) [use, and these types are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1831) [transparently packed and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1833) [unpacked when accessing the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1835) [shader.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1836) [In fact, you can also use these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1837) [new pack data types in your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1839) [vertex buffers and constant](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1840) [buffers to more tightly pack all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1842) [of your data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1843) [Imageblocks also let you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1846) [describe more complex per-pixel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1847) [data structures.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1849) [You can use arrays, nested](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1851) [structs, or combinations](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1852) [thereof.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1854) [It all just works.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1855) [Now, direct control of your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1859) [Now, direct control of your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1859) [pixel layout means that you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1861) [now change the layout within a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1862) [pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1863) [This lets you combine render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1864) [passes to eliminate system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1866) [memory bandwidth in ways that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1867) [just weren't possible with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1868) [programmable blending alone.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1869) [Let's take a look at an example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1871) [So in our previous example, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1875) [used programmable blending to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1876) [implement single-pass deferred](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1878) [shading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1879) [You can also implement](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1880) [single-pass deferred shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1881) [using imageblocks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1882) [Imageblocks only exist in tile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1885) [memory, so there's no render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1886) [pass attachments to deal with.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1887) [Not only is this a more natural](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1889) [way to express the algorithm,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1891) [but now you're free to reuse the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1892) [tile memory once you're finished](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1894) [reading the G-buffer after your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1895) [lighting.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1897) [So let's go ahead and do that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1898) [Let's reuse the tile memory to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1899) [add an order-independent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1901) [transparency technique called](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1903) [multi-layer alpha blending.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1904) [So multi-layer alpha blending,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1911) [or MLAB, maintains a per-pixel,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1912) [fixed-size array of translucent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1915) [fragments.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1917) [Each incoming fragment is sorted](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1918) [Each incoming fragment is sorted](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1918) [by depth into the array.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1920) [If a fragment's depth lies](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1922) [beyond the last element of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1923) [array, then those elements are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1924) [merged, so it's really an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1926) [approximation, approximate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1927) [technique.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1929) [Now, sorting the MLAB array is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1931) [really fast because it lives in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1932) [tile memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1934) [Doing the same off chip would be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1935) [really expensive because of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1936) [extra bandwidth and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1938) [synchronization overhead.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1939) [Now, the A11 actually doubles](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1940) [the maximum supported pixel size](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1945) [over your previous generation,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1946) [but that's still not going to be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1948) [enough to contain both the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1950) [G-buffer and MLAB data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1951) [structures simultaneously.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1953) [Fortunately, you don't need both](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1955) [at the same time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1957) [Imageblocks let you change your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1958) [pixel layouts inside the render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1960) [pass to match your current](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1961) [needs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1963) [So changing pixel layouts](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1964) [actually requires tile shading,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1967) [so let's talk about that next.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1968) [So tile shading is the new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1976) [programmable stage that provides](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1978) [compute capabilities directly in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1979) [compute capabilities directly in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1979) [the render pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1981) [This stage is going to execute a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1982) [configurable threadgroup for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1984) [each tile.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1985) [For example, you can launch a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1986) [single thread per tile, or you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1987) [can launch a thread per pixel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1989) [Now, tile shading lets you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1994) [interleave draw calls and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1995) [threadgroup dispatches that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1996) [operate on the same data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1997) [Tile shaders have access to all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=1999) [of tile memory, so they can read](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2001) [and write any pixel of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2003) [imageblock.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2004) [So let's look at how tile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2006) [shading can optimize techniques](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2007) [such as tiled forward shading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2009) [So like deferred shading, tiled](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2014) [forward shading is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2016) [many-layered technique.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2017) [It's often used when MSA is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2018) [important or when a variety of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2019) [materials are needed and works](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2021) [equally well for both opaque and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2023) [translucent geometry.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2024) [Now, tiled forward shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2026) [traditionally consists of 3](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2028) [passes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2029) [First, a render pass generates a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2031) [scene depth buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2033) [Second, a compute pass](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2035) [generates, calculates per-tile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2036) [depth bounds and per-tile light](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2038) [depth bounds and per-tile light](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2038) [lists using that scene depth](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2040) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2042) [And finally, another render pass](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2043) [is going to shade the pixels in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2044) [each tile using the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2045) [corresponding light list.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2047) [Now, this pattern of mixing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2048) [render with compute occurs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2053) [frequently.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2054) [And prior to A11, communicating](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2054) [across these passes required](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2057) [system memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2058) [But with tile shading, we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2059) [inline the compute so that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2061) [render passes can be merged.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2062) [Here the depth bounds and light](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2066) [culling steps are now](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2068) [implemented as tile shaders and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2069) [inlined into a single render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2071) [pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2072) [Depth is now only stored in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2073) [imageblock and, but is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2074) [accessible across the entire](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2076) [pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2082) [So, now, tile shading is going](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2082) [to help you eliminate a lot of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2084) [bandwidth, but these tile shader](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2085) [outputs are still being stored](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2087) [to system memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2088) [Tile shader dispatches are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2090) [synchronized with draws, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2091) [that's completely safe to do,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2093) [but I think we could still do](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2094) [better using our next feature,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2095) [persistent threadgroup memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2097) [Okay, so threadgroup memory is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2105) [well-known feature of Metal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2106) [compute.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2107) [It lets threads within a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2108) [threadgroup share data using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2109) [fast, on-ship memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2111) [Now, thanks to tile shading,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2113) [threadgroup memory is now also](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2114) [available in the render pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2116) [But threadgroup memory in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2118) [render pass has 2 new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2119) [capabilities not traditionally](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2120) [available to compute.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2121) [First, a fragment shader now](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2123) [also has access to the same](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2125) [threadgroup memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2126) [And second, the contents of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2128) [threadgroup memory persist](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2129) [across the entire life of a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2130) [tile.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2131) [Taken together, this makes a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2133) [powerful tool for sharing data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2135) [across both draws and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2137) [dispatches.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2138) [In fact, we believe it's so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2140) [useful that we've actually](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2141) [doubled the maximum size of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2142) [threadgroup memory over our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2143) [previous generation so that you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2144) [can store more of your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2146) [intermediate data on ship.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2147) [Okay, so now, let's use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2150) [threadgroup persistence to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2151) [further optimize our tiled](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2152) [forward shading example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2154) [So with persistence, tile, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2155) [So with persistence, tile, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2155) [tile shading stage can now write](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2160) [both the depth bounds and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2162) [culled light lists into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2163) [threadgroup memory for later](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2165) [draws to use.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2166) [This means that now all our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2168) [intermediate data stays on ship](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2169) [and never leaves the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2171) [Only the final image is stored](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2173) [at system memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2174) [Minimizing bandwidth to system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2176) [memory is, again, very important](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2177) [for your game's performance and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2179) [playtime.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2181) [Now, let's take a look at how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2181) [easy it is to make use of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2184) [persistence in the shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2185) [language.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2187) [Okay, so the top function here](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2191) [is our tile shader, and it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2193) [going to perform our light](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2194) [culling.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2195) [It intersects each light with a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2195) [per-tile frustum to compute an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2197) [active light mask.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2199) [The bottom function is our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2201) [fragment shader that performs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2203) [our forward shading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2204) [It shades only the lights](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2205) [intersecting the tile using that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2206) [active light mask.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2208) [Now, sharing threadgroup memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2211) [across these functions is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2213) [achieved by using the same type](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2214) [and bind point across both](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2216) [shaders.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2218) [That's how easy it is to take](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2220) [advantage of threadgroup](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2221) [persistence.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2222) [Okay, so now that you've seen](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2225) [tile shading and threadgroup](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2227) [persistence, let's revisit our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2228) [order-independent transparency](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2230) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2231) [Okay, so remember how I said](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2234) [that changing imageblock layouts](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2235) [requires tile shading?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2237) [That's because tile shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2238) [provides the synchronization we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2240) [need to safely change layouts.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2242) [This means we actually have to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2244) [insert a tile shade between the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2246) [lighting and the MLAB steps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2247) [So tile shading is going to wait](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2253) [for the lighting stage to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2254) [complete before transitioning](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2255) [from G-buffer layout to MLAB](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2256) [layout, and it's also going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2258) [carry forward the accumulated](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2260) [lighting value from the lighting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2261) [step into the MLAB step for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2262) [final blending.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2264) [Okay, so now that we've covered](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2269) [imageblocks, tile shading, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2270) [threadgroup persistence, it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2272) [time to move on to our final](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2273) [topic, multi-sample](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2274) [anti-aliasing and sample](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2276) [coverage control.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2278) [So multi-sample anti-aliasing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2283) [improves image quality by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2284) [supersampling depth, stencil,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2286) [and blending, but shades only](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2288) [once per pixel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2290) [Multiple samples are later](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2291) [resolved into a final image](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2293) [using simple averaging.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2294) [Now, multi-sampling is efficient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2298) [on all A series GPUs because](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2299) [samples are stored in tile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2301) [memory, where blending and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2303) [resolve operations have fast](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2304) [access to the samples.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2305) [The A11 GPU optimizes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2309) [multi-sampling even further by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2311) [tracking the unique colors](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2313) [within each pixel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2314) [So blending operations that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2316) [previously operated on each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2317) [sample now only operate on each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2318) [color.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2320) [This could be a significant](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2321) [savings because the interior of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2322) [every triangle only contains 1](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2324) [unique color.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2325) [Now, this mapping of unique](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2329) [color to samples is called color](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2330) [coverage control, and it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2333) [managed by the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2334) [But tile shaders can also read](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2336) [and modify this color coverage.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2337) [And we can use this to perform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2340) [custom resolves in place and in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2342) [fast tile memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2344) [Now, to see why this is useful,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2346) [let's take a look at a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2347) [multi-sampled scene that also](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2348) [renders particles.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2350) [Now, particles are transparent,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2354) [so we blend them after rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2355) [our opaque scene geometry.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2357) [But particle rendering doesn't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2359) [benefit from multi-sampling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2360) [because it doesn't really have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2361) [any visible edges.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2362) [So to avoid the extra cost of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2364) [blending per sample for no good](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2366) [reason, a game would render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2367) [using 2 passes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2369) [In the first pass, your opaque](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2370) [scene geometry is rendered using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2372) [multi-sampling to reduce](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2373) [aliasing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2375) [And then, you're going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2376) [resolve your color and depth to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2377) [system memory, and we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2378) [resolving depth because](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2380) [particles can later be included.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2381) [Then in the second pass, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2383) [resolve color and depth are used](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2385) [in rendering the particles](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2387) [without multi-sampling.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2388) [Now, as you probably guessed by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2391) [now, our goal is to eliminate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2392) [the intermediate system memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2394) [traffic using tile shading to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2395) [combine these 2 passes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2396) [But tile shading alone isn't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2401) [enough.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2402) [We need color coverage control](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2402) [to change the multi-sampling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2404) [rate in place.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2405) [Using color coverage control is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2407) [really powerful and really easy.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2408) [Let's take a look at the shader.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2411) [Okay, so remember that our goal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2416) [here is to average the samples](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2417) [of each pixel and then store](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2419) [that result back into the image](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2420) [block as the overall pixel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2422) [value.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2423) [Now, instead of looping through](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2425) [each color, through each sample,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2427) [we're going to take advantage of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2429) [the color rate capabilities of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2430) [the A11 and only loop through](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2432) [unique colors.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2433) [To properly average across all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2436) [samples, we need to weigh each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2438) [color by the number of samples](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2440) [associated with it, and we do](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2441) [this by counting the bit set in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2443) [the color coverage mask.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2446) [We then complete our averaging](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2449) [by dividing by the total number](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2450) [of samples and, finally, write](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2451) [the result back into the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2454) [imageblock.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2456) [The output sample mask tells](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2457) [Metal to apply the results to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2458) [Metal to apply the results to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2458) [all samples of the pixel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2460) [And since all samples now share](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2461) [the same value, the later](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2463) [particle draws are going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2465) [blend per pixel rather than per](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2466) [sample.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2468) [So that's it for sample coverage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2471) [control.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2472) [Now, optimizing for Apple GPUs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2475) [is really important for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2478) [maximizing your game's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2479) [performance and extending its](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2480) [playtime, but there's a lot more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2481) [work that goes into shipping a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2483) [tile in iOS, especially one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2485) [that's originally designed for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2487) [desktops and consoles.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2487) [To talk about that now and to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2489) [put into practice what we just](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2491) [discussed, I'd like to bring on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2492) [Nick Penwarden from Epic Games.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2494) [Nick?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2496) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2498) [&gt;&gt; Thank you, Michael.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2501) [So, yeah. I'd like to talk a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2502) [little bit about how we took a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2504) [game that was originally made](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2506) [for desktop and console](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2507) [platforms and brought it to iOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2510) [using Metal.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2512) [So some of the technical](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2513) [challenges we faced.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2516) [The Battle Royale map is 1 map.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2517) [The Battle Royale map is 1 map.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2517) [It's larger than 6 kilometers](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2520) [squared.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2521) [That means that it will not all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2522) [fit into memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2524) [We also have dynamic time of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2526) [day, destruction.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2527) [Players can destroy just about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2529) [any object in the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2530) [Players can also build their own](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2532) [structures.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2533) [So the map is very dynamic,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2534) [meaning we can't do a lot of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2535) [precomputation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2536) [We have 100 players in the map,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2538) [and the map has over 50,000](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2541) [replicating actors that are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2544) [simulated on the server and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2545) [replicated down to the client.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2547) [Finally, we wanted to support](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2549) [crossplay between console and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2551) [desktop players along with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2553) [mobile.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2554) [And that's actually a really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2556) [important point because it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2557) [limited the amount that we could](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2558) [scale back the game in order to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2559) [fit into the performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2562) [constraints of the device.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2565) [Basically, if something affected](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2567) [gameplay, we couldn't change it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2568) [So if there's an object and it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2570) [really small, it's really far](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2572) [away, maybe normally you would](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2573) [cull it, but in this case, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2575) [can't because if a player can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2577) [hide behind it, we need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2578) [hide behind it, we need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2578) [render it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2580) [So want to talk a little bit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2582) [about Metal.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2584) [Metal is really important in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2585) [terms of allowing us to ship the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2587) [game as fast as we did and at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2589) [the quality that we were able to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2592) [achieve.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2593) [Draw call performance was key to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2594) [this because, again, we have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2595) [really complicated scene and we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2597) [need the performance to render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2600) [it, and Metal gave us that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2602) [performance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2603) [Metal also gave us access to a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2604) [number of hardware features,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2606) [such as programmable blending,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2607) [that we used to get important](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2608) [GPU performance back.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2610) [It also has a feature set that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2612) [allowed us to use all of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2613) [rendering techniques we need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2614) [bring Fortnite to iOS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2616) [In terms of rendering features,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2618) [we use a movable directional](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2620) [light for the sun with cascaded](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2622) [shadow maps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2623) [We have a movable skylight](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2624) [because the sky changes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2625) [throughout the day.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2626) [We use physically-based](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2627) [materials.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2629) [We render in HDR and have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2631) [tone-mapping pass at the end.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2632) [We allow particle simulation on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2635) [the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2637) [And we also support all of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2638) [artist-authored materials.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2639) [artist-authored materials.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2639) [It's actually a pretty important](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2641) [point because some of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2643) [materials are actually very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2645) [complicated.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2647) [For instance, the imposters that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2648) [we use to render trees in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2650) [distance efficiently were](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2652) [entirely created by a technical](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2653) [artist at Epic using a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2654) [combination of blueprints and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2656) [the material shader graph.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2659) [So in terms of where we ended](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2662) [up, here is an image of Fortnite](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2664) [running on a Mac at high](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2665) [scalability settings.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2667) [Here it is running on a Mac at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2670) [medium scalability settings.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2671) [And here it is on an iPhone 8](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2674) [Plus.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2676) [So we were able to faithfully](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2677) [represent the game on an iPhone](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2678) [about at the quality that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2681) [achieve on a mid-range Mac.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2682) [So let's talk a little bit about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2684) [scalability.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2688) [We deal with scalability both](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2689) [across platforms as well as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2690) [within the iOS ecosystem.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2692) [So across platform, this is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2694) [stuff that we need to fit on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2695) [platform at all, like removing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2697) [LODs from meshes that will never](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2699) [LODs from meshes that will never](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2699) [display so we can fit in memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2701) [or changing the number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2703) [characters that we animate at a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2706) [particular quality level in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2708) [order to reduce CPU costs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2710) [Within iOS, we also defined 3](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2712) [buckets for scalability -- low,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2714) [mid, and high -- and these were](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2717) [generally correlated with the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2719) [different generations of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2720) [iPhones, so iPhone 6s on the low](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2721) [end, iPhone 7 was our mid-range](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2724) [target, and the iPhone 8 and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2726) [iPhone X on the high end.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2727) [Resolution was obviously the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2731) [simplest and best scalability](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2734) [option that we had.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2736) [We ended up tuning this per](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2737) [device.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2738) [We preferred to use backbuffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2739) [resolution where possible --](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2741) [this is what the UI renders at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2742) [-- because if we do this, then](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2744) [we don't have to pay a separate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2745) [upsampling cost.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2747) [However, we do support rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2749) [3D resolution at a lower](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2750) [resolution, and we do so in some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2752) [cases where we needed a crisp UI](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2754) [but had to reduce 3D render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2756) [resolution lower than that in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2758) [resolution lower than that in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2758) [order to meet our performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2760) [goals -- the iPhone 6s, for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2761) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2763) [Shadows were another axis of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2766) [scalability and actually really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2767) [important because they impact](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2769) [both the CPU and the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2770) [On low-end devices, we don't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2773) [render any shadows at all.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2775) [On our mid-range target, we have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2776) [1 cascade, 1024 by 1024.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2777) [We set the distance to be about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2781) [the size of a building, so if](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2782) [you're inside of a structure,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2784) [you're not going to see light](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2785) [leaking on the other side.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2786) [High-end phones add a second](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2788) [cascade, which gives crisper](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2789) [character shadows as well as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2791) [lets us push out the shadowing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2792) [distance a little further.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2794) [Foliage was another axis of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2797) [scalability.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2798) [On low-end devices, we simply](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2799) [don't render foliage.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2801) [On the mid range, we render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2802) [about 30% of the density we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2803) [support on console.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2805) [And on high-end devices, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2806) [actually render 100% of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2807) [density that we support on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2809) [console.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2810) [Memory is interesting in terms](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2813) [of scalability because it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2815) [doesn't always correlate with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2817) [performance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2818) [For instance, an iPhone 8 is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2819) [For instance, an iPhone 8 is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2819) [faster than an iPhone 7 Plus,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2820) [but it has less physical memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2822) [This means when you're taking](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2824) [into account scalability, you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2825) [need to treat memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2826) [differently.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2827) [We ended up treating it as an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2827) [orthogonal axis of scalability](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2829) [and just had 2 buckets, low](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2832) [memory and high memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2834) [For low-memory devices, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2836) [disabled foliage and shadows.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2837) [We also reduced some of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2839) [memory pool.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2840) [So for instance, we limited GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2841) [particles to a total of 16,000](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2843) [and reduced the pool use for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2845) [cosmetics and texture memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2847) [We still need to do quite a bit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2849) [of memory optimization in order](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2852) [to get the game to fit on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2854) [device.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2855) [The most important was level](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2856) [streaming -- basically, just](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2857) [making sure that nothing is in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2858) [memory that is not around the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2860) [player.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2861) [We also used ASTC texture](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2862) [compression and tend to prefer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2864) [compressing for size rather than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2866) [quality in most cases.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2868) [And we also gave our artists a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2870) [lot of tools for being able to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2872) [cook out different LODs that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2874) [aren't needed or reduce audio](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2877) [variations on a per-platform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2879) [variations on a per-platform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2879) [basis.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2881) [Want to talk a little bit about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2884) [frame rate targets.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2885) [So on iOS, we wanted to target](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2887) [30 fps at the highest visual](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2888) [fidelity possible.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2890) [However, you can't just max out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2892) [the device.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2893) [If we were maxing out the CPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2894) [and the GPU the entire time, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2895) [operating system would end up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2897) [downclocking us, then we'd no](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2899) [longer hit our frame rates.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2901) [We also want to conserve battery](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2902) [life.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2904) [If players are playing several](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2905) [games in a row during their](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2906) [commute, we want to support that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2907) [rather than their device dying](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2910) [before they even make it to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2911) [work.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2912) [So for this, what we decided to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2913) [do was to target 60 frames per](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2916) [second for the environment, but](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2918) [vsync at 30, which means most of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2919) [the time when you're exploring](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2921) [the map in Fortnite, your phone](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2923) [is idle about 50% of the time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2925) [Using that time to conserve](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2927) [battery life and keep cool.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2928) [To make sure that we hit those](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2932) [targets, we track performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2933) [every day.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2936) [So every day, we have an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2937) [automation pass that goes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2938) [automation pass that goes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2938) [through.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2940) [We look at key locations in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2940) [map, and we capture performance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2944) [So for instance, Tilted Towers,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2946) [and Shifty Shafts, and all of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2948) [the usual POIs that you're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2949) [familiar with in Battle Royale.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2951) [When one goes over budget, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2953) [know we need to dive in, figure](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2955) [out where performance is going,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2956) [and optimize.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2957) [We also have daily 100-player](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2958) [playtests where we capture the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2960) [dynamic performance that you'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2962) [only see during a game.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2963) [We track key performance over](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2965) [time for the match, and then we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2966) [can take a look at this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2969) [afterwards and see how it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2970) [performed, look for hitches,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2972) [stuff like that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2974) [And if something looks off, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2975) [can pull an instrumented profile](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2977) [off of the device, take a look](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2979) [at where time was going, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2981) [figure out where we need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2982) [optimize.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2983) [We also support replays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2985) [This is a feature in Unreal that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2986) [allow us to go and replay that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2988) [match from a client perspective.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2990) [So we can play it over and over,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2991) [analyze it, profile it, and even](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2993) [see how optimizations would have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2995) [affected the client in that play](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2997) [session.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2999) [session.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=2999) [Going to talk a little bit about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3001) [metal specifically.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3003) [So we, on most devices, we have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3005) [2 cores, right, and so the way](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3009) [we utilize that is we have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3011) [traditional game](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3014) [thread/rendering thread split.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3014) [On the game thread, we're doing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3016) [networking, simulation,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3017) [animation, physics, and so on.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3019) [The rendering thread does all of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3021) [scene traversal, culling, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3022) [issues all of the Metal API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3024) [calls.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3025) [We also have an async thread.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3026) [Mostly, it's handling streaming](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3029) [tasks -- texture streaming as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3031) [well as level streaming.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3032) [On newer devices where we have 2](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3036) [fast and 4 efficient cores, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3037) [add 3 more task threads and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3039) [enable some of the parallel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3041) [algorithms available in Unreal.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3042) [So we take animation, put it,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3044) [simulate it over on multiple](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3047) [frames, CPU particles, physics,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3048) [and so on, scene culling, a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3051) [couple other tasks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3053) [I mentioned draw calls earlier.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3057) [Draw calls were our main](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3059) [Draw calls were our main](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3059) [performance bottleneck, and this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3060) [is actually where Metal really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3062) [helped us out.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3063) [We found Metal to be somewhere](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3065) [on the order of 3 to 4 times](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3067) [faster than OpenGL for what we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3068) [were doing, and that allowed us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3070) [to ship without doing a lot of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3072) [aggressive work trying to reduce](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3074) [draw calls.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3075) [We did stuff to reduce draw](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3076) [calls, mostly pulling in cull](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3077) [distance on decorative objects](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3079) [as well as leveraging the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3080) [hierarchical level of detail](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3083) [system.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3084) [So here's an example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3087) [This is one of those POIs that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3089) [we tracked over time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3090) [If you're familiar with the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3092) [game, this is looking down on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3093) [Tilted Towers from a cliff and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3094) [was kind of our draw call hot](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3098) [spot in the map.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3100) [As you can see, it takes about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3101) [1300 draw calls to render this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3102) [This is just for the main pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3105) [It doesn't include shadows, UI,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3106) [anything else that consumed draw](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3108) [call time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3110) [But Metal's really fast here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3111) [On an iPhone 8 Plus, we were](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3112) [able to chew through that in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3113) [under 5 milliseconds.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3115) [I mentioned hierarchical LOD.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3118) [This is a feature we have in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3119) [This is a feature we have in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3119) [Unreal where we can take](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3121) [multiple draw calls and generate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3123) [a simplified version, a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3124) [simplified mesh, as well as a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3126) [material so that we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3128) [basically render a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3129) [representation of that area in a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3130) [single draw call.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3134) [We use this for taking POIs and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3135) [generating the simplified](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3138) [versions for rendering very,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3139) [very far away.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3140) [For instance, during the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3142) [skydive, you can see the entire](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3142) [map.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3144) [In fact, when you're on the map,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3145) [you can get on a cliff or just](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3146) [build a very high tower of your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3148) [own and see points of interest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3149) [from up to 2 kilometers away.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3152) [Digging into some of the other](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3155) [details on the Metal side, I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3158) [want to talk a little bit about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3160) [pipeline state objects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3161) [This was something that took us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3162) [a little bit of time to get into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3163) [a shippable state for Fortnite.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3164) [You really want to minimize how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3166) [many PSOs you're creating while](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3168) [you're simulating the game](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3170) [during the frame.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3171) [If you create too many, it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3172) [very easy to hitch and create a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3173) [poor player experience.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3175) [So first of all, follow best](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3177) [practices, right.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3178) [Compile your functions offline,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3179) [Compile your functions offline,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3179) [build your library offline, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3181) [pull all of your functions into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3183) [a single library.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3184) [But you really want to make sure](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3185) [you create all of your PSOs at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3187) [load time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3188) [But what do you do if you can't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3189) [do that?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3190) [So for us, the permutation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3191) [matrix is just crazy.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3192) [There's way too many for us to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3194) [realistically create at load](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3195) [time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3197) [We have multiple artist-authored](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3198) [shaders -- thousands of them --](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3200) [multiple lighting scenarios](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3202) [based on number of shadow](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3204) [cascades and so on, different](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3206) [render target formats, MSAA.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3208) [The list goes on.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3210) [We tried to minimize](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3212) [permutations where we could, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3213) [this does help.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3215) [Sometimes a dynamic branch is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3215) [good enough and better than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3217) [creating a static permutation,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3218) [but sometimes not.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3220) [What we had to do is we decided](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3222) [to identify the most common](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3224) [subset that we're likely to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3225) [need, and we create those at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3227) [load.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3228) [We don't try to create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3229) [everything.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3230) [The way we achieved this is we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3231) [created an automation pass where](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3232) [we basically flew a camera](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3234) [through the environment and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3235) [recorded all of the PSOs that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3236) [actually needed to render the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3238) [environment.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3239) [Then, during our daily](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3240) [playtests, we harvested any PSOs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3241) [that were created that were not](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3243) [caught by that automation pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3246) [The automation pass also](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3247) [catches, like, cosmetics, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3249) [effects from firing different](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3252) [weapons, and so on.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3254) [We take all of that information](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3256) [from automation and from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3258) [playtest, combine it into a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3259) [list.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3260) [That's what we create at load](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3260) [time, and that's what we ship](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3262) [with the game.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3263) [It's not perfect, but we find](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3264) [that the number of PSOs we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3266) [create at runtime is in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3267) [single digits for any given play](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3268) [session, on average.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3270) [And so players don't experience](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3271) [any hitching from PSO creation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3272) [Resource allocation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3277) [So basically, creating and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3279) [deleting resources is expensive](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3283) [or can be expensive.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3286) [It's kind of like, think of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3287) [[inaudible].](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3290) [You really want to minimize the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3290) [number of [inaudible] you're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3291) [making per frame.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3292) [You really don't want to be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3293) [creating and destroying a lot of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3294) [resources on the fly, but when](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3295) [you're streaming in content](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3297) [dynamically, when you have a lot](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3298) [dynamically, when you have a lot](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3298) [of movable objects, some of this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3300) [just isn't possible to avoid.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3302) [So what we did for buffers is we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3305) [just used buffer suballocation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3309) [-- basically, a bend allocation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3311) [strategy.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3312) [Upfront, we allocate a big](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3313) [buffer, and then we suballocate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3314) [small chunks back to the engine](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3316) [to avoid asking Metal for new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3319) [buffers all the time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3320) [And this ended up helping a lot.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3323) [We also leveraged programmable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3325) [blending to reduce the number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3327) [resolves and restores and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3330) [amount of memory bandwidth we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3331) [use.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3333) [Specifically, the main use case](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3334) [we have for this is anywhere we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3336) [need access to scene depth, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3338) [things like soft particle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3340) [blending or projected decals.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3341) [What we do is during the forward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3343) [pass, we write our linear depth](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3345) [to the alpha channel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3346) [And then, during our decal and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3347) [translucent passes, all we need](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3349) [to do is use programmable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3350) [blending to read that alpha](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3352) [channel back, and we can use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3353) [depth without having ever had to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3355) [resolve the depth buffer to main](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3357) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3359) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3359) [We also use it to improve the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3361) [quality of MSAA.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3363) [As I mentioned, we do HDR](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3364) [rendering, and a-- just an MSAA](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3366) [resolve of HDR can still lead to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3368) [very aliased edges.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3370) [Think of cases where you have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3372) [very, very bright sky and a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3373) [very, very dark foreground.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3375) [Just doing a box filter over](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3377) [that is, basically, if 1 of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3379) [those subsamples is incredibly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3382) [bright and the others are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3384) [incredibly dark, the result is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3385) [going to be an incredibly bright](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3387) [pixel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3388) [And when tone mapped, it'll be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3389) [something close to white.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3390) [You end up with edges that don't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3391) [look anti-aliased at all.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3392) [So our solution to this was to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3393) [do a pre tone map over all of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3396) [the MSAA samples, then perform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3398) [the normal MSAA resolve, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3401) [then the first postprocessing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3403) [pass just reverses that pre tone](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3404) [map.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3406) [We use programmable blending for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3407) [the pre tone map pass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3409) [Otherwise, we'd have to resolve](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3410) [the entire MSAA color buffer to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3411) [memory and read it back in,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3413) [which would be unaffordable.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3415) [Looking forward to some of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3418) [Looking forward to some of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3418) [work we'd like to do in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3420) [future with Metal, parallel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3421) [rendering.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3424) [So on macOS, we do support](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3424) [creating command buffers in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3427) [parallel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3428) [On iOS, we'd really need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3429) [support parallel command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3432) [encoders for this to be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3433) [practical.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3434) [A lot of our drawing ends up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3435) [happening in the main forward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3436) [pass, and so it's important to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3437) [parallelize that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3440) [I think it would be very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3442) [interesting to sort of see the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3443) [effects of parallel rendering on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3445) [a monolithic, fast core versus](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3448) [what we had for parallel command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3450) [encoders on the efficient cores](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3453) [on higher-end devices.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3454) [Could be some interesting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3455) [results in terms of battery](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3456) [usage.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3458) [Metal heaps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3460) [So we'd like to replace our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3461) [buffer suballocation with Metal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3462) [heaps -- first, because it'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3464) [just simply our code, but](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3466) [second, because we can also use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3467) [it for textures.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3469) [We still see an occasional hitch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3470) [due to texture streaming because](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3471) [we're obviously creating and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3472) [destroying textures on the fly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3474) [as we bring textures in and out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3475) [of memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3477) [Being able to use heaps for this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3478) [will get rid of those hitches.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3479) [will get rid of those hitches.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3479) [For us, we just, it's, the work](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3481) [we have in front of us to make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3485) [that possible is setting up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3485) [precise fencing between the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3488) [different passes, right.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3489) [So we need to know explicitly if](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3490) [a resource is being read or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3493) [written by a vertex or pixel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3494) [shader across different passes,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3496) [and it requires some reworking](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3498) [of some of our renderer to make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3499) [that happen.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3501) [And of course, continue to push](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3502) [the high end of graphics on iOS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3505) [Last year at WWDC, we showed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3507) [what was possible by bringing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3509) [our desktop-class forward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3511) [renderer to high-end iOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3512) [devices, and we continue, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3513) [want to continue pushing that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3515) [bar on iOS, continuing to bring](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3517) [desktop-class features to iOS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3519) [and looking for opportunities to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3523) [unify our desktop renderer with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3527) [the iOS renderer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3529) [And with that, I'll hand it back](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3532) [to Michael.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3535) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3537) [&gt;&gt; So Metal is low overhead out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3540) [of the box, but rendering many](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3541) [objects efficiently can require](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3543) [multithreading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3545) [Metal is built to take advantage](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3546) [of all the GPU, all the CPUs in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3547) [our systems.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3549) [Metal is also really accessible,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3551) [but advanced rendering sometimes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3553) [requires explicit control.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3554) [Metal provides this control when](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3556) [you need it for memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3558) [management and GPU parallelism.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3559) [We also introduced indirect](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3562) [command buffers, our brand-new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3563) [feature that lets you move](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3565) [command generation entirely to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3566) [the GPU, freeing the CPU for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3567) [other tasks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3569) [Together with argument buffers,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3571) [these features provide a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3572) [complete solution to GPU-driven](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3573) [pipelines.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3575) [And finally, Metal lets you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3577) [leverage the advanced](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3579) [architecture of the A11 GPU to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3580) [optimize many rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3582) [techniques for both maximum](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3583) [performance and extended](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3584) [playtime.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3587) [For more information, please](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3589) [visit our website, and be sure](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3590) [to visit us in tomorrow's lab.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3592) [Thank you.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3595) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/607/?time=3596)