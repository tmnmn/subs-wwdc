# Core Data Best Practices

## Summary
As your app gains more customers and becomes more feature-rich, you may find yourself with new problems to solve. Core Data is a powerful tool that has changed a lot over the years. Learn about the new best practices in Core Data, such as how to use concurrency and persistent history, and discover how to test for, and resolve, common problems using familiar technologies.

## Info
* Developer Tools
* WWDC 2018 - Session 224 - iOS, macOS, tvOS, watchOS
* https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/

## Text
 [[ Music ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=7) [&gt;&gt; Good afternoon, everyone.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=21) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=22) [Welcome to Core Data Best](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=27) [Practices.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=29) [My name is Scott Perry.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=29) [I work on Core Data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=30) [And we'll be joined later by my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=32) [teammate, Nick Gillett.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=33) [The plan for today, first, we'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=36) [talk a bit about how the process](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=39) [of getting started with Core](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=40) [Data has evolved over time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=41) [Then, we will cover ways we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=43) [evolve our application more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=45) [easily by taking advantage of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=47) [extension points in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=48) [persistent container.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=49) [We'll follow that with how we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=51) [can evolve our model as our apps](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=53) [requirements change and our data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=55) [grows.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=56) [Then, Nick is going to talk](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=59) [Then, Nick is going to talk](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=59) [about a few ways our app can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=60) [maintain its performance, even](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=61) [as it scales beyond our wildest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=63) [dreams, and we'll wrap up with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=64) [some good stuff about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=68) [transformers, debugging, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=69) [testing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=70) [But first, let's build an app.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=71) [I like to take photos, so we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=75) [going to build something that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=77) [allows me to share photos with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=78) [friends and get comments from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=79) [them, even if it's just Nick](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=81) [asking how my slides are going.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=82) [Where should we keep our app's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=86) [data?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=88) [Well, we could keep it all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=88) [online, but I usually take](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=90) [photos when I'm traveling, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=91) [the connection can be kind of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=92) [spotty, so we should keep it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=93) [locally, organized into some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=95) [kind of store.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=97) [So, we have posts and comments](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=100) [and their instances and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=102) [relationships between them form](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=104) [an object graph and we've](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=105) [decided we need to persist these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=107) [things on disk, so that's what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=108) [Core Data is for.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=112) [So, we'll use that and we'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=116) [start by translating our mock](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=117) [here into something a store can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=119) [here into something a store can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=119) [understand, a managed object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=121) [model.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=122) [We'll need fields for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=123) [everything, with attributes for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=124) [things like the image's data as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=125) [well as the time it was posted,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=127) [and we'll need relationships for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=129) [posts and comments.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=131) [We've also defined a need for a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=132) [store, but there's a lot](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=134) [involved in maintaining data on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=135) [disk over time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=137) [Luckily, Core Data provides a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=139) [persistent store coordinator to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=140) [manage that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=141) [The coordinator can do things](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=142) [like compare the app's model](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=144) [with the store's version and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=146) [automatically migrate it forward](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=147) [as our app evolves.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=149) [Finally, managed object context](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=150) [provide safe, fast, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=152) [predictable access to our data,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=154) [even when we're using many at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=156) [the same time through features](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=157) [like query generations,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=159) [connection pooling, and history](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=160) [tracking.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=161) [Setting this all up requires](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=164) [finding the model and loading it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=166) [and deciding where to keep the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=167) [store, but a lot of these error](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=169) [paths can't actually fail once](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=171) [you've shipped your app, so Core](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=173) [Data provides a container type](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=174) [that dramatically reduces the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=176) [amount of boilerplate required](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=177) [to set up your stack, just refer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=178) [to set up your stack, just refer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=178) [to the model by name, and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=180) [persistent container will load](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=182) [it out of the main bundle and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=183) [keep a stored in a consistent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=185) [location.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=186) [This persistent container type](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=187) [encapsulates a whole stack and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=190) [includes conveniences for a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=191) [shared main queue view context](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=193) [as well as factory methods for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=195) [generating background contexts](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=198) [as well as performing background](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=200) [work.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=201) [It's also designed to be easy to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=202) [work with as our app grows.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=203) [For example, let's say we want](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=205) [to factor our model layer into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=207) [its own framework.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=209) [We can do that by creating a new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=210) [framework target in Xcode and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=211) [moving our code into it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=213) [It's all super easy, but when we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=214) [move our model into the new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=216) [target, in the built product,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=217) [targets move from the app into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=218) [the new framework, which is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=220) [what's supposed to happen, but](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=222) [now NSPersistentContainer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=223) [doesn't know where to find our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=225) [model anymore.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=226) [This is because it only checks](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=227) [the main bundle by default.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=228) [Why stop there?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=230) [Well, searching all of the app's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=231) [bundles could get really slow](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=233) [for a complicated app and it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=234) [not a cost you want to pay every](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=236) [time you spin up a stack.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=237) [How do we fix this?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=240) [Well, we could resuscitate the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=242) [model out of the framework](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=243) [bundle ourselves and use one of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=245) [the container's other](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=246) [initializers, like one that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=247) [takes an explicit managed object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=248) [model, but NSPersistentContainer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=250) [actually has a way for you to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=252) [change which bundle it searches.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=254) [See, NSPersistentContainer knows](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=257) [when it's been subclassed and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=259) [will use the type of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=261) [subclass as a hint when it looks](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=261) [for the model.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=264) [All we need to do to take](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=265) [advantage of this is to create a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=266) [subclass.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=267) [It doesn't even need to have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=268) [anything in it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=269) [Then, any code setting up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=271) [through the container that wants](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=273) [to use our model can just adopt](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=273) [that subclass and the persistent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=275) [container will check in our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=277) [frameworks bundle for our model](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=278) [instead.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=280) [So, that's fun, but since we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=281) [going through the effort of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=285) [factoring our app's resources,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=285) [wouldn't it be nice if we also](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=287) [improved the organization of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=288) [data on disk?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=289) [By default, new persistent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=291) [containers come with a store](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=293) [description for an SQLite store](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=294) [with automatic migration that on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=296) [iOS lives in our app's documents](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=298) [directory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=299) [directory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=299) [That was great when our model](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=300) [code was part of the app, but we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=302) [should try to keep our new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=304) [frameworks files from mingling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=304) [too much with the apps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=306) [Since we already subclassed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=308) [NSPersistentContainer to make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=309) [finding the model easier, let's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=310) [build on that to improve this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=312) [The brute force way to change a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=316) [store's location is to directly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=318) [modify the URL in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=320) [persistentStoreDescription](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=322) [before loading the store.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=323) [Sometimes that's what you want](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=325) [and we could use that pattern](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=326) [here, but we don't have to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=327) [because NSPersistentContainer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=329) [calls its own default directory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=331) [URL method when creating](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=333) [persistent store descriptions.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=335) [And it's made to be overridden.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=337) [In this case, we can just append](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=339) [a path component, but this is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=340) [also a good way to set up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=342) [containers for caches or other](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=343) [kinds of stacks that need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=345) [keep their stores in different](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=346) [locations, like your tasks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=347) [So, now that we've got our Core](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=350) [Data stock all figured out,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=353) [let's have a look at our app and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=354) [some of the view controllers](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=355) [that we've written.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=357) [It looks like we've got some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=358) [pretty specialized view](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=359) [pretty specialized view](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=359) [controllers here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=360) [Here's one that shows all of my](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=362) [posts as well as another that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=363) [shows all posts by all authors.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=364) [Even the detail views are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=367) [duplicated.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=368) [It feels a lot like we could](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=369) [have written half the code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=370) [All we should really need is one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=373) [view controller for displaying a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=375) [list of posts and another for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=376) [displaying a single post.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=378) [We can accomplish this by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=380) [defining good boundaries in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=381) [between our view controllers in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=383) [the form of interfaces that take](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=385) [model objects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=386) [Each controller gets configured](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=389) [by its model parameters and then](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=390) [they can customize their views](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=393) [in cells based on whether](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=394) [they're showing my posts or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=395) [someone else's.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=396) [When drafting view controllers](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=397) [using Core Data, list views](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=400) [should get fetch requests and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=402) [detail views should get managed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=404) [objects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=405) [View controllers also need a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=407) [managed object context, either](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=408) [the container's view context or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=410) [some other main queue context.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=412) [And this pattern for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=414) [generalizing view controllers](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=415) [with Core Data isn't just for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=416) [UIs; it works really well for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=418) [utility types as well.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=419) [utility types as well.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=419) [Instead of passing Core Data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=421) [types for presentation, we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=422) [pass things like URLs or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=425) [serialized data into background](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=426) [work controllers and turn those](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=428) [into new and updated managed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=430) [objects using a background](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=431) [context instead of a view](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=433) [context to do our work.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=434) [Adopting this kind of interface](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=438) [and utility type is super easy](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=439) [since we own the initializer, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=440) [we can just require the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=442) [parameters to create the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=442) [controller.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=443) [But how do we get our boundary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=444) [variables into our view](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=446) [controllers?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=447) [Well, if we're using segues, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=448) [can override the prepare method](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=451) [and get a reference to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=454) [destinationViewController and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=455) [then configure it there.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=457) [If we're using storyboards or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=458) [nibs, then we already have code](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=460) [that has to cons up a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=462) [destinationViewController, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=463) [all we need to do is set the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=465) [properties before presentation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=466) [And, if we're driving stick, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=468) [can just write an initializer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=470) [that explicitly defines the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=471) [boundary conditions, just like](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=472) [we do with our utility types.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=474) [OK. So, now we've got a fetch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=476) [request and a context for our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=479) [request and a context for our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=479) [view controller, but before we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=481) [smash them together to get our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=482) [results, we should configure the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=484) [fetch request a little bit more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=485) [to make sure that our controller](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=486) [will have great performance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=487) [Sometimes it makes sense to set](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=490) [a fetch limit, but in the case](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=492) [of our list view, batching makes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=493) [more sense because we want to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=495) [show all the data and we know](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=496) [exactly how many cells our view](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=498) [controller can fit on the screen](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=500) [at once.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=501) [In general, at least one of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=502) [these options should always be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=504) [set for fetch requests that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=505) [might return an unbounded number](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=507) [of results.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=508) [So, at this point, we could turn](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=509) [our fetch request into objects](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=512) [and populate a list view with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=513) [the results, but what if we want](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=515) [to keep the UI up to date with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=517) [changes as they happen?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=519) [Core Data has us covered here as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=521) [well with the fetched results](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=522) [controller.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=523) [Available on all platforms since](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=524) [Sierra, adopting the fetched](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=526) [results controller just requires](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=527) [writing an adaptor between the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=529) [delegate protocol and the view](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=530) [it's driving.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=531) [And to create one, all we need](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=533) [is a fetch request and a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=534) [context.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=535) [The fetched results controller](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=537) [even supports driving more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=538) [advanced list view concepts such](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=539) [advanced list view concepts such](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=539) [as sections.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=541) [If we wanted to group posts into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=543) [sections by the day they were](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=545) [posted, we could do it by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=546) [extending the post type that's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=547) [generated by Xcode with the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=549) [computed property and passing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=550) [the name of it to the fetched](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=552) [results controller's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=553) [initializer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=554) [This works well, but what if we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=556) [have a view controller more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=558) [complicated than just a list of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=559) [our objects?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=560) [What if we want to show](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=561) [something like a chart of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=562) [posts per day on our app?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=564) [Well, the first thing we should](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=567) [do is not underestimate the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=568) [power of fetched requests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=569) [I'm just one person, so in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=571) [last month, I haven't managed to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=573) [post more than 40 pictures per](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=574) [day.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=576) [Over the course of 30 days,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=577) [that's still a fairly reasonable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=579) [amount of data to pull out of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=580) [the store at once.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=581) [If the day property that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=583) [defined earlier was actually](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=585) [part of the entity in the model,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=586) [then we could write a fetch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=588) [request that counts up the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=589) [number of posts grouped by the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=590) [day they were posted.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=592) [There's three parts to this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=593) [request.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=594) [The first one is just setting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=595) [the range.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=596) [We want the last 30 days of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=597) [data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=598) [Next, we want to group together](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=599) [Next, we want to group together](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=599) [all results whose day attributes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=602) [share the same value.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=604) [Since we're now fetching](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=606) [aggregates instead of individual](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=607) [objects, we have to change the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=608) [result type to something more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=609) [sensible as well, in this case,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=610) [a dictionary.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=612) [Finally, we define an expression](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=614) [that represents the number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=616) [objects in each group and tell](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=617) [the fetch requests to return](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=619) [that count along with the day it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=620) [represents.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=622) [This fetch request returns 30](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=624) [results, each of which is one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=626) [point on our chart.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=628) [If you're into databases, this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=631) [is the SQLite query that Core](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=634) [Data generates from that fetch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=635) [request.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=636) [It's exactly what you do if](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=637) [you're writing the query](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=638) [yourself.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=639) [Core Data understands how to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=640) [convert many expression](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=641) [functions into optimal database](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=643) [queries.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=644) [A group by query can use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=645) [aggregate functions such as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=646) [average and sum and scalar](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=648) [queries, like a normal fetch](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=650) [request, can use scalar math and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=651) [date functions, like abs for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=653) [absolute value and now for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=654) [current time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=656) [If you want to know more about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=657) [what you can do with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=659) [what you can do with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=659) [NSExpression, check out the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=660) [documentation for its list of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=661) [functions.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=662) [Many of them are supported by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=663) [fetch requests in Core Data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=664) [OK. So, fetch requests can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=668) [accomplish a lot through the use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=670) [of expressions, but SQLite still](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=672) [reads every one of our posts](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=674) [through memory when computing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=676) [the counts for our graph here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=677) [That works fine for charts](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=679) [showing the amount of posts](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=680) [generated by one human in a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=683) [month, but what if we want to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=684) [chart something bigger?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=685) [What if we want to show a whole](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=687) [year or what if our little app](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=688) [starts handling orders of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=690) [magnitude more data?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=692) [Now the fetch request would be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=694) [counting at least 50,000 posts](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=695) [one by one just to show 30 data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=697) [points and that's not going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=699) [be fast enough.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=701) [The mismatch between our views](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=702) [and our model has gotten to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=704) [point where we need to start](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=705) [doing some denormalization.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=706) [Denormalization is when we add](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=710) [redundant copies of data or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=712) [metadata to improve read](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=713) [performance at the expense of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=715) [some additional bookkeeping.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=716) [Database indexes are a good](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=718) [example of this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=719) [example of this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=719) [Adding count metadata to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=721) [store is exactly the kind of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=722) [compromise we need to get our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=724) [chart's performance again.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=726) [So, let's look at how our model](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=728) [can group posts into counts by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=730) [day.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=732) [We'll need a new entity with two](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=733) [attributes, plus a bit of extra](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=735) [maintenance to keep them](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=737) [accurate.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=737) [Grouping by day improves our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=739) [fetch request so much that it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=740) [guarantees good performance for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=742) [charts covering years of data,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=743) [so we only have to create this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=745) [one level of denormalization and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=746) [the fetch request that we passed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=749) [to the chart view controller?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=750) [It's super simple.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=752) [It's really not that much](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=754) [different than the fetch request](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=755) [that we'd pass off to any other](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=756) [list view, which is actually](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=757) [kind of sort of what a chart](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=759) [view is if you squint hard](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=760) [enough.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=761) [But what about that extra](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=763) [maintenance?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=764) [We've got to increment the count](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=766) [whenever a post gets published](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=767) [and decrement it whenever a post](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=768) [is removed.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=770) [We could do this in the methods](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=771) [that change the post object's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=773) [relevant state, but a more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=774) [foolproof solution is to update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=775) [our counts in response to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=776) [context saving.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=778) [We could just register for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=779) [We could just register for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=779) [managed object contextWillSave](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=784) [notification with a function](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=787) [that goes through all of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=789) [posts that have been inserted,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=790) [incrementing the count for each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=791) [day that's relevant, and another](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=793) [loop going through all of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=796) [deleted objects, decrementing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=796) [the count for each day.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=798) [And that affects the state of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=799) [the context before it commits to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=800) [the database, so it all winds up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=802) [happening in one transaction, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=803) [this scales really well, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=805) [is useful because my teammate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=807) [Nick Gillett is here to talk](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=808) [about how Core Data can help us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=810) [as our little app scales beyond](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=811) [our wildest dreams.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=813) [Nick.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=814) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=815) [&gt;&gt; Thanks, Scott.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=817) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=818) [So, as Scott said, as your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=820) [applications grow, they get more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=822) [and more complex and at Core](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=823) [Data it's really important to us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=826) [that your applications do grow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=828) [In fact, we want this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=830) [That's the whole reason we exist](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=831) [is to help you manage this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=833) [growth, make it efficient for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=834) [you to work with, and help you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=836) [give more value to your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=838) [customers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=839) [But this happens in ways that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=840) [are very specific to your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=843) [application.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=844) [It's also highly aligned with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=845) [your customer experience or the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=846) [way that you want them to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=848) [experience your application.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=849) [Unfortunately, like all complex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=852) [systems, as it grows and becomes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=853) [more complex, it also tends](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=855) [toward chaos.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=857) [So, today we're going to talk](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=859) [about ways that Core Data can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=860) [help you manage this chaos and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=862) [give it some structure.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=863) [We'll talk about building](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=865) [predictable behaviors and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=866) [helping you build tunable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=868) [containers that you can align](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=870) [with your experience metrics.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=871) [What does that mean?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=876) [Well, when we think of metrics,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=878) [there's a couple of different](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=879) [ways that we can think about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=880) [them.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=882) [The first is in alignment with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=883) [our customers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=884) [And usually we define these as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=886) [things that they experience,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=888) [like having a consistent user](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=889) [interface or a responsive scroll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=891) [view, and also as delight.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=893) [But those are really hard for us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=898) [But those are really hard for us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=898) [to capture as engineers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=901) [So, we translate them into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=903) [engineering metrics, things like](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=904) [peak memory consumption, how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=906) [much battery drains during a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=908) [given task or how much CPU time](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=909) [is burned during a given task.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=912) [And, finally, how much IO we do](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=914) [during a given task.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=916) [To make this a little more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=918) [concrete, we'll use this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=919) [application.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=920) [Some of you may remember the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=922) [history demo application that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=923) [was introduced last year at WWDC](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=924) [and I've modified it for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=927) [purposes of this talk.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=928) [There are a few actions here](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=930) [that a customer can take while](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=932) [using our application.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=933) [The first is they can add a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=935) [single post to our database by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=936) [hitting the + button.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=938) [They can also download any](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=940) [pending data from the server by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=942) [tapping Download.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=944) [And, finally, for anything that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=950) [hasn't yet been uploaded to a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=952) [server, they can tap Post All.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=953) [Now, this application has a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=956) [fairly small set of interactions](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=958) [fairly small set of interactions](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=958) [that a customer can take, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=960) [yet, as these happen](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=962) [concurrently, it tends towards](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=964) [chaos.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=966) [So, we can see that even with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=968) [this small set of actions,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=971) [things that go on concurrently](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=973) [could cause a number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=974) [different state changes in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=975) [application and the worst thing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=976) [for us is to end up with a user](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=978) [experience that looks like this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=980) [This notion of partial](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=982) [completeness doesn't make sense](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=983) [to our customers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=985) [In fact, it doesn't make sense](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=986) [to us either.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=987) [Core Data is here to help with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=989) [that with query generations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=990) [Query generations were](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=993) [introduced in 2016 in our What's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=993) [New in Core Data session.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=996) [So, if you're not yet familiar](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=998) [with them, I highly recommend](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=999) [that you check out that session](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1000) [for more information about how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1001) [they work.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1002) [What you do need to know is that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1003) [they require wall journal mode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1005) [and only work with SQLite.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1007) [The goal of query generations is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1009) [to isolate your managed object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1011) [contexts from competing work.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1013) [This could be rights to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1015) [background or actions that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1016) [user is taking that you're not](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1018) [user is taking that you're not](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1018) [yet ready to manifest in a given](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1020) [context.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1022) [Query generations provide a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1024) [consistent, durable view of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1025) [database that will return the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1027) [same results for fetches](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1028) [regardless of what other](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1030) [contexts are writing to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1031) [database at a given time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1032) [The best part is we can adopt](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1037) [them in one line of code.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1039) [This is a typical change for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1041) [reloading a table view.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1043) [We would just have to insert a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1044) [call to NSManagedObjectContext](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1046) [setQueryGenerationFrom token](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1048) [with the current query](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1050) [generation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1051) [And when it comes time to update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1053) [them, we can update them as we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1054) [normally do by using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1057) [NSMangedObjectContextDidSave](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1058) [notification.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1060) [And this allows us to manifest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1061) [changes to the application's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1064) [data in the UI at the right](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1065) [time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1068) [But what if the data that we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1072) [writing isn't related to the UI,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1073) [such as downloading some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1075) [comments that Scott mentioned](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1076) [earlier?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1077) [In this case, we don't want that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1079) [In this case, we don't want that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1079) [data to manifest in the user](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1082) [interface or cause changes to it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1083) [because none of the change will](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1085) [be visible to the user.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1086) [So, we can actually filter out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1088) [these updates by using history](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1089) [tracking.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1091) [Persistent history tracking was](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1092) [new in iOS 11 and macOS 10.13.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1094) [We introduced it in our session,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1098) [What's New in Core Data, last](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1099) [year at WWDC, and for more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1102) [information about how it works](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1103) [and what the underlying features](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1104) [are of it, you can use that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1106) [session as a reference.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1108) [Persistent history tracking is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1111) [great way to get a persistent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1113) [record of each transaction that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1115) [connects to the database and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1117) [this is useful to us for a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1118) [couple of different reasons.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1120) [For the purposes of this talk,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1121) [though, we'll be considering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1123) [NSPersistentHistoryChange, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1125) [gives us a changedObjectID and a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1128) [set of updatedProperties.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1131) [And](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1133) [NSPersistentHistoryTransaction](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1133) [which gives us a set of changes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1135) [and an objectIDNotification.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1137) [So, let's consider the following](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1141) [set of changes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1145) [As you can see, these are posts](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1146) [that are being inserted to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1148) [database and when this happens,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1149) [given our table view, we would](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1152) [want to refresh the UI, which we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1154) [can do by using the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1157) [objectIDNotification.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1158) [These are analogous to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1160) [NSManageObjectContextDidSave](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1161) [notifications and can be merged](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1163) [in using the same API.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1165) [But if we downloaded a list of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1169) [comments that we don't want to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1171) [manifest in a user update for,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1173) [we can filter them.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1175) [Using this small amount of code,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1180) [we can filter out the changes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1181) [from a given transaction to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1182) [decide if any of them were](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1184) [relevant to the post entity and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1185) [in that way we won't refresh the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1188) [UI and cause an unnecessary blip](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1190) [or stutter to the user.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1193) [But as you can see here, we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1196) [actually only using a small](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1197) [amount of the post content.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1198) [amount of the post content.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1198) [In fact, we're only using two](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1201) [properties, the image and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1203) [title.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1205) [And so we can do better than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1207) [just filtering out by entity.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1208) [We can actually filter out by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1210) [updated properties using the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1212) [history changes and in this way](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1213) [we can create highly-targeted](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1215) [updates to our user experience](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1217) [that align with changes that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1219) [will be visible to them.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1220) [But Core Data can also help you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1222) [support new interactions for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1228) [your users.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1229) [As your data becomes more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1231) [complex and grows in scale, some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1232) [editing operations can get more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1235) [expensive.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1236) [For example, consider a simple](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1237) [photos browser.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1239) [Typically, when our applications](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1241) [grow, we want to -- we want to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1242) [introduce new functionality that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1244) [makes it easier to perform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1245) [repetitive tasks, such as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1247) [multiple selection.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1249) [And Core Data can support this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1250) [by using batch operations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1253) [In fact, in just a couple lines](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1255) [of code we can mark an entire](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1257) [set of photos as a favorite or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1259) [set of photos as a favorite or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1259) [not.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1262) [And in just one line of code, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1263) [can purge or delete a set of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1265) [records from the database using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1267) [a batch delete operation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1268) [And these operations scale in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1269) [ways that aren't possible by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1272) [faulting the objects into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1273) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1274) [For example, during a delete, a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1275) [traditional delete by calling](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1278) [NSManagedObject.delete will grow](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1279) [with the size of the records in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1282) [the database.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1283) [And as you delete objects and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1284) [their memory gets faulted into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1286) [the context, this gets more and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1287) [more expensive the larger your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1289) [database gets.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1291) [But with batch operations, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1292) [can perform the same mutations](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1294) [in just a fraction of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1296) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1297) [And this has the curve that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1298) [want as data increases, where](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1299) [the larger the data set is, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1302) [less memory we use, using up to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1304) [about 7% of the memory of a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1306) [traditional delete at 10 million](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1308) [rows.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1310) [So, this is a very powerful way](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1312) [to save resources on your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1314) [customer's device.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1315) [But one of the traditional](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1317) [problems with batch operations](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1319) [problems with batch operations](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1319) [is that they were difficult to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1321) [work with because they don't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1322) [generate save notifications.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1323) [That's where history tracking](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1326) [comes back in.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1327) [With persistent history](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1329) [tracking, we can fetch out the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1330) [transactions from the database](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1331) [that occurred as part of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1333) [batch delete or update and we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1334) [can use the objectIDNotification](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1337) [method to generate a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1338) [notification that works like a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1340) [save notification.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1341) [In this way, the fetched results](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1343) [controller or any other context](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1344) [in your application can update](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1346) [to those notifications](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1348) [incrementally.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1349) [And so those are some ways you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1351) [can manage growing data with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1355) [Core Data, but how about your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1357) [workflow itself?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1359) [What can Core Data do for you as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1360) [a developer and engineer to make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1363) [it easier to build and test your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1365) [applications?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1366) [The first thing is that we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1369) [help future you today.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1371) [As you may know, NSKeyedArchiver](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1373) [is changing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1375) [We're adopting secure coding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1377) [across the entire platform and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1378) [across the entire platform and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1378) [the KeyedArchiver API has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1381) [changed significantly this year](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1383) [in support of that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1384) [For Core Data, this means that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1386) [value transformers are changing,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1387) [so if you have a transformable](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1389) [property in your managed object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1391) [model and you're not sending a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1393) [value transformer today, you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1394) [used to be getting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1396) [NSKeyedUnarchive](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1398) [FromDataTransformer as your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1398) [default value transformer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1400) [In the future, you'll be getting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1402) [NSSecureUnarchive](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1404) [FromDataTransformer and this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1405) [implements secure coding under](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1408) [the covers and you should adopt](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1409) [it today.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1411) [There was a great talk this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1412) [morning about exactly this topic](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1413) [called the Data You Can Trust](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1416) [and I highly recommend that you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1418) [view it to get more information](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1420) [about secure coding and how to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1421) [make your applications more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1423) [resilient.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1424) [You can specify this in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1428) [model editor with a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1429) [transformable property by the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1430) [value transformer name field.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1432) [And today, we want you to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1435) [implement this on your own.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1437) [This will become the default in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1440) [a future release and in a future](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1441) [release Xcode will also start](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1443) [emitting a warning for anyone](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1444) [that's using the default value](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1446) [transformer name.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1447) [If you're building your models](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1450) [in code, you can set it by using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1450) [the valueTransformerName](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1453) [property on NSAttribute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1454) [description.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1455) [This should be transparent for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1457) [you if you're not encoding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1459) [custom class types.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1461) [So, for plist types, this is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1462) [no op.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1463) [You simply change the value](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1464) [transformer name and you'll get](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1465) [the new secure coding behavior.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1467) [However, if you are implementing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1469) [custom classes, those classes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1470) [need to adopt secure coding and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1472) [you can come see us in the labs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1474) [for help with that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1476) [But we can help you more.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1478) [At Core Data, we've spent time](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1481) [building in new debugging tools](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1483) [over the years that can help you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1485) [understand what's going on under](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1486) [the stack.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1487) [So, this is a picture of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1489) [preferred default scheme](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1490) [configuration.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1491) [We have a couple of process](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1492) [arguments that we have that can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1494) [help you get more debugging](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1496) [information about SQLite, but](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1497) [the big one you should always](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1499) [the big one you should always](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1499) [run with is com.apple.Core](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1500) [Data.ConcurrencyDebug.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1502) [And this will catch any queue](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1504) [exceptions in your applications,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1506) [so areas that you may be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1507) [transferring objects between](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1509) [main and background queue](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1510) [contexts or areas that you may](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1511) [not be obeying a managed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1514) [object's actual context.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1515) [SQLite also has a number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1518) [interesting environment](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1520) [variables, so their threading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1521) [and file assertions are a great](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1523) [way to ensure you have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1524) [correctness in your application](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1525) [around their API as well as the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1527) [file system.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1529) [And auto tracing is a great way](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1530) [for you to see what's going on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1532) [under the covers, an additional](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1533) [tour on debug logging.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1534) [com.apple.Core Data.SQLDebug has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1536) [four levels.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1539) [The first level is the most](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1541) [interesting and the least of a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1543) [performance hit.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1544) [The fourth level is the most](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1545) [verbose, but does cause](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1547) [significant performance hit when](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1549) [you run with it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1551) [When you enable SQL debugging](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1553) [and our multi-threading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1555) [assertions, you'll see a couple](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1557) [of logs in the console and these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1558) [of logs in the console and these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1558) [are the indication that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1560) [assertions are enabled and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1561) [running correctly.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1562) [With our SQL debugging on,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1564) [you'll be able to see things](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1566) [like select statements for our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1567) [fetch requests as well as how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1568) [long they took.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1570) [And, if you're set to level](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1571) [four, you'll even get explain,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1573) [which will show you the query](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1575) [plan for a given select](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1576) [statement.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1578) [And here we can see that our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1579) [table view is selected via table](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1580) [scan and then using a temporary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1583) [B-tree in memory for the order](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1585) [by, which is on the timestamp.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1587) [This is a potential performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1590) [problem and as you're running](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1591) [your application you can use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1593) [messages like this to see where](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1595) [you may be doing more work than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1597) [you need to.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1598) [So, how would we fix this?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1600) [Well, turns out SQLite 3 can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1602) [actually tell us.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1605) [If we open a database and hand](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1607) [it the select query from our SQL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1609) [logs, we can enable a mode](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1610) [called Expert, which will](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1612) [analyze the query and give us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1614) [the ideal solution of optimizing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1616) [it by creating a covering index.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1618) [it by creating a covering index.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1618) [And we can do this in the model](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1621) [editor by adding a fetch index](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1622) [to our post entity.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1625) [Here I've configured it to run](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1627) [on the timestamp and fetch them](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1628) [out in descending order because](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1630) [we're showing the most recent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1632) [posts at the top of the table](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1633) [view.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1635) [When we run the application](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1637) [again, we see the same select](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1639) [logs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1640) [Except that this time we see](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1644) [that the select query hits the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1646) [covering index during the query.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1647) [Explain shows us that the query](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1650) [will use the covering index for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1651) [its order by.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1653) [Core Data supports many types of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1658) [indexing, including compound](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1659) [indexes using R-trees.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1661) [And these are great for creating](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1663) [any kind of query or optimizing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1665) [a query that uses a bounding box](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1667) [in its select statement.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1670) [This is most commonly done with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1672) [locations and we can set this up](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1673) [by adding another index to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1675) [post entity, which works in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1677) [latitude and longitude property](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1678) [latitude and longitude property](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1678) [that I added for the purposes of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1680) [this slide.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1682) [We change the query type in this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1684) [box by selecting R-tree.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1686) [And then we can set up our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1688) [predicate on the fetch request](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1690) [to say get all of the posts that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1693) [happen inside of continental](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1694) [China.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1696) [This predicate is a little more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1698) [advanced because it uses](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1700) [functions inside the actual](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1701) [select statement to hit the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1704) [index that we created in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1706) [managed object model.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1707) [When we run our application](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1711) [without this predicate and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1713) [without this index, we see the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1715) [same results that we saw before](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1716) [where we're hitting only the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1718) [timestamp index.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1720) [But when we run it with our new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1722) [index and predicate, we see that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1724) [SQLite is using the index to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1727) [generate faster results for both](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1728) [of the between statements.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1731) [Unfortunately, because our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1735) [timestamp index doesn't have any](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1736) [bounding predicates on it,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1738) [SQLite can't use it for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1739) [SQLite can't use it for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1739) [sort.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1741) [So, the optimization that we've](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1742) [chosen here is to use a compound](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1744) [index to first filter out the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1747) [result set to a smaller set of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1748) [objects and then we'll do an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1750) [in-memory B-tree sort for the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1751) [order by.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1753) [As you can see, this index](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1754) [increases the performance of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1758) [fetch by about 25%.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1760) [In this case, my performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1763) [test was run over a size of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1765) [about 100,000 rows and we saw](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1767) [around 130 milliseconds of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1769) [improvement for just the fetch.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1771) [Which brings me to my next topic](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1774) [of testing with Core Data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1776) [As you may know, we really like](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1778) [tests.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1780) [Tests are awesome.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1781) [And, at Core Data, we use them](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1783) [internally for both correctness](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1785) [as well as learning.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1786) [They're a great way to learn](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1788) [about the functionality of Core](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1789) [Data and how our API behaves](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1791) [under a given set of conditions.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1792) [They're also a great way to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1795) [verify your assumptions about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1796) [how Core Data works and how it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1798) [how Core Data works and how it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1798) [going to help your customers](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1800) [have a better experience with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1801) [your application.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1802) [As you saw in the previous](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1804) [example, we can verify that our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1805) [R-tree index actually does give](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1806) [us a performance benefit even](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1808) [though it's using an in-memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1810) [B-tree sort.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1811) [They also capture your product](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1814) [requirements, and this is really](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1816) [important to us at Core Data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1817) [because it helps us communicate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1819) [around your expectations.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1820) [With tests, we can see what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1822) [you're doing in code and how you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1824) [expect those lines of code to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1825) [behave for your customers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1827) [There are some important things](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1829) [that you can set up to make this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1830) [easy for yourself, such as a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1831) [base class that generates a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1834) [persistent container.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1836) [This base class on the screen](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1838) [happens to use a file URL of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1839) [/dev/null for the persistent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1841) [store and this is a great way of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1843) [making tests that operate on a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1845) [small set of managed objects run](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1846) [very, very quickly because](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1848) [they'll run entirely in memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1850) [When you do this, SQLite](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1852) [materializes an in-memory store](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1854) [for you that can be very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1856) [efficient, but because it's in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1857) [memory, if you have a lot of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1859) [memory, if you have a lot of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1859) [data, this will cause a lot of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1860) [memory growth in your test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1862) [suite.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1863) [You should have at least one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1867) [test, though, that actually](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1870) [materializes your store file on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1871) [disk.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1873) [And this is because if you can't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1874) [open your store for your test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1875) [suite, it's highly likely that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1876) [your customer can't either.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1878) [If your persistent container is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1881) [in the application delegate, you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1882) [can have a test base class that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1884) [grabs the container out and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1885) [writes directly to that store.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1886) [But I must caution you to take](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1889) [care when you do this, because](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1891) [that means that you're writing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1893) [to the store file that's in use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1894) [by the application, so if you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1895) [run your test on a personal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1897) [device, you'll see the effects](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1898) [of the unit test when you open](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1900) [your application the next time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1902) [What if I told you I could](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1907) [insert 100,000 records in just](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1908) [seven lines of code?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1910) [I'm cheating a little bit.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1913) [I was going to leave this as an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1915) [exercise to the reader, but this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1916) [type of scaffolding is a great](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1918) [way to help you build a test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1919) [way to help you build a test](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1919) [suite that evaluates your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1921) [invariance around your data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1922) [By building these methods ahead](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1924) [of time, as your data changes or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1926) [you become aware of new use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1928) [cases for your application, you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1929) [can iterate on these to build](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1931) [new edge cases, build new](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1933) [structures for your object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1934) [graph, or evaluate the behavior](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1935) [of certain functionality under](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1937) [the covers, such as performance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1939) [This is the unit test scaffold](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1942) [that I used to build a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1945) [performance test for the R-tree](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1946) [query.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1948) [In just a handful of lines of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1949) [code, we get high confidence on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1950) [the performance of our fetch.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1952) [And these types of tests are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1954) [very informative when you're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1956) [trying to evaluate tradeoffs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1957) [between different features and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1958) [functionality in Core Data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1960) [These three lines of code](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1965) [generate a new managed object](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1966) [context and container for us for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1967) [our test to use.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1969) [Now, this is important primarily](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1971) [because the setup and teardown](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1974) [logic in tests can sometimes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1975) [affect their performance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1977) [So, you'll need to take care to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1979) [So, you'll need to take care to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1979) [analyze whether or not you're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1981) [actually testing the teardown](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1982) [performance or the setup](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1984) [performance or the actual](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1985) [runtime performance of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1986) [queries you're evaluating.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1988) [And after you've run these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1990) [tests, you can file good bugs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1991) [We love bugs, especially from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1995) [you guys because we're building](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1997) [a product to help you build your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1998) [applications.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=1999) [But, bug reports without tests](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2001) [or without a sample application](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2004) [are very hard for us to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2005) [communicate around because, as I](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2006) [mentioned earlier, they don't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2008) [capture your product](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2009) [requirements and expectations in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2010) [the same way that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2012) [well-structured tests do.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2013) [In fact, in an application](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2015) [attached to our radar that has a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2017) [test suite or even just a bare](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2019) [sample application with some UI](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2021) [that explains your constraints](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2024) [and concerns to us, we can get](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2026) [back to you much more rapidly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2028) [about what's going on and what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2030) [you should do about it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2031) [They also help us verify the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2033) [correctness of our fixes later.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2035) [So, if you're going to file a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2037) [bug, please take some time and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2038) [bug, please take some time and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2038) [write a test for us.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2040) [That's all I have today.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2044) [Come see us at lab tomorrow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2045) [We are here from 1:30 on in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2048) [Technology Lab 7 and I highly](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2050) [recommend that you check out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2053) [Testing Tips and Tricks tomorrow](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2054) [in Hall 2 at 3:20.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2055) [Thanks.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2058) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/224/?time=2060)