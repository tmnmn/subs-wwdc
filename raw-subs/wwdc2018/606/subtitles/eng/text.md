# Metal for Ray Tracing Acceleration

## Summary
Metal Performance Shaders (MPS) harnesses the massive parallelism of the GPU to dramatically accelerate calculations at the heart of modern ray tracing and ray casting techniques. See how ray tracing can provide greater realism in 3D scenes through improved shading, soft shadows, and global illumination. Understand how MPS accelerates ray-triangle intersections while enabling dynamic scene updates, and learn how to extend your app across multiple GPUs for even greater performance.

## Info
* Graphics and Games
* WWDC 2018 - Session 606 - iOS, macOS
* https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/

## Text
 [[ Music ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=7) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=17) [&gt;&gt; Hi, everybody.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=23) [My name is Sean James and I'm a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=25) [GPU Software Engineer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=26) [Today, I'm going to talk about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=28) [Ray Tracing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=30) [So, you may have seen our Ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=31) [Tracing demo in the State of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=32) [Union and want to learn more.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=33) [Or you may be interested in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=36) [using Ray Tracing in your own](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=37) [apps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=38) [Today, I'll talk about how you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=40) [can use Ray Tracing in your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=41) [applications and how you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=43) [accelerate it on the GPU using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=44) [METAL.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=47) [Specifically, using METAL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=48) [Performance Shaders.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=50) [METAL Performance Shaders is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=51) [collection of GPU Compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=53) [Primitives optimized for all of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=55) [our iOS and macOS devices.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=57) [MPS includes support for image](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=60) [processing, linear algebra, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=62) [machine learning.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=64) [We've talk extensively about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=66) [these topics in previous](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=68) [sessions.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=69) [This year, we've also added](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=71) [support for training.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=72) [And there's an entire session](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=74) [about this topic tomorrow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=76) [For today, I'll talk about the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=77) [new support we've added this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=79) [year for Ray Tracing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=81) [So first, what is Ray Tracing?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=83) [Ray Tracing applications are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=87) [based on following the paths](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=89) [that Rays take as they interact](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=90) [with the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=92) [Rays can model light, sound, or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=94) [other forms of energy.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=96) [So, Ray Tracing has applications](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=98) [in rendering, audio, and physics](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=100) [simulation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=103) [But rays can, also, represent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=104) [more abstract concepts, like](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=106) [whether or not one point is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=108) [visible from another.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=109) [So, Ray Tracing also has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=111) [applications in collision](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=112) [detection, artificial](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=113) [intelligence, and pathfinding.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=114) [For today, though, I'll focus on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=117) [rendering as an example of how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=119) [rendering as an example of how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=119) [you can use Ray Tracing in your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=121) [applications.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=122) [So, you may be familiar with the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=124) [rasterization pipeline.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=126) [The rasterizer works by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=128) [projecting one triangle at a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=129) [time onto the screen and shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=131) [the corresponding pixels.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=133) [This can be implemented very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=135) [quickly in GPU hardware, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=136) [makes this the method of choice](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=139) [for games and other real time](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=140) [applications.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=141) [But the rasterization model](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=143) [makes it difficult to simulate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=145) [certain physical behaviors of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=147) [light.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=148) [One example is reflections.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=150) [With the rasterizer, reflections](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=153) [are, typically, implemented](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=154) [using approximations, such as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=155) [cube maps and screen space](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=157) [reflections.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=158) [But with the Ray Tracer we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=160) [compute accurate reflections,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=161) [directly.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=163) [Another example is shadows.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=165) [With the rasterizer, shadows are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=168) [typically implemented using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=169) [shadow maps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=171) [But these can be tricky to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=172) [implement without suffering from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=173) [aliasing and resolution issues.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=175) [Furthermore, soft shadow mapping](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=177) [techniques tend to produce](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=179) [techniques tend to produce](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=179) [uniformly soft shadows.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=180) [With the Ray Tracer we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=183) [directly compute whether or not](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=185) [a point if in shadow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=186) [So, we can produce clean](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=188) [shadows, including realistic](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=189) [transitions from hard to soft](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=191) [shadows as the distance between](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=193) [objects increases.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=194) [One final example is global](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=196) [elimination.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=199) [This simulates light bouncing of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=202) [off surfaces in the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=203) [Global elimination can be very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=205) [difficult to model with the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=207) [rasterizer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=208) [But it's actually modeled quite](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=209) [naturally with the Ray Tracer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=210) [In fact, many games and real](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=213) [time applications that include a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=214) [global elimination component,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=216) [actually, precompute it using a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=218) [Ray Tracer and store the result](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=219) [into textures.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=221) [Which are then mapped back onto](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=222) [the geometry at run time.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=223) [Of course, there are many other](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=225) [effects that we can simulate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=228) [with the Ray Tracer, such as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=229) [ambient occlusion, refraction,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=231) [and area light sources.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=233) [As well as camera effects, such](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=234) [as depth of field and motion](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=236) [blur.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=237) [This makes Ray Tracing the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=239) [This makes Ray Tracing the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=239) [method of choice for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=240) [photorealistic offline rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=241) [applications.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=243) [The tradeoff is that Ray Tracing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=245) [is significantly more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=247) [computationally expensive than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=248) [rasterization because we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=249) [doing so much more work to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=251) [simulate these effects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=252) [So, let's first take a closer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=254) [look at how rendering works with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=256) [the Ray Tracer, and then we'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=257) [see how we can accelerate is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=258) [with METAL.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=260) [So, we use an algorithm called](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=261) [Path Tracing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=264) [In the real world, photons are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=266) [emitted from light sources and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=267) [they bounce around until they](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=269) [enter the camera or your eye.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=270) [But most of those photons](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=273) [actually never make it to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=275) [camera.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=276) [So, this would be very](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=277) [inefficient to simulate.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=278) [Fortunately, due to properties](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=279) [of light we can, actually, work](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=282) [backwards, starting from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=284) [camera.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=285) [We start by casting primary rays](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=287) [from the camera into the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=289) [We then compute shading at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=293) [intersection points.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=294) [Shading consists of figuring out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=296) [how much light is arriving at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=298) [the shading point and what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=299) [the shading point and what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=299) [fraction of that light is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=301) [reflected back towards the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=302) [camera.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=304) [There are, actually, two sources](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=305) [of light, which we'll handle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=306) [separately.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=308) [The first source is direct](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=310) [light.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=312) [This is light that arrives](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=313) [directly at the shading point](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=314) [from the light source.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=315) [We can easily compute how much](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=318) [light is arriving directly and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=319) [what fraction of that light is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=321) [reflected back towards the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=322) [camera.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=323) [All we need to do is check that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=325) [the shading point is not,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=326) [actually, in shadow, before](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=327) [adding the lighting to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=329) [image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=330) [To do this, we can cast](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=332) [additional shadow rays from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=334) [shading point towards the light](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=335) [source.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=337) [If the shadow ray doesn't make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=338) [it all the way to the light](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=340) [source, then the original](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=341) [shading point was in shadow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=342) [So, we shouldn't add the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=344) [lighting to the image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=345) [The other source of light is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=348) [indirect light.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=350) [This is light that bounces off](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=352) [of other surfaces in the scene](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=353) [before reaching the shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=355) [point.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=356) [To collect indirect light, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=357) [can cast secondary rays in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=359) [can cast secondary rays in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=359) [random directions from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=361) [shading point.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=362) [We then, repeat the shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=364) [process at the secondary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=365) [intersection points.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=367) [We'll first compute how much](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=369) [light is arriving directly at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=371) [the second intersection point](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=373) [and what fraction of that light](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=375) [is reflected back towards the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=376) [previous intersection point.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=377) [And, ultimately, back into the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=379) [camera.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=381) [We'll also need to cast another](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=382) [shadow ray from the secondary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=384) [intersection point.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=385) [And we can repeat this process](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=386) [however many times we'd like to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=390) [simulate light bouncing around](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=391) [the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=394) [Now, in order to get these nice](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=397) [soft shadow and bounced lighting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=398) [effects we, actually, need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=399) [cast many shadow and secondary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=401) [rays per point along the path.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=403) [This means that the number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=406) [rays, actually, grows](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=407) [exponentially with the number of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=408) [bounces.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=410) [To avoid this exponential growth](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=411) [we'll, instead, choose just one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=414) [shadow ray and one secondary ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=415) [direction at each bounce.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=417) [This will result in a noisy](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=420) [image but we can average the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=421) [results together over multiple](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=423) [frames.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=424) [Each frame will, also, generate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=426) [its own set of primary rays, so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=427) [this, also, gives us the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=429) [opportunity to implement camera](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=430) [effects such as depth of field](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=432) [and motion blur.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=433) [So, let's translate this all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=434) [into a diagram.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=437) [First, we'll generate primary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=439) [rays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=441) [Then, we'll find the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=442) [intersections with the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=443) [Then, we'll compute shading at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=445) [the intersection points.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=447) [And remember, that this is an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=448) [iterative process, which will](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=450) [generate additional shadow and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=451) [secondary rays, which will be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=453) [intersected with the scene,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=454) [again.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=455) [And finally, we'll write the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=456) [shaded color into our image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=457) [So, this is describing a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=460) [rendering application.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=462) [But a significant fraction of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=463) [the time is, actually, spent on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=464) [ray triangle intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=466) [testing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=467) [This means that the performance](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=469) [of the intersector has a huge](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=470) [impact on the overall rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=472) [performance, even though, it has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=473) [nothing to do with the actual](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=475) [lighting and shading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=476) [This core intersection problem](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=478) [This core intersection problem](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=478) [is, also, common to all Ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=480) [Tracing applications.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=481) [So, we decided to solve this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=484) [core intersection problem for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=486) [you, so that you can start with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=487) [a high performance intersector](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=489) [and just focus on the details of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=491) [you app.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=492) [So, this year, we're introducing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=494) [the MPSRayIntersector API.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=496) [This is an API which accelerates](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=499) [ray triangle intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=501) [testing on the GPU on all of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=502) [macOS and iOS devices.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=505) [We wanted to make it easy to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=508) [integrate his into existing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=509) [apps, so we simply take in rays](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=510) [through a METAL buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=512) [MPS will find the closest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=514) [intersection along each ray and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=515) [return the results in another](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=518) [METAL buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=519) [All you need to do is provide a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=520) [METAL command buffer at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=522) [point in your application where](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=524) [you'd like to perform](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=525) [intersection testing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=526) [And we'll encode all of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=527) [intersection work into the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=529) [command buffer for you.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=530) [So, let's take a closer look at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=532) [the problem that we're trying to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=533) [solve.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=534) [Oh. Okay. So, 3D models are,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=535) [Oh. Okay. So, 3D models are,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=535) [usually, represented as arrays](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=542) [of triangles.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=544) [What we need to do is search](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=545) [through those triangles and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=547) [figure out which ones intersect](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=549) [each ray.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=550) [And furthermore, we need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=551) [figure out which intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=553) [point is closest to the ray's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=555) [origin.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=556) [And the simplest way to do this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=557) [would be to just loop through](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=560) [all the triangles and check for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=562) [intersection with the ray.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=563) [But for anything but the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=565) [smallest scenes, this would be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=566) [far too slow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=567) [So instead, we built a data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=569) [structure that we call an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=571) [Acceleration Structure.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=572) [The acceleration structure works](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=574) [by recursively dividing the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=576) [scene into groups of triangles](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=577) [that are located nearby in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=579) [space.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=580) [When you want to intersect a ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=582) [with a scene, we intersect the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=583) [ray with the bounding boxes in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=585) [the tree.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=587) [If a ray misses a bounding box,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=588) [then we can skip the entire](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=590) [subtree.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=591) [In the end, we're left with just](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=593) [a fraction of the triangles that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=594) [we actually need to check for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=595) [intersection with the ray.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=596) [So, this is the main way that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=598) [So, this is the main way that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=598) [speed up ray triangle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=600) [intersection.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=601) [Of course, this is a simplified](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=603) [example.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=604) [In a real scene the acceleration](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=606) [structure can be quite a bit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=607) [more complicated.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=608) [We can see from this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=609) [visualization that the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=612) [acceleration structure is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=613) [adapting to the complexity of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=614) [the geometry.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=616) [This means that we spend most of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=617) [our time searching for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=619) [intersections only in areas of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=620) [high geometric complexity, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=622) [is what we want.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=624) [Now, I'm describing this to give](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=626) [you an intuition for what the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=627) [acceleration structure is and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=629) [how it works.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=631) [But you, actually, don't need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=632) [worry about this, too much,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=633) [because MPS will take care of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=635) [all of this for you.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=636) [Remember that we'll model our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=636) [scene using triangles.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=639) [And those triangles will](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=641) [themselves be represented by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=642) [vertices in a vertex buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=643) [All you need to do is call MPS](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=646) [to build an acceleration](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=648) [structure from your vertex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=650) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=651) [When you're ready to search for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=652) [intersections, you simply](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=654) [provide this acceleration](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=655) [structure back to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=656) [intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=657) [So, let's see how we can use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=659) [So, let's see how we can use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=659) [this to build a real](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=660) [application.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=661) [We'll break this app into three](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=663) [stages.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=664) [First, we'll generate primary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=665) [rays, find the intersections](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=667) [with the scene, and compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=669) [shading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=670) [This will be equivalent to what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=671) [we could have done with the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=673) [rasterizer, but we'll take it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=673) [further in the next steps.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=675) [So next, we'll add shadows.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=677) [MPS has special support for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=680) [shadow rays, which can make this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=681) [application even faster.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=683) [And finally, we'll simulate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=684) [light bouncing around the scene](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=687) [using secondary rays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=689) [This would be very difficult to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=691) [do with the rasterizer, but](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=692) [we'll see that it's, actually, a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=693) [straightforward extension with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=694) [Ray Tracing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=696) [So, let's start with primary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=697) [rays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=701) [There are five things that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=701) [need to do.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=702) [First, we'll create a ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=704) [triangle intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=705) [Then, we'll create an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=708) [acceleration structure from our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=709) [vertex buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=710) [Next, we'll generate primary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=711) [rays and write them into our ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=714) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=716) [We'll then, find the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=718) [intersections between those rays](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=719) [intersections between those rays](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=719) [and the scene, using the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=721) [intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=722) [And finally, we'll use the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=723) [intersection results to compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=725) [shading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=727) [So, let's start with the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=728) [intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=729) [The MPSRayIntersector class](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=731) [coordinates all of the ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=734) [triangle intersection testing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=735) [All we need to do to create one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=738) [is provide the METAL device that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=739) [we want to use for intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=741) [testing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=742) [Next, we'll create the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=743) [acceleration structure.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=746) [This is represented by the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=748) [MPSTriangleAccelerationStructure](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=750) [class.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=751) [Again, all we need to do to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=753) [create one is provide the same](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=754) [METAL device we used to create](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=755) [the intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=757) [We then, attach our vertexBuffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=758) [and specify the triangleCount.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=761) [And finally, we build the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=763) [acceleration structure.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=765) [We only need to do this once.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=767) [And then, we can reuse the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=768) [acceleration structure as many](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=770) [times as we'd like.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=771) [So next, we'll generate primary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=776) [rays and write them into our ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=777) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=779) [To do this, we'll launch a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=781) [two-dimensional compute kernel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=782) [with one thread per pixel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=784) [Each thread will write this ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=786) [struct into the ray buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=788) [We can think about our output](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=790) [image as floating on a plane in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=792) [front of the camera.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=794) [Primary rays are emitted from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=797) [the camera, so we'll simply set](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=798) [the origin to the camera](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=800) [position.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=801) [To compute the direction, we'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=802) [find the direction from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=804) [camera position through the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=805) [corresponding pixel on the image](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=807) [plan.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=808) [Now that we have our primary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=809) [rays, we'll use the intersector](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=813) [to find the intersections of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=815) [scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=816) [The encodeIntersection call will](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=817) [tie together everything we've](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=820) [created, so far.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=821) [First, remember that we'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=823) [encode into a METAL command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=824) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=826) [We, actually, have a couple of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=827) [options for what type of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=828) [intersection search we'd like to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=829) [do.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=831) [In this case, we'll just use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=832) [nearest, which will find the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=833) [closest intersection along each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=834) [ray.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=835) [We'll then, provide the ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=836) [buffer, which contains the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=839) [buffer, which contains the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=839) [primary rays we just created, as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=840) [well as an intersection buffer,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=843) [which will contain the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=844) [intersection results.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=845) [We, also, need to provide the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=847) [rayCount, which in this case, is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=848) [just the image width times the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=850) [image height.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=851) [And finally, we'll provide our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=852) [accelerationStructure.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=855) [MPS will find the closest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=857) [intersection along each ray and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=858) [return the results in the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=860) [intersection buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=861) [So, all that's left is to use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=863) [the intersection data to compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=864) [shading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=866) [To do this, we'll launch another](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=867) [compute kernel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=869) [We can apply lighting and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=871) [textures similar to the way that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=872) [we would in a fragment shader.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=874) [Most of the standard texture and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=876) [math functions that are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=877) [available in a fragment shader](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=878) [are, also, available in a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=880) [compute kernel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=881) [But shading, typically, depends](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=883) [on both the intersection point](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=885) [and vertex attributes, such as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=886) [colors and normals.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=888) [In a fragment shader the GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=890) [would interpolate these for us.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=892) [But we'll need to interpolate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=893) [them ourselves based on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=894) [intersection data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=896) [So, let's first look at how we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=898) [can compute the intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=899) [can compute the intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=899) [point.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=901) [Remember that a ray is defined](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=901) [by its origin and direction.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=904) [This is the intersection struct](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=907) [returned to us by the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=911) [intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=912) [The distance field will tell us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=913) [how far we would need to go in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=915) [the ray direction to get from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=916) [the ray origin to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=918) [intersection point.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=919) [And this distance will be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=920) [negative if the ray doesn't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=921) [intersect anything.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=923) [The primitiveIndex tells us](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=925) [which triangle we hit.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=928) [And the last field is what we'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=929) [use to interpolate vertex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=931) [attributes.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=932) [This field contains the first](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=934) [barycentric coordinates called U](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=936) [and V.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=938) [And these correspond to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=939) [location of the intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=940) [point relative to the vertices](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=941) [of the triangle.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=943) [There are, actually, three](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=945) [barycentric coordinates, but](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=946) [they add up to one.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=947) [So, we can compute the third](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=949) [coordinate W by subtracting the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=950) [first two from one.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=952) [If we have a vertex attribute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=955) [defined at each vertex of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=956) [triangle, then the interpolated](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=958) [triangle, then the interpolated](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=958) [vertex attribute is just the sum](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=960) [of the attributes at each vertex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=963) [weighted by the barycentric](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=965) [coordinates.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=966) [For example, if we have a color](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=967) [defined at each vertex, then the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=969) [interpolated color is just the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=971) [weighted sum of the colors at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=973) [each vertex.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=974) [So, at this point we've created](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=975) [a ray intersector and an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=979) [acceleration structure.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=981) [We then, generated primary rays](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=983) [and found the intersections with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=985) [the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=986) [We computed shading at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=988) [intersection points, and then](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=989) [wrote the shaded color into our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=990) [image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=992) [So, let's take a look at the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=993) [image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=993) [We can see the geometry](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=994) [represented by the acceleration](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=997) [structure, as well as the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=998) [interpolated vertex colors and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=999) [lighting we just computed.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1001) [Now that we have an image on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1003) [screen we're ready to add some](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1004) [additional effects.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1006) [So, we'll start by adding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1008) [shadows to our image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1009) [To do this, we need to check if](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1011) [the light can actually reach the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1015) [shading point before adding it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1017) [to the image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1019) [To do this we can cast](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1020) [additional shadow rays from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1022) [intersection points towards the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1024) [light source.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1025) [If a shadow ray doesn't make it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1027) [all the way to the light source,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1028) [then the original shaded point](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1030) [wasn't shadow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1031) [So, we shouldn't add its color](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1032) [to the image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1033) [We'll modify our shading kernel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1037) [to write out additional shadow](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1039) [rays into another METAL buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1041) [We'll then, find the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1044) [intersections with the scene,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1045) [again.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1046) [And then, we'll launch one final](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1047) [kernel which will conditionally](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1049) [write the shaded color into the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1050) [image based on whether or not](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1052) [the shadow rays intersect at](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1054) [anything.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1055) [So, let's start with the changes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1056) [to the shading kernel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1058) [Now, shadow rays are a little](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1059) [different than primary rays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1062) [First, we need to provide a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1063) [maximum intersection distance so](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1065) [that our shadow rays don't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1068) [overshoot the light source.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1069) [We also don't need to know which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1070) [triangle we hit or what the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1074) [barycentric coordinates were.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1075) [So, there are some optimizations](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1077) [we can do.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1078) [And finally, remember that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1078) [And finally, remember that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1078) [can't write the shaded color](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1081) [into the image until we know](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1083) [whether or not the original](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1084) [shading point was in shadow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1085) [So, we need a way to pass the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1087) [color from the shading kernel](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1089) [through the intersector, all the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1091) [way into the final kernel, which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1092) [will update the image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1094) [To do this, we can customize our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1096) [ray struct.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1097) [So, first we have several](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1100) [options for what data we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1103) [actually provide to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1104) [intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1105) [In this case, we'll use a data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1107) [type which includes minimum and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1108) [maximum distance fields.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1110) [MPS will ignore any](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1112) [intersections outside of this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1113) [range, which will prevent our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1114) [shadow rays from overshooting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1116) [the light source.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1117) [Second, if you have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1120) [application-specific data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1121) [associated with your rays you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1123) [can append that data at the end](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1125) [of the ray struct and provide a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1126) [rayStride.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1127) [MPS will skip past this data](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1129) [when reading from your ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1131) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1132) [In this case, we'll add the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1133) [shade of color to the end of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1135) [ray, so that we can propagate it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1136) [from the shading kernel through](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1138) [to the final kernel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1139) [to the final kernel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1139) [We configure these options on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1140) [the ray intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1143) [First, we'll set the rayDataType](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1144) [to match our struct type.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1147) [Then, we'll set a rayStride to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1150) [skip past the color at the end](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1152) [of the struct.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1153) [Next, we'll run the shadow rays](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1156) [through the intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1157) [This was our original call to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1159) [the intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1162) [Remember that shadow rays are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1163) [only checking for visibility](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1164) [between the original shading](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1166) [point and the light source.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1167) [So, there are two optimizations](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1168) [we can do.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1170) [First, just like we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1171) [customize the rayDataType, we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1172) [can also customize the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1175) [intersection data type or what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1176) [data is returned to us by the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1178) [intersector.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1179) [In this case, we only need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1181) [know if the distance is positive](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1183) [or negative, indicating a hit or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1184) [a miss.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1186) [So, we can set the intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1187) [data type to just distance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1188) [This will save some memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1190) [bandwidth reading from and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1191) [writing to the intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1193) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1194) [Second, because we don't,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1195) [actually, need to know which](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1198) [triangle we hit, we can end the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1199) [triangle we hit, we can end the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1199) [intersection search as soon as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1201) [we hit any triangle.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1203) [This is, typically, much faster](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1204) [than searching for the closest](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1206) [intersection.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1207) [MPS has a special mode for this,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1209) [which we can turn on by passing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1211) [the any intersectionType instead](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1212) [of nearest.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1215) [Finally, we can launch our last](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1218) [kernel, which will add the color](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1219) [to the image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1221) [Each thread will read in one](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1224) [shadow ray and the corresponding](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1225) [intersection data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1227) [If the intersection distance was](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1229) [positive, then the original](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1231) [intersection point was in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1233) [shadow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1234) [So, there's nothing more to do.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1235) [Otherwise, the intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1237) [point wasn't in shadow.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1238) [So, we should read in the ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1240) [color and write it into the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1242) [output image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1243) [And that's all we need to do to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1245) [add shadows to our image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1246) [We can see that each shaded](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1248) [point is now checking whether or](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1252) [not the light source is visible](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1253) [before adding the lighting to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1254) [the image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1256) [Because we're using a ray tracer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1257) [we can, also, randomly sample](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1259) [we can, also, randomly sample](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1259) [the surface of the light source,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1261) [which gives us these nice soft](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1262) [shadows.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1263) [So last, we'll look at secondary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1266) [rays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1269) [Remember that secondary rays](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1270) [simulate light bouncing around](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1272) [the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1274) [All we need to do to add](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1275) [secondary rays is move all of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1276) [our kernels into a loop.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1278) [In each iteration we'll choose a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1280) [new random direction to continue](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1281) [they ray's path.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1283) [So, modify the shading kernel to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1289) [produce the rays for the next](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1291) [iteration.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1293) [Once we finish updating our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1295) [image we can simply loop back to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1296) [the first intersection test.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1298) [And we can repeat this loop](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1300) [however many times we want rays](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1301) [to bounce.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1303) [So, let's look at the changes to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1306) [the shading kernel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1308) [In each iteration we'll move the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1311) [ray origin to the intersection](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1313) [point.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1315) [We'll then, choose a random](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1316) [direction to continue the path.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1318) [And finally, we'll multiply the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1321) [ray color by the interpolated](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1323) [vertex color.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1324) [This will cause the light to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1326) [take on the color of whatever](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1327) [surface it bounces off of.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1329) [In a more advanced application,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1331) [this would be a much more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1333) [complicated calculation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1334) [But by choosing the random ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1336) [directions, carefully, we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1337) [actually get the rest of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1339) [math to cancel out.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1340) [And this works even though we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1341) [working backwards from the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1343) [camera as long as we're careful](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1344) [to tint the direct lighting by](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1346) [the ray color at each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1348) [intersection point.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1349) [So, that's all we need to do for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1350) [secondary rays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1352) [So, we can see that light has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1354) [started to bounce off of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1356) [walls and onto the sides of the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1357) [boxes and ceiling.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1359) [So, that's it for our example](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1360) [app.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1363) [We started by getting an image](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1364) [on screen with primary rays and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1366) [shading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1368) [Then, we added shadows.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1369) [And finally, we simulated light](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1371) [bouncing around the scene with](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1373) [secondary rays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1374) [So, let's switch to the demo and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1376) [take a look at this running](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1378) [live.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1379) [So, here's the application we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1384) [just wrote up and running on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1385) [12.9-inch iPad Pro.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1386) [We've, actually, extended this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1389) [application to support more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1390) [advanced lighting, shading,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1392) [textures, and more.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1394) [So, let's switch to a more](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1396) [complicated scene, which used](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1397) [many of these features.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1399) [Here's the Amazon Lumberyard](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1406) [Bistro scene you saw running in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1407) [the State of the Union on four](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1409) [GPUs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1411) [The scene has almost one million](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1412) [triangles.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1414) [But, even with these advanced](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1415) [lighting and shading techniques](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1416) [we're still able to achieve](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1418) [almost 20 million rays per](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1419) [second on an iPad Pro.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1420) [And that's a combined](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1422) [measurement including primary,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1423) [shadow, and secondary rays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1425) [So, we've created what we think](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1428) [is an easy to use API that you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1429) [can use to start implementing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1431) [these types of applications](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1433) [today.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1434) [So, that's if for our demo, for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1436) [now.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1437) [Thank you.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1438) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1440) [So, don't worry if you didn't](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1443) [catch all of that because this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1444) [application will be available](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1445) [for download as a sample.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1447) [The sample demonstrates](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1449) [everything I've talked about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1450) [today and more.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1451) [We recommend that you get](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1452) [started by downloading the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1453) [sample and adding your own](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1454) [geometry, lighting, shading, and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1456) [so on.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1458) [There's, also, a lot more to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1459) [API that I didn't have time to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1460) [talk about, today.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1462) [So, we, also, recommend that you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1463) [take a look at the documentation](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1464) [and headers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1466) [And with that, I'll hand it off](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1467) [to my colleague, Wayne, who will](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1469) [talk about how we can extend](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1470) [this to multiple GPUs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1472) [Thank you.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1475) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1476) [&gt;&gt; Thanks, Sean.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1482) [Hi, everyone.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1483) [So, say you're working on your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1488) [Mac.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1489) [It has an internal GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1490) [But you've, also, plugged in a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1492) [couple or really high](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1493) [performance eGPUs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1494) [And what we'd like to be able to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1496) [do is use all of these GPUs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1498) [do is use all of these GPUs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1498) [together to make Ray Tracing go](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1500) [as fast as we possibly can.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1502) [So, how are we going to do this?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1505) [Well, there's three things we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1506) [need to think about.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1508) [First of all, how are we going](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1510) [to divide up the work between](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1511) [GPUs?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1515) [Secondly, at some point the GPUs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1515) [are going to need a way to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1518) [exchange data.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1519) [So, how are we going to deal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1520) [with that?](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1522) [And finally, we need a way to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1523) [keep everything synchronized.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1525) [Now, for this, I'll show you how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1527) [to use the new METAL Events](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1528) [feature that we're introducing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1529) [here, this week.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1531) [So, let's get started.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1532) [So, to divide up the work we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1534) [going to use something called](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1536) [Split Frame Rendering.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1537) [The idea here is to partition](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1539) [our frame into regions.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1541) [And then, we'll assign each of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1543) [these regions to a different](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1544) [GPU, so that they can be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1545) [rendered in parallel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1547) [Now, each GPU will run the full](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1549) [rendering pipeline that Sean](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1551) [described earlier.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1552) [So, that's everything from](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1554) [initial ray generation right](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1555) [through to shadow rays and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1557) [shading.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1558) [Now, once all GPUs have finished](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1560) [we'll pick whichever one is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1562) [connected to the display and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1563) [we'll copy across all of our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1566) [completed regions for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1567) [composition.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1568) [Now, composition could just be](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1569) [stitching the regions together](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1572) [into one frame buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1573) [Or you might want to combine](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1576) [them with the results of a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1577) [previous render to refine the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1578) [image and remove noise.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1580) [Now, before we can render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1581) [anything, we need to make sure](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1584) [that each GPU has a complete](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1586) [copy of the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1587) [Assets, such as your vertex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1590) [buffers and your textures need](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1591) [to be replicated on all GPUs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1593) [And so, do the triangle](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1596) [acceleration structures that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1597) [Sean introduced earlier.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1598) [Now, for the acceleration](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1602) [structures, we really wanted to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1604) [avoid you having to build them](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1605) [from scratch for each GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1607) [So, we added an API that enables](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1609) [you to take an existing](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1611) [acceleration structure and make](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1612) [a copy for each GPU that you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1614) [want to use.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1616) [Now, this copy is nonrecursive.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1618) [Now, this copy is nonrecursive.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1618) [So, any buffers that you have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1621) [attached to your acceleration](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1622) [structure, for example, your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1623) [vertex and your index buffers,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1624) [you'll need to copy those](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1627) [separately.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1628) [And then, attach them to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1629) [acceleration structure that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1630) [just created.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1631) [So, now that the data is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1632) [replicated on all GPUs we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1637) [ready to start rendering.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1639) [Now, the interesting thing for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1641) [our multi-GPU perspective is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1643) [that this part of the pipeline](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1645) [is virtually unchanged from what](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1646) [Sean described earlier.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1648) [The only difference we need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1650) [make for multi-GPU is to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1651) [restrict regeneration to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1653) [whichever part of the screen a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1654) [particular GPU is working on.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1656) [Everything else is the same.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1658) [So, for that reason, let's move](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1660) [straight on to what's, probably,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1662) [the trickiest stage for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1664) [multi-GPU, and that's its final](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1665) [composition phase here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1667) [Now, for best performance on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1671) [macOS, each GPU will render into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1673) [its own private buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1675) [And once rendering has finished](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1677) [we need to copy that buffer over](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1679) [we need to copy that buffer over](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1679) [to whichever GPU we're using for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1681) [composition.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1683) [Now, we can't copy between the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1684) [buffers, directly, because METAL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1686) [resources can only be used on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1687) [the device that they were](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1689) [created on.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1690) [So, you can't create a buffer on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1691) [one GPU, and then try and attach](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1692) [it to a Blit encoder on a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1694) [different GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1695) [That's just not going to work.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1696) [So, this means that our copies](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1698) [will need to go through system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1699) [memory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1700) [Now, to make this as efficient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1701) [as we can, we use the buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1704) [arrangement that you see here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1706) [We're going to create two METAL](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1708) [buffers; one on each device that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1710) [wrap a common CPU allocation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1712) [And as the buffers wrap the same](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1715) [underlying memory anything that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1717) [is written into the METAL buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1719) [on device A is, also, visible to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1720) [the METAL buffer on device B.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1723) [Now, as I mentioned earlier, for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1725) [performance reasons on macOS all](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1729) [of the actual rendering work is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1731) [done using private buffers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1732) [And then, we Blit our completed](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1735) [regions through system memory](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1736) [when it's time to copy them to a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1738) [different GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1739) [different GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1739) [So, here's a quick look at how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1740) [to set this up.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1743) [First, we create our buffer on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1744) [device A, using METAL shared](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1746) [storage mode.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1747) [And this allocates system](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1748) [memory, internally.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1751) [And we can get appointed to it](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1751) [using the .contents method.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1753) [We, then create a buffer on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1755) [device B using the NoCopy API to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1759) [wrap the memory that we just](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1762) [allocated to buffer A.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1763) [Now, something to be aware of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1766) [for this API is that the buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1768) [needs to be a multiple of page](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1770) [size.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1771) [So, you'll need to pad the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1771) [length when you create the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1773) [original buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1774) [So, now that we're able to share](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1775) [memory between devices we need](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1779) [to think about synchronization.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1781) [Now, to help with this we have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1783) [an example timeline here to help](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1785) [us visualize two GPUs running in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1786) [parallel.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1788) [The dark boxes represent command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1789) [buffers and the green boxes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1791) [represent work that we've](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1793) [encoded into those command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1794) [buffers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1795) [For example, using a compute](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1796) [command encoder.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1797) [So, the GPU at the top there, is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1799) [So, the GPU at the top there, is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1799) [going to do some rendering.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1801) [And when it's finished, it'll](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1803) [Blit its completed region into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1805) [the shared buffers that we were](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1806) [just talking about.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1807) [Now, while that's going on GPU B](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1809) [is, also, doing some rendering.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1812) [Now, this is the GPU that we're](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1815) [going to use for composition.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1816) [So, at some point it's going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1818) [need the buffer that was](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1819) [produced by GPU A.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1820) [Now, we can see here that we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1821) [have a problem.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1823) [There's no synchronization in](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1825) [this area, here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1827) [So, there's nothing to prevent](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1828) [GPU B from trying to read the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1830) [buffer before GPU A has finished](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1831) [writing to it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1833) [Now, to deal with this we can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1835) [use METAL Events.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1837) [With METAL Events, we'll insert](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1839) [a wait into the command buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1840) [So, while the GPU is executing,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1843) [it'll reach the wait, and then](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1844) [it's just going to stop.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1846) [And what it's waiting for is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1847) [signal from the other GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1850) [Once that signal is received we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1851) [know that GPU A has finished](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1855) [writing to the buffer and it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1856) [now safe for GPU B to access it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1858) [now safe for GPU B to access it.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1858) [So, this is an elegant way to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1861) [fix our synchronization problem.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1864) [But, clearly, having a GPU,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1866) [potentially, a very powerful GPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1868) [just sitting there waiting is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1870) [not good.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1872) [So, we need to make this wait as](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1873) [short as possible and, ideally,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1875) [we want the GPU working instead](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1877) [of waiting.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1878) [So, what I'm talking about,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1879) [here, is load balancing.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1881) [So currently, we just split the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1883) [screen equally between GPUs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1885) [And there's a couple of problems](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1887) [with this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1889) [Firstly, it doesn't take into](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1890) [account that you might be using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1891) [GPUs of different performance.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1893) [If one GPU is much faster than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1895) [the other, then it stands to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1897) [reason that, yeah, it's going to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1898) [finish first.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1899) [And the other problem is that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1901) [some parts of the screen are](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1903) [more complicated to render than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1904) [others.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1905) [They take longer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1906) [They might have more complex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1907) [geometry or more complex](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1908) [materials.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1910) [So, to fix this, we need to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1912) [adjust our region sizes](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1913) [adaptively.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1915) [Now, the aim here is for each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1916) [GPU to take, approximately, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1918) [GPU to take, approximately, the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1918) [same amount of time to render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1920) [its part of the scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1921) [Now, the way we do this is we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1924) [start with the fixed partitions](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1925) [that you see here, and we render](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1927) [a frame.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1929) [And we time how long each GPU is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1929) [working for.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1932) [And then, we use that to decide](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1932) [how big a region to give each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1934) [GPU the next time around.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1936) [And we do this the whole time](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1937) [your application is running.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1941) [So, it constantly adapts to the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1943) [performance of the GPUs that you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1944) [have connected.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1946) [And wherever you are and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1947) [wherever you're looking in your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1948) [scene.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1949) [So, to measure how hard a GPU is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1950) [working, we use command buffer](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1954) [completion handlers.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1956) [Now, completion handler is a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1958) [block of CPU code that you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1960) [have run after the GPU has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1962) [finished executing your command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1963) [buffer.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1964) [Now, on iOS command buffers have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1966) [a couple of useful properties](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1969) [that you can read to find out](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1970) [how long it took to run on the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1972) [GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1973) [But these aren't available on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1975) [macOS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1976) [So, we need to come up with an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1977) [approximation.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1978) [And the way we do this is we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1979) [And the way we do this is we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1979) [store the host time when each](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1982) [command buffer completion](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1983) [handler was called.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1984) [And if you do this for every](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1985) [command buffer, you can then use](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1987) [the differences between these](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1989) [times to figure out how long the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1990) [GPU was running for.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1991) [So, for example, to estimate how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1993) [long the three command buffers](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1995) [shown here took execute, we've](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1997) [measured the time between the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=1999) [completion handler was called](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2000) [for command buffer 3 and command](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2001) [buffer 0.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2003) [So, that's the theory.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2005) [And now, let's see it in action.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2008) [All right.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2022) [So, this is the Amazon](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2022) [Lumberyard Bistro scene that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2023) [Sean was showing you earlier.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2024) [And this time, it's running on a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2027) [MacBook Pro.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2028) [And you can see in the top left](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2029) [of the screen here, we have a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2032) [rays per second metric.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2033) [As you can get an idea for how](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2034) [it's running.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2036) [So, this includes the primary](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2037) [rays, secondary rays, and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2039) [rays, secondary rays, and the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2039) [shadow rays.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2041) [They're all included in this](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2041) [metric.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2042) [So, you can see, we're getting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2043) [about 30 million rays per](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2045) [second.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2046) [And it'd be nice if we were](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2047) [going a little faster.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2049) [So, I'm going to enable one of](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2050) [the eGPUs that I have connected,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2052) [here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2053) [So, you can see from the text](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2053) [there, we're now running on an](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2058) [RX 580, as well as the internal](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2059) [GPU, here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2061) [And performance has doubled to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2062) [about 60 million rays per](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2064) [second.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2065) [And you can also see the green](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2066) [lines here that we're using to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2067) [help visualize how the load is](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2069) [split between GPUs.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2070) [So, one GPU is rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2072) [everything above the line.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2073) [And one GPU is rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2075) [everything below.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2076) [So, with the eGPU we're now](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2077) [going about twice as fast as we](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2079) [were before.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2081) [I was kind of hoping for a bit](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2082) [more, there.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2084) [And so, the problem is the eGPU](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2085) [is sitting there waiting.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2087) [And that's because we're using](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2090) [these fixed partitions.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2091) [So, if we switch on the adaptive](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2092) [load balancing, here, you see](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2094) [the RX 580 just grabs a big](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2096) [chunk of the work, now.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2098) [And we're going much faster than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2099) [And we're going much faster than](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2099) [we were, previously.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2100) [So, the scene here has](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2103) [approximately one million](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2105) [triangles.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2106) [And we're now going to switch to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2107) [an outside view.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2109) [It's the same Amazon Lumberyard](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2109) [scene but we're outside, now.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2111) [And this scene has approximately](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2113) [3 million triangles.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2114) [And I have another GPU sitting](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2117) [here.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2119) [So, we'll turn that one on, too.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2119) [And, this time, it's a Vega 64.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2121) [So, you see the Vega grabbing a](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2124) [big chunk of the work, there.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2126) [And what's interesting about](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2128) [this configuration is we have](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2130) [three very different GPUs](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2131) [working together.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2132) [They're different architectures](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2133) [and they're very different](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2135) [performance, too.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2136) [But they're all working together](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2137) [to help produce this great](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2138) [image.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2139) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2143) [So, today we introduced the](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2151) [MPSRayIntersector, a new API](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2152) [that you can use to accelerate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2154) [ray triangle intersections on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2156) [the GPU.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2157) [As you saw from my demos, it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2158) [As you saw from my demos, it's](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2158) [available on all of our iOS and](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2161) [macOS platforms.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2163) [And it scales really well as you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2164) [add multiple GPUs on macOS.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2166) [Now, we're really excited to see](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2169) [how you use Ray Tracing in your](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2171) [applications.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2172) [We used Path Tracing in our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2174) [example, today.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2175) [But there's also hybrid](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2177) [rendering.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2178) [You might want to incorporate](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2178) [Ray Tracing to do really nice](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2180) [looking shadows or ambient](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2181) [occlusion or reflections.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2182) [And there's also non-rendering](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2185) [in cases.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2186) [For example, autosimulation,](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2187) [physics, AI collisionless](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2189) [action.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2190) [There's a ton of stuff you can](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2191) [do with this.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2192) [So, to help you get started you](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2194) [can find sample code on](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2198) [developer.apple.com.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2200) [So, be sure to check that out.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2201) [Also, the header files are full](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2203) [of documentation and information](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2205) [on some additional features that](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2207) [we weren't able to cover today.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2208) [And finally, we have our lab](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2211) [session tomorrow from 12.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2212) [Sean and I will be on hand to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2213) [talk more about the API and to](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2215) [help you get started with Ray](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2217) [Tracing in your application.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2218) [Tracing in your application.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2218) [So, we hope you can join us for](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2220) [that.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2222) [So, thank you, for coming to our](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2223) [talk.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2224) [And enjoy the rest of WWDC.](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2224) [[ Applause ]](https://developer.apple.com/videos/wwdc2018/videos/play/wwdc2018/606/?time=2227)